<html xmlns:lxslt="http://xml.apache.org/xslt" xmlns:saxon="http://icl.com/saxon" xmlns:xalanredirect="org.apache.xalan.xslt.extensions.Redirect"><head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>4. The Request Processor</title><link rel="stylesheet" href="ad.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.24"><link rel="home" href="index.html" title="ACS Core"><link rel="up" href="dev-guide.html" title="4. ACS Developer's Guide"><link rel="previous" href="packages.html" title="3. ACS 4 Packages"><link rel="next" href="db-api.html" title="5. The Database Access API"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><a href="http://www.openacs.org/"><img src="images/alex.jpg" border="0"></a><br><br><a class="topnav" href="/">Home</a><span class="topnav"> : </span><a class="topnav" href="index">Documentation</a><span class="topnav"> : </span><a class="topnav" href="acs-dev.html">Part III. For ACS Developers</a><span class="topnav"> : </span><a class="topnav" href="dev-guide.html">4. ACS Developer's Guide</a><span class="topnav"> : </span><strong class="topnav">4. The Request Processor&nbsp;</strong><hr size="1" noshade><div id="request-processor" class="sect1"><div class="titlepage"><h2 class="title" style="clear: all"><a name="request-processor"></a><span class="label">4.</span> <span class="title">The Request Processor</span></h2></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt>4.1. <a href="request-processor.html#rp-overview">Overview</a></dt><dt>4.2. <a href="request-processor.html#rp-theoldway">The Old Way</a></dt><dt>4.3. <a href="request-processor.html#rp-thenewway">The New Way</a></dt><dt>4.4. <a href="request-processor.html#rp-basicapi">Basic API</a></dt></dl></div><p><p>By <a href="mailto:psu@arsdigita.com" target="_top">Pete Su</a></p></p><div id="rp-overview" class="sect2"><div class="titlepage"><h3 class="title"><a name="rp-overview"></a><span class="label">4.1.</span> <span class="title">Overview</span></h3></div><p>
This document is a brief introduction to the ACS 4 Request Processor;
more details can be found in the <a href="rp-design.html">ACS 4 Request Processor Design</a>. Here we cover the high level concepts behind the
system, and implications and usage for the application developer.
</p></div><div id="rp-theoldway" class="sect2"><div class="titlepage"><h3 class="title"><a name="rp-theoldway"></a><span class="label">4.2.</span> <span class="title">The Old Way</span></h3></div><p>
In older versions of the ACS, the mapping between URLs and pages was
simple. AOLserver (the usual webserver for the ACS) would find the
appropriate file by appending the server's page-root to the path in
the URL and returning that file to the user.  For example, a user's
request for a URL like "http://foo-service.com/bar.html" would cause
the server to look in the filesystem for
<tt>/web/foo-service/www/bar.html</tt>, and return that file.
This was simple enough, but ACS did not provide a clean centralized
mechanism for the following requirements of larger web services:


<div class="itemizedlist"><ul><li style="list-style-type: opencircle"><a name="N6109"></a><p>Support for more flexible mappings from URLs to content
    </p></li><li style="list-style-type: opencircle"><a name="N6112"></a><p>Robust user authentication
    </p></li><li style="list-style-type: opencircle"><a name="N6115"></a><p>Page level access control
    </p></li></ul></div>


To achieve this functionality above in ACS 3.x, developers used an ad
hoc combination of AOLserver filters, the <tt>ns_perm</tt> call,
special purpose code in pages, and other procedures.  In ACS 4, the
Request Processor, along with the ACS Package Manager, centralizes and
unifies this functionality, making it more transparent and readily
available to developers.
</p></div><div id="rp-thenewway" class="sect2"><div class="titlepage"><h3 class="title"><a name="rp-thenewway"></a><span class="label">4.3.</span> <span class="title">The New Way</span></h3></div><p>
The 4.0 Request Processor is a global filter and set of Tcl procs that
respond to every incoming URL reaching the server. The following
diagram summarizes the stages of the request processor assuming a URL
request like <tt>http://someserver.com/notes/somepage.adp</tt>.

<div class="mediaobject"><img src="images/rp-flow.gif" align="center"></div>

</p><div class="variablelist"><dl><dt><a name="N6144"></a><span class="term">Stage 1: Search Site Map</span></dt><dd><p>
The first thing the RP does is to map the given URL to the appropriate
physical directory in the filesystem, from which to serve content.  We
do this by searching the site map data model (touched on in the <a href="packages.html">Packages</a>, and further
discussed in <a href="subsites.html">Section 8.</a>). This data model maps URLs to objects representing
content, and these objects are typically package instances. 
</p><p>
After looking up the appropriate object, the RP stores the URL, the ID
of the object it found, and the package and package instance the
object belongs to into the environment of the connection.  This
environment can be queried using the <tt>ad_conn</tt> procedure,
which is described in detail in <a href="rp-design.html">ACS 4 Request Processor Design</a>. The <a href="subsites.html">page
development</a> tutorial shows you how to use this interface to make
your pages aware of which instance was requested.
</p></dd><dt><a name="N6169"></a><span class="term">Stage 2: Authentication</span></dt><dd><p>
Next, the Request Processor examines the request for session
information. Session information is generally sent from the client
(the user's browser) to the server via cookies. The <a href="security-notes.html">security/session handler</a> is described in
detail in its own document. It examines the client request and either
extracts or sets up new session tokens for the user.
</p></dd><dt><a name="N6179"></a><span class="term">Stage 3: Authorization</span></dt><dd><p>
Next, the Request Processor checks if the user has appropriate access
privileges to the requested part of the site. In ACS 4, access control
is dictated by the <a href="permissions" target="_top">permissions system</a>. In
this case, the RP checks if the user has "read" priviledges on the
object in the site map specified by the URL. This object is typically
a package instance, but it could easily be something more granular,
such as whehter the user can view a particular piece of content within
a package instance.  This automatic check makes it easy to set up
sites with areas that are only accessible to specific groups of users.
</p></dd><dt><a name="N6189"></a><span class="term">Stage 4: URL Processing, File Search</span></dt><dd><p>
Finally, the Request Processor finds the file we intend to serve,
searching the filesystem to locate the actual file that corresponds to
an abstract URL.  It searches for files with predefined "magic"
extensions, i.e. files that end with: <tt>.html</tt>,
<tt>.tcl</tt> and <tt>.adp</tt>.  
</p><p>
If the RP can't find any matching files with the expected extensions,
it will look for virtual-url-handler files, or <tt>.vuh</tt>
files. A <tt>.vuh</tt> file will be executed as if it were a Tcl
file, but with the tail end of the URL removed. This allows the code
in the <tt>.vuh</tt> file to act like a registered procedure for
an entire subtree of the URL namespace.  Thus a <tt>.vuh</tt> file
can be thought of as a replacement for filters and registered procs,
except that they integrate cleanly and correctly with the RP's URL
mapping mechanisms.  The details of how to use these files are
described in <a href="rp-design.html">ACS 4 Request Processor Design</a>.
</p><p>
Once the appropriate file is found, it is either served directly if
it's static content, or sent to the template system or the standard
Tcl interpreter if it's a dynamic page.
</p></dd></dl></div></div><div id="rp-basicapi" class="sect2"><div class="titlepage"><h3 class="title"><a name="rp-basicapi"></a><span class="label">4.4.</span> <span class="title">Basic API</span></h3></div><p>
Once the flow of control reaches a dynamic page, the Request Processor
has populated the environment of the request with several pieces of
useful information. The RP's environment is accessible through the
<tt>ad_conn</tt> interface, and the following calls should be
useful to you when developing dynamic pages:
</p><div class="variablelist"><dl><dt><a name="N6241"></a><span class="term"><tt>[ad_conn user_id]</tt>

</span></dt><dd><p>
The ID of the user associated with this request. By convention this is
zero if there is no user.
</p></dd><dt><a name="N6250"></a><span class="term"><tt>[ad_conn session_id]</tt>

</span></dt><dd><p>
The ID of the session associated with this request.
</p></dd><dt><a name="N6259"></a><span class="term"><tt>[ad_conn url]</tt>

</span></dt><dd><p>
The URL associated with the request.
</p></dd><dt><a name="N6268"></a><span class="term"><tt>[ad_conn urlv]</tt>

</span></dt><dd><p>
The URL associated with the request, represented as a list instead of
a single string.
</p></dd><dt><a name="N6277"></a><span class="term"><tt>[ad_conn file]</tt>

</span></dt><dd><p>
The actual local filesystem path of the file that is being served.
</p></dd><dt><a name="N6286"></a><span class="term"><tt>[ad_conn object_url]</tt>

</span></dt><dd><p>
If the URL refers to a site map object, this is the URL to the root
of the tree where the object is mounted.
</p></dd><dt><a name="N6295"></a><span class="term"><tt>[ad_conn package_url]</tt>

</span></dt><dd><p>
If the URL refers to a package instance, this is the URL to the root
of the tree where the package is mounted.
</p></dd><dt><a name="N6304"></a><span class="term"><tt>[ad_conn extra_url]</tt>

</span></dt><dd><p>
If we found the URL in the site map, this is the tail of the URL
following the part that matched a site map entry.
</p></dd><dt><a name="N6313"></a><span class="term"><tt>[ad_conn object_id]</tt>

</span></dt><dd><p>
If the URL refers to a site map object, this is the ID of that object.
</p></dd><dt><a name="N6322"></a><span class="term"><tt>[ad_conn package_id]</tt>

</span></dt><dd><p>
If the URL refers to a package instance, this is the ID of that
package instance.
</p></dd><dt><a name="N6331"></a><span class="term"><tt>[ad_conn package_key]</tt>

</span></dt><dd><p>
If the URL refers to a package instance, this is the unique key name
of the package.
</p></dd></dl></div><p><div align="right" class="cvstag">($Id$)</div></p></div></div><div class="navfooter"><hr size="1" noshade><table width="100%"><tr><td width="40%" align="left"><a class="bottomnav" href="packages.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a href="mailto:acs-docs@arsdigita.com"><address class="nav">acs-docs@arsdigita.com</address></a></td><td width="40%" align="right">&nbsp;<a class="bottomnav" href="db-api.html">Next</a></td></tr></table></div></body></html>
