<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Upgrading</title><meta name="generator" content="DocBook XSL Stylesheets V1.62.0"><link rel="home" href="index.html" title="OpenACS Core Documentation"><link rel="up" href="upgrade.html" title="Chapter 5. Upgrading"><link rel="previous" href="upgrade.html" title="Chapter 5. Upgrading"><link rel="next" href="maintenance.html" title="Chapter 6. Maintenance"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="/doc/images/alex.jpg" border="0" alt="Alex logo"></a><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="upgrade.html">Prev</a> </td><th width="60%" align="center">Chapter 5. Upgrading</th><td width="20%" align="right"> <a accesskey="n" href="maintenance.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="upgrade-detail"></a>Upgrading</h2></div></div><div></div></div><div class="authorblurb"><p>by <a href="mailto:joel@aufrecht.org" target="_top">Joel Aufrecht</a></p>
          OpenACS docs are written by the named authors, and may be edited
          by OpenACS documentation staff.
        </div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="upgrade-overview"></a>Overview</h3></div></div><div></div></div><p>Starting with Version 4.5, all OpenACS core packages support
    automatic upgrade.  That means that, if you have OpenACS 4.5
    or better, you should always be able to upgrade all of your core
    packages automatically.  If you haven't changed anything, no
    manual intervention should be required.  If you are running
    OpenACS prior to 4.5, upgrading will require manual effort.</p><p>It's always a good idea to precede an upgrade attempt with a <a href="backup-recovery.html#snapshot-backup" title="Manual backup and recovery">snapshot backup</a>.</p><p>OpenACS consists of files and a database schema.  The files
    in a new tarball include database upgrade scripts.  To start the
    upgrade, replace your existing files with the new files and then browse to the APM, which will detect the new packages and offer to run the appropriate database upgrade scripts.  After restarting the server again, the upgrade is
    complete.</p><div class="figure"><a name="id2875459"></a><p class="title"><b>Figure 5.1. Assumptions in this section</b></p><div class="informaltable"><table cellspacing="0" border="1"><colgroup><col><col></colgroup><tbody><tr><td>name of OpenACS user</td><td><span class="replaceable"><span class="replaceable">nsadmin</span></span></td></tr><tr><td>OpenACS server name</td><td><span class="replaceable"><span class="replaceable">openacs-dev</span></span></td></tr><tr><td>Root of OpenACS file tree</td><td><span class="replaceable"><span class="replaceable">/web/openacs-dev</span></span></td></tr><tr><td>Database backup directory</td><td><span class="replaceable"><span class="replaceable">/backup/openacs/</span></span></td></tr></tbody></table></div></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="upgrade-4.6.3-to-5"></a>Upgrading 4.6.3 to 5.0</h3></div></div><div></div></div><p>Current working notes in <a href="http://openacs.org/forums/message-view?message_id=143497" target="_top">Forum OpenACS Development: 4.6.3 upgrade to 5-HEAD: final results</a>.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="upgrade-4.5-to-4.6"></a>Upgrading 4.5 to 4.6</h3></div></div><div></div></div><a class="indexterm" name="id2875581"></a><p>The required platform for OpenACS 4.6 is the same as
    4.5, with the excepion of OpenFTS.  You now need OpenFTS 0.3.2, not 0.2.
    OpenACS 4.6 does not support PostgreSQL 7.3.</p><div class="itemizedlist"><ul type="circle"><li style="list-style-type: circle"><p>A computer with OpenACS 4.5.</p></li><li style="list-style-type: circle"><p><a href="http://openacs.org/projects/openacs/download/" target="_top">OpenACS 4.6 tarball</a></p></li><li style="list-style-type: circle"><p>Required for Full Text Search on PostgreSQL: <a href="http://openfts.sourceforge.net" target="_top">OpenFTS 0.3.2</a></p></li></ul></div><p>Upgrade Sequence</p><div class="orderedlist"><ol type="1"><li><p><b>Make a Backup. </b>Back up the database and file system (see <a href="backup-recovery.html#snapshot-backup" title="Manual backup and recovery">the section called &#8220;Manual backup and recovery&#8221;</a>).</p></li><li><p><b>OPTIONAL: Upgrade OpenFTS. </b>OpenACS Full Text Search requires several pieces: the OpenFTS code, some database functions, and the OpenFTS Engine.  If you have OpenFTS 0.2, you'll need to upgrade to to OpenFTS 0.3.2.  This is backwards-compatible -
        completing this step will not break a working OpenFTS Engine from 4.5.
</p><div class="orderedlist"><ol type="a"><li><p>Uninstall the old OpenFTS Engine</p><div class="orderedlist"><ol type="i"><li><p><span class="bold"><b>Browse to <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver</span></span>/openfts</tt>.</b></span>
</p></li><li><p><span class="bold"><b>Click <tt class="computeroutput"><span class="guilabel"><span class="guilabel">Administration</span></span></tt>.</b></span></p></li><li><p><span class="bold"><b>Click <tt class="computeroutput"><span class="guibutton"><span class="guibutton">Drop OpenFTS Engine</span></span></tt></b></span></p></li></ol></div></li><li><p>Build and install the new OpenFTS driver and supporting tcl procedures.  (This section of shell code is not fully documented; please exercise care.)</p><pre class="screen">cd /usr/local/src/
tar xzf /tmp/Search-OpenFTS-tcl-0.3.2.tar.gz
chown -R root.root Search-OpenFTS-tcl-0.3.2/
cd Search-OpenFTS-tcl-0.3.2/
./configure --with-aolserver-src=/usr/local/src/aolserver/aolserver --with-tcl=/usr/lib/
cd aolserver/
make
</pre><p>
Back up the old fts driver as a precaution and install the newly
compiled one</p><pre class="screen">mv /usr/local/aolserver/bin/nsfts.so /usr/local/aolserver/bin/nsfts-0.2.so 
cp nsfts.so /usr/local/aolserver/bin
</pre><p>Build and install the postgres code</p><pre class="screen">cd /usr/local/src/Search-OpenFTS-tcl-0.3.2/
cp -r pgsql_contrib_openfts /usr/local/src/postgresql-7.2.3/contrib /usr/local/src/postgresql-7.2.3/contrib/pgsql_contrib_openfts
make
su - postgres
cd tsearch/
make
make install
exit</pre><p>In order for the OpenACS 4.6 OpenFTS Engine to use the OpenFTS 0.3.2 driver, we need some commands added to the database.</p><pre class="screen">[root@localhost root]# <b class="userinput"><tt>su - nsadmin</tt></b>
[nsadmin@localhost dev]$ <b class="userinput"><tt>psql <span class="replaceable"><span class="replaceable">openacs-dev</span></span> -f /usr/local/pgsql/share/contrib/openfts.sql</tt></b>
CREATE
CREATE
[nsadmin@localhost dev]$ <b class="userinput"><tt>psql <span class="replaceable"><span class="replaceable">openacs-dev</span></span> -f /usr/local/src/postgresql-7.2.3/contrib/tsearch/tsearch.sql</tt></b>
BEGIN
CREATE
(~30 more lines)
[nsadmin@localhost dev]$ <b class="userinput"><tt>exit</tt></b>
[root@localhost root]# 
<span class="action"><span class="action">su - nsadmin
psql <span class="replaceable"><span class="replaceable">openacs-dev</span></span> -f /usr/local/pgsql/share/contrib/openfts.sql
psql <span class="replaceable"><span class="replaceable">openacs-dev</span></span> -f /usr/local/src/postgresql-7.2.3/contrib/tsearch/tsearch.sql
exit</span></span></pre></li></ol></div></li><li><p>
         Stop the server
        </p><pre class="screen">[root@localhost root]# <b class="userinput"><tt>svc -d /service/<span class="replaceable"><span class="replaceable">openacs-dev</span></span></tt></b></pre></li><li><p><b>Upgrade the file tree. </b>If you are using CVS, you will unpack the OpenACS 4.6 tarball into a working directory and then import that directory into cvs.  If you have changed files in the core packages, cvs will attempt to merge your changes.  You may have to manually merge some conflicts.  When that's finished, you can update your normal development checkout directory and the new files will appear.  If you aren't using CVS, you can unpack the tarball on top of your existing tree, but any customizations you've made to the kernel or core packages will be erased.</p><div class="itemizedlist"><ul type="disc"><li><p><b>Upgrading files without CVS. </b>Unpack the tarball into a new directory and copy its contents on top of your working directory.</p><pre class="screen">[root@localhost root]# <b class="userinput"><tt>su - nsadmin</tt></b>
[nsadmin@localhost aolserver]$ <b class="userinput"><tt>cd /web</tt></b>
[nsadmin@localhost web]$ <b class="userinput"><tt>tar xzf /tmp/openacs-4-6.tgz</tt></b>
[nsadmin@localhost web]$ <b class="userinput"><tt>cp -r openacs-4-6/* openacs-4</tt></b>
[nsadmin@localhost openacs-upgrade]$ <b class="userinput"><tt>exit</tt></b>
[root@localhost root]#
<span class="action"><span class="action">su - nsadmin
cd /web
tar xzf /tmp/openacs-4-6.tgz
cp -r openacs-4-6/* openacs-4
exit</span></span></pre></li><li><p>
              <span class="strong">Upgrading files with CVS</span>
	    </p><div class="orderedlist"><ol type="a"><li><p>Unpack the new files into a working directory.</p><pre class="screen">[root@localhost root]# <b class="userinput"><tt>su - nsadmin</tt></b>
[nsadmin@localhost aolserver]$ <b class="userinput"><tt>cd /tmp</tt></b>
[nsadmin@localhost tmp]$ <b class="userinput"><tt>tar xzv openacs-4-6.tgz</tt></b>
[nsadmin@localhost tmp]$ <b class="userinput"><tt>cd openacs-4.6</tt></b>
</pre><p>Import the new files into your cvs repository; where they match existing files, they will become the new version of the file.</p><pre class="screen">[nsadmin@localhost openacs-4.6]$ <b class="userinput"><tt> cvs import -m "upgrade to OpenACS 4.6" openacs 
OpenACS openacs-4-6</tt></b></pre><p>Create a new directory as temporary working space to reconcile conflicts between the new files and your current work.  The example uses the cvs keyword yesterday, making the assumption that you haven't checked in new code to your local tree in the last day.</p><pre class="screen">[nsadmin@localhost openacs-4.6]$ <b class="userinput"><tt> cd /web</tt></b>
[nsadmin@localhost tmp]$ <b class="userinput"><tt>mkdir openacs-upgrade</tt></b>
[nsadmin@localhost tmp]$ <b class="userinput"><tt>cvs checkout -d openacs-upgrade -jOpenACS:yesterday -jOpenACS openacs &gt; cvs.txt 2&gt;&amp;1</tt></b>
(CVS feedback here)
<span class="action"><span class="action">su - nsadmin
cd /tmp
tar xzv openacs-4-6.tgz
cd openacs-4.6
cvs import -m "upgrade to OpenACS 4.6" openacs OpenACS openacs-4-6
cd /tmp
mkdir openacs-upgrade
cvs checkout -d openacs-upgrade -jOpenACS:yesterday -jOpenACS openacs &gt; cvs.txt 2&gt;&amp;1
</span></span></pre></li><li><p>The file /tmp/openacs-upgrade/cvs.txt contains the results of the upgrade.  If you changed files that are part of the OpenACS tarball and those changes conflict with the 4.5-4.6 upgrade, you'll have to manually reconcile them.  Use the emacs command <tt class="computeroutput">M-x sort-lines</tt> and then, for each line that starts with a C, open that file and manually resolve the conflict by deleting the excess lines.  When you're finished, or if there aren't any conflicts, save and exit.</p></li><li><p>Once you've fixed any conflicts, commit the new code
        to your local tree.  </p><pre class="screen">[nsadmin@localhost tmp]$ <b class="userinput"><tt>cd openacs-upgrade</tt></b>
[nsadmin@localhost openacs-upgrade]$ <b class="userinput"><tt>cvs commit -m "Upgraded to 4.6"</tt></b>
<span class="action"><span class="action">cd openacs-upgrade
cvs commit -m "Upgraded to 4.6"</span></span></pre></li><li><p>Update your working tree with the new
                files.  The CVS flags ensure that new directories are created and pruned directories destroyed.</p><pre class="screen">
[nsadmin@localhost openacs-upgrade]$ <b class="userinput"><tt>cd /web/<span class="replaceable"><span class="replaceable">openacs-dev</span></span></tt></b>
[nsadmin@localhost openacs-dev]$ <b class="userinput"><tt>cvs up -Pd</tt></b>
(CVS feedback)
[nsadmin@localhost openacs-dev]$ <b class="userinput"><tt>exit</tt></b>
[root@localhost root]#
<span class="action"><span class="action">cd /web/<span class="replaceable"><span class="replaceable">openacs-dev</span></span>
cvs up -Pd
exit</span></span></pre></li></ol></div></li></ul></div></li><li><p>
          <span class="strong">Start the server</span>
        </p><pre class="screen">[root@localhost root]# <b class="userinput"><tt>svc -u /service/<span class="replaceable"><span class="replaceable">openacs-dev</span></span></tt></b></pre></li><li><p><b>Use APM to upgrade the database. </b></p><div class="orderedlist"><ol type="a"><li><p>Browse to the package manager, <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver</span></span>/acs-admin/apm</tt>.</p></li><li><p>Click <tt class="computeroutput"><span class="guilabel"><span class="guilabel">Install packages.</span></span></tt></p></li><li><p>Select the packages you want to install.  This should
          be everything that says
          <tt class="computeroutput">upgrade</tt>, plus any new
          packages you want.  It's safest to upgrade the kernel by
          itself, and then come back and upgrade the rest of the
          desired packages in a second pass.</p></li><li><p>On the next screen, click <tt class="computeroutput"><span class="guibutton"><span class="guibutton">Install Packages</span></span></tt></p></li><li><p>When prompted, restart the server:</p><pre class="screen">[root@localhost root]# <b class="userinput"><tt>restart-aolserver <span class="replaceable"><span class="replaceable">openacs-dev</span></span></tt></b></pre></li><li><p>Wait a minute, then browse to the package manager, <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver</span></span>/acs-admin/apm</tt>.</p></li><li><p>Check that the kernel upgrade worked by clicking <tt class="computeroutput"><span class="guilabel"><span class="guilabel">All</span></span></tt> and making sure that <tt class="computeroutput">acs-kernel</tt> version is 5.0.0b4.</p></li></ol></div></li><li><p><b>OPTIONAL: Install the new OpenFTS Engine. </b>If you want to upgrade the OpenFTS Engine, do these
          steps.  (You must have already upgraded the OpenFTS driver to
          0.3.2.)</p><div class="orderedlist"><ol type="a"><li><p>Browse to <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver</span></span>/admin/site-map</tt></p></li><li><p>On the <tt class="computeroutput">openfts</tt> line, click on <tt class="computeroutput"><span class="guilabel"><span class="guilabel">set parameters</span></span></tt>.</p></li><li><p>Change the value of <tt class="computeroutput">openfts_tcl_src_path</tt> from <tt class="computeroutput">/usr/local/src/Search-OpenFTS-tcl-0.2/</tt> to <tt class="computeroutput">/usr/local/src/Search-OpenFTS-tcl-0.3.2/</tt></p></li><li><p>Click <tt class="computeroutput"><span class="guibutton"><span class="guibutton">Set Parameters</span></span></tt></p></li><li><pre class="screen">[root@localhost root]# restart-aolserver <span class="replaceable"><span class="replaceable">openacs-dev</span></span></pre></li><li><p>Browse to <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver</span></span>/openfts</tt></p></li><li><p><span class="bold"><b>Click <tt class="computeroutput"><span class="guilabel"><span class="guilabel">Administration</span></span></tt>.</b></span></p></li><li><p><span class="bold"><b>Click <tt class="computeroutput"><span class="guibutton"><span class="guibutton">Initialize OpenFTS Engine</span></span></tt></b></span></p></li></ol></div></li><li><p><b>Rollback. </b>If anything goes wrong, <a href="backup-recovery.html#recovery">roll back</a> to the backup snapshot.</p></li></ol></div><div class="cvstag">($Id$)</div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="upgrade.html">Prev</a> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right"> <a accesskey="n" href="maintenance.html">Next</a></td></tr><tr><td width="40%" align="left">Chapter 5. Upgrading </td><td width="20%" align="center"><a accesskey="u" href="upgrade.html">Up</a></td><td width="40%" align="right"> Chapter 6. Maintenance</td></tr></table><hr><address><a href="mailto:docs@openacs.org">docs@openacs.org</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/upgrade-detail.html#comments">View comments on this page at openacs.org</a></center></body></html>
