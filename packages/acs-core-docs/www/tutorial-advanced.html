<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Advanced Topics</title><meta name="generator" content="DocBook XSL Stylesheets V1.64.1"><link rel="home" href="index.html" title="OpenACS Core Documentation"><link rel="up" href="tutorial.html" title="Chapter 7. Development Tutorial"><link rel="previous" href="tutorial-debug.html" title="Debugging and Automated Testing"><link rel="next" href="dev-guide.html" title="Chapter 8. Development Reference"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="/doc/images/alex.jpg" border="0" alt="Alex logo"></a><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="tutorial-debug.html">Prev</a> </td><th width="60%" align="center">Chapter 7. Development Tutorial</th><td width="20%" align="right"> <a accesskey="n" href="dev-guide.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tutorial-advanced"></a>Advanced Topics</h2></div></div><div></div></div><div class="authorblurb"><p>by <a href="mailto:joel@aufrecht.org" target="_top">Joel Aufrecht</a></p>
          OpenACS docs are written by the named authors, and may be edited
          by OpenACS documentation staff.
        </div><p>This tutorial covers topics which are not essential to
    creating a minimal working package.  Each section can be used
    independently of all of the others; all sections assume that
    you've completed the basic tutorial.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2476332"></a>Write the Requirements and Design Specs</h3></div></div><div></div></div><p>It's time to document.  For the tutorial we'll use
      pre-written documentation.  When creating a package
      from scratch, start by copying the documentation template from
	<tt class="computeroutput">/var/lib/aolserver/openacs-dev/packages/acs-core-docs/xml/docs/xml/package-documentation-template.xml</tt>
	to
	<tt class="computeroutput">myfirstpackage/www/docs/xml/index.xml</tt>.</p><p>You then edit that file with emacs to write the 
	requirements and design sections, generate the html, and start
	coding.  Store any supporting files, like page maps or schema
      diagrams, in the <tt class="computeroutput">www/doc/xml</tt>
      directory, and store png or jpg versions of supporting files in the
	<tt class="computeroutput">www/doc</tt> directory.</p><p>For this tutorial, you should instead install the
	pre-written documentation files for the tutorial app.  Log in
      as <span class="replaceable"><span class="replaceable">service0</span></span>, create the standard
      directories, and copy the prepared documentation:</p><pre class="screen">[service0 service0]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/</tt></b>
[service0 myfirstpackage]$ <b class="userinput"><tt>mkdir -p www/doc/xml</tt></b>
[service0 myfirstpackage]$ <b class="userinput"><tt>cd www/doc/xml</tt></b>
[service0 xml]$ <b class="userinput"><tt>cp /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/acs-core-docs/www/files/myfirstpackage/* .</tt></b>
[service0 xml]$</pre><p> OpenACS uses DocBook for documentation.  DocBook is
	an XML standard for semantic markup of documentation.  That
	means that the tags you use indicate meaning, not intended
	appearance.  The style sheet will determine appearance.  You
      will edit the text in an xml file, and then process the file
      into html for reading.</p><p>Open the file <tt class="computeroutput">index.xml</tt>
      in emacs.  Examine the file.  Find the version history (look for the tag
        <tt class="computeroutput">&lt;revhistory&gt;</tt>).  Add a
        new record to the document version history.  Look for the
        <tt class="computeroutput">&lt;authorgroup&gt;</tt> tag and
        add yourself as a second author.  Save and exit.  For tips on
        editing SGML files in emacs, see <a href="docbook-primer.html">OpenACS Documentation Guide</a></p><p>Process the xml file to create html documentation.  The
      html documentation, including supporting files such as pictures,
      is stored in the <tt class="computeroutput">www/docs/</tt>
      directory.  A Makefile is provided to generate html from the xml, and copy all of the
      supporting files.  If Docbook is set up correctly, all you need
      to do is:</p><pre class="screen">[service0 xml]$<b class="userinput"><tt> make</tt></b>
cd .. ; /usr/bin/xsltproc ../../../acs-core-docs/www/xml/openacs.xsl xml/index.xml
Writing requirements-introduction.html for sect1(requirements-introduction)
Writing requirements-overview.html for sect1(requirements-overview)
Writing requirements-cases.html for sect1(requirements-cases)
Writing sample-data.html for sect1(sample-data)
Writing requirements.html for chapter(requirements)
Writing design-data-model.html for sect1(design-data-model)
Writing design-ui.html for sect1(design-ui)
Writing design-config.html for sect1(design-config)
Writing design-future.html for sect1(design-future)
Writing filename.html for chapter(filename)
Writing user-guide.html for chapter(user-guide)
Writing admin-guide.html for chapter(admin-guide)
Writing bi01.html for bibliography
Writing index.html for book
[service0 xml]$</pre><p>Verify that the documentation was generated and reflects
      your changes by browsing to <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yoursite</span></span>:8000/myfirstpackage/doc</tt></p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2476492"></a>Add the new package to CVS</h3></div></div><div></div></div><p>Before you do any more work, make sure that your work is
      protected by putting it all into cvs.  The <tt class="computeroutput">cvs
      add</tt> command is not recursive, so you'll have to
      traverse the directory tree manually and add as you go.  (<a href="http://www.piskorski.com/docs/cvs-conventions.html" target="_top">More on
      CVS</a>)</p><pre class="screen">[service0 xml]$ <b class="userinput"><tt>cd ..</tt></b>
[service0 doc]$ <b class="userinput"><tt>cd ..</tt></b>
[service0 www]$ <b class="userinput"><tt>cd ..</tt></b>
[service0 myfirstpackage]$ <b class="userinput"><tt>cd ..</tt></b>
[service0 packages]$ <b class="userinput"><tt>cvs add myfirstpackage/</tt></b>
Directory /cvsroot/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage added to the repository
[service0 packages]$ <b class="userinput"><tt>cd myfirstpackage/</tt></b>
[service0 myfirstpackage]$ <b class="userinput"><tt>cvs add www</tt></b>
Directory /cvsroot/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www added to the repository
[service0 myfirstpackage]$ <b class="userinput"><tt>cd www</tt></b>
[service0 www]$ <b class="userinput"><tt>cvs add doc</tt></b>
Directory /cvsroot/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/doc added to the repository
[service0 www]$ <b class="userinput"><tt>cd doc</tt></b>
[service0 doc]$ <b class="userinput"><tt>cvs add *</tt></b>
cvs add: cannot add special file `CVS'; skipping
cvs add: scheduling file `admin-guide.html' for addition
cvs add: scheduling file `bi01.html' for addition
cvs add: scheduling file `data-model.dia' for addition
cvs add: scheduling file `data-model.png' for addition
cvs add: scheduling file `design-config.html' for addition
cvs add: scheduling file `design-data-model.html' for addition
cvs add: scheduling file `design-future.html' for addition
cvs add: scheduling file `design-ui.html' for addition
cvs add: scheduling file `filename.html' for addition
cvs add: scheduling file `index.html' for addition
cvs add: scheduling file `page-map.dia' for addition
cvs add: scheduling file `page-map.png' for addition
cvs add: scheduling file `requirements-cases.html' for addition
cvs add: scheduling file `requirements-introduction.html' for addition
cvs add: scheduling file `requirements-overview.html' for addition
cvs add: scheduling file `requirements.html' for addition
cvs add: scheduling file `sample-data.html' for addition
cvs add: scheduling file `sample.png' for addition
cvs add: scheduling file `user-guide.html' for addition
cvs add: scheduling file `user-interface.dia' for addition
cvs add: scheduling file `user-interface.png' for addition
Directory /cvsroot/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/doc/xml added to the repository
cvs add: use 'cvs commit' to add these files permanently
[service0 doc]$ <b class="userinput"><tt>cd xml</tt></b>
[service0 xml]$ <b class="userinput"><tt>cvs add Makefile index.xml</tt></b>
cvs add: scheduling file `Makefile' for addition
cvs add: scheduling file `index.xml' for addition
cvs add: use 'cvs commit' to add these files permanently
[service0 xml]$<b class="userinput"><tt> cd ../../..</tt></b>
[service0 myfirstpackage]$ <b class="userinput"><tt>cvs commit -m "new package"</tt></b>
cvs commit: Examining .
cvs commit: Examining www
cvs commit: Examining www/doc
cvs commit: Examining www/doc/xml
RCS file: /cvsroot/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/doc/admin-guide.html,v
done
Checking in www/doc/admin-guide.html;
/cvsroot/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/doc/admin-guide.html,v  &lt;--  admin-guide.html
initial revision: 1.1
done
<span class="emphasis"><em>(many lines omitted)</em></span>
[service0 myfirstpackage]$</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2476650"></a>Adding Comments</h3></div></div><div></div></div><p>You can track comments for any ACS Object.  Here we'll track
     comments for notes.  On the note-edit.tcl/adp pair, which is used to
     display individual notes, we want to put a link to add comments at
     the bottom of the screen.  If there are any comments, we want to
     show them.</p><p>First, we need to generate a url for adding comments.  In note-edit.tcl:</p><pre class="programlisting">
 set comment_add_url "[general_comments_package_url]comment-add?[export_vars {
  { object_id $note_id } 
  { object_name $title } 
  { return_url "[ad_conn url]?[ad_conn query]"} 
 }]"
 </pre><p>This calls a global, public tcl function that the
     general_comments package registered, to get its url. You then
     embed in that url the id of the note and its title, and set the
     return_url to the current url so that the user can return after
     adding a comment.</p><p>We need to create html that shows any existing comments.
     We do this with another general_comments function:</p><pre class="programlisting">set comments_html [general_comments_get_comments
     -print_content_p 1 $note_id]</pre><p>First, we pass in an optional parameter that that says to actually
     show the contents of the comments, instead of just the fact that
     there are comments. Then you pass the note id, which is also the
     acs_object id.</p><p>We put our two new variables in the note-edit.adp
     page.</p><pre class="programlisting">&lt;a href="@comment_add_url@"&gt;Add a comment&lt;/a&gt;
 @comments_html@</pre></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2476716"></a>Admin Pages</h3></div></div><div></div></div><p>
     There are at least two flavors of admin user interface:
     </p><div class="itemizedlist"><ul type="disc"><li><p>Admins use same pages as all other users, except
       that they are offered admin links and buttons where appropriate.
       For example, if admins have privilege to bulk-delete items you
       could provide checkboxes next to every item seen on a list and the
       Delete Selected button on the bottom of the list.
       </p></li><li><p>Dedicated admin pages.  If you want admins to have
       access to data that users aren't interested in or aren't allowed
       to see you will need dedicated admin pages.  The conventional
       place to put those dedicated admin pages is in the
 <tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/admin</tt>
 directory.
      </p><pre class="screen">[service0 www]$ <b class="userinput"><tt>mkdir admin</tt></b></pre><pre class="screen">[service0 www]$ <b class="userinput"><tt>cd admin</tt></b></pre><p>
      Even if your application doesn't need any admin pages of its own you will
      usually need at least one simple page with a bunch of links to existing
      administration UI such as Category Management or standard Parameters UI.
      Adding the link to Category Management is described in the section on
      categories.  The listing below adds a link to the Parameters UI of our
      package.
      </p><pre class="screen">[service0 admin]$ <b class="userinput"><tt>vi index.adp</tt></b></pre><pre class="programlisting">
&lt;master&gt;
&lt;property name="title"&gt;@title;noquote@&lt;/property&gt;
&lt;property name="context"&gt;@context;noquote@&lt;/property&gt;

&lt;ul class="action-links"&gt;
  &lt;li&gt;&lt;a href="@parameters_url@" title="Set parameters" class="action_link"&gt;Set parameters&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</pre><pre class="screen">[service0 admin]$ <b class="userinput"><tt>vi index.tcl</tt></b></pre><pre class="programlisting">
ad_page_contract {} {
} -properties {
    context_bar
}

set package_id [ad_conn package_id]

set admin_p [ad_require_permission $package_id admin]

set context [list]

set title "Administration"

set parameters_url [export_vars -base "/shared/parameters" {
  package_id { return_url [ad_return_url] }
}]

</pre><p>
Now that you have the first admin page it would be nice to have a link to it
somewhere in the system so that admins don't have to type in the
<tt class="computeroutput">/admin</tt> every time they need to reach it.  You
could put a static link to the toplevel
<tt class="computeroutput">index.adp</tt> but that might be distracting for
people who are not admins.  Besides, some people consider it impolite to first
offer a link and then display a nasty "You don't have permission to access this
page" message.
</p><p>
In order to display the link to the admin page only to users that have admin
privileges add the following code near the top of
<tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/admin/index.tcl</tt>:
</p><pre class="programlisting">

set package_id [ad_conn package_id]

set admin_p [permission::permission_p -object_id $package_id \
  -privilege admin -party_id [ad_conn untrusted_user_id]]

if { $admin_p } {
    set admin_url "admin"
    set admin_title Administration
}
</pre><p>
In 
<tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/admin/index.adp</tt> put:
</p><pre class="programlisting">
&lt;if @admin_p@ ne nil&gt;
  &lt;a href="@admin_url@"&gt;@admin_title@&lt;/a&gt;
&lt;/if&gt;
</pre></li></ul></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2478848"></a>Categories</h3></div></div><div></div></div><p>You can associate any ACS Object with one or more categories.
    In this tutorial we'll show how to equip your application with user
    interface to take advantage of the Categories service.
    </p><p>
    We'll start by installing the Categories service.  Go to
    <tt class="computeroutput">/acs/admin</tt> and install it.  This step
    won't be necessary for the users of your applications because you'll create
    a dependency with the Package Manager which will take care that the
    Categories service always gets installed when your application gets
    installed.
    </p><p>
    Now that we have installed the Categories service we can proceed to
    modifying our application so that it can take advantage of it.  We'll do it
    in three steps:
    </p><div class="orderedlist"><ol type="1"><li><p>
          The Categories service provides a mechanism to associate one or
          more <span class="emphasis"><em>category trees</em></span> that are relevant to
          your application.  One example of such tree is a tree of
          geographical locations.  Continents are on the top of such tree,
          each continent containing countries etc.  Another tree might
          contain market segments etc.  Before users of your application
          can take advantage of the Categories service there needs to be a
          way for administrators of your application to choose which
          category trees are applicable for the application.
          </p><p>
          The way to achieve this is is to provide a link
          to the Category Management pages.  Add the following snippet to your
            <tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/admin/index.tcl</tt>
          file:
          </p><pre class="programlisting">
set category_map_url [export_vars -base \
    "[site_node::get_package_url -package_key categories]cadmin/one-object" \
        { { object_id $package_id } }]
          </pre><p>
          and the following snippet to your
            <tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/myfirstpackage/www/admin/index.adp</tt>
          file:
          </p><pre class="programlisting">
&lt;li&gt;&lt;a href="@category_map_url@"
      class="action_link"&gt;Site-Wide Categories&lt;/a&gt;
          </pre><p>
          The link created by the above code will take the admin to the generic
          admin UI where he can pick category trees that make sense for this
          application.  The same UI also includes facilities to build and edit
          category trees.  Notice that the only parameter in this example is
          <tt class="computeroutput">package_id</tt> so that category trees
          will be associated with the object identified by this
          <tt class="computeroutput">package_id</tt>.  The categorization
          service is actually more general than that: instead of
          <tt class="computeroutput">package_id</tt> you could use an ID of
          some other object that serves as a "container" in your application.
          For example, if your discussion forums application supports multiple
          forums you would use <tt class="computeroutput">forum_id</tt> to
          associate category trees with just that one forum rather than the
          entire application instance.
        </p></li><li><p>
          Once the category trees have been selected users need a way
          to categorize items.  The easiest way to do this is by adding the
          <tt class="computeroutput">category</tt> widget type of the
          form builder to <tt class="computeroutput">note-edit.tcl</tt>.
          To achieve this we'll need to use the <tt class="computeroutput">-extend</tt>
          switch to the <tt class="computeroutput">ad_form</tt> command. Here's the "meat" of the
          <tt class="computeroutput">note-edit.tcl</tt> page:
          </p><pre class="programlisting">
ad_form -name note -form {
    {item_id:key}
    {title:text {label Title}}
}

set package_id [ad_conn package_id]

set category_trees [category_tree::get_mapped_trees $package_id]

foreach tree $category_trees {
    foreach { tree_id name subtree_id } $tree {}
    ad_form -extend -name note -form \
        [list [list category_id_${tree_id}:integer(category),optional \
                   {label $name} \
                   {html {single single}} \
                   {category_tree_id $tree_id} \
                   {category_subtree_id $subtree_id} \
                   {category_object_id {[value_if_exists entry_id]}}]]
}

ad_form -extend \
  -name note \
  -new_request {
    permission::require_permission -object_id [ad_conn package_id] -privilege create
    set page_title "Add a Note"
    set context [list $page_title]
} -edit_request {
    permission::require_write_permission -object_id $item_id
    mfp::note::get \
    -item_id $item_id \
    -array note_array

    set title $note_array(title)

    set page_title "Edit a Note"
    set context [list $page_title]
} -new_data {
    mfp::note::add \
    -title $title
} -after_submit {
    ad_returnredirect "."
    ad_script_abort
}
          </pre><p>
      </p></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2479038"></a>Profile your code</h3></div></div><div></div></div><p>There are several facilities for profiling your code in
      OpenACS. The first thing to do is to install the
      developer-support package and play around with it. But there
      is also support in the API for profiling your code:
      <a href="http://openacs.org/forums/message-view?message_id=161324" target="_top">profiling
      your code using ds_profile</a>
      </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2479062"></a>Prepare the package for distribution.</h3></div></div><div></div></div><p>Browse to the package manager.  Click on
        <tt class="computeroutput"><span class="guilabel"><span class="guilabel">tutorialapp</span></span></tt>.</p><p>Click on <tt class="computeroutput"><span class="guilabel"><span class="guilabel">Generate a distribution file
        for this package from the
        filesystem</span></span></tt>.
        </p><p>Click on the file size
        (<tt class="computeroutput"><span class="guilabel"><span class="guilabel">37.1KB</span></span></tt>)
        after the label <tt class="computeroutput"><span class="guilabel"><span class="guilabel">Distribution
        File:</span></span></tt> and save the file to
        /tmp.</p><p><a class="indexterm" name="id2479108"></a>
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2479119"></a>Notifications</h3></div></div><div></div></div><div class="authorblurb"><p>by <a href="mailto:dave@student.usyd.edu.au" target="_top">David Bell</a> and <a href="mailto:simon@collaboraid.net" target="_top">Simon Carstensen</a></p>
          OpenACS docs are written by the named authors, and may be edited
          by OpenACS documentation staff.
        </div><p>The notifications package allows you to send notifications through any 
    defined communications medium (e.g. email, sms) upon some event occuring within 
    the system.</p><p>This tutorial steps through the process of integrating the notifications 
    package with your package.</p><p>First step is to create the notification types. To do this a script similar 
    to the one below needs to be loaded into Postgresql. I create this script in a 
    package-name/sql/postgresql/package-name-notifications-init.sql file. I then load 
    this file from my create sql file. The following code snippet is taken from 
    Weblogger. It creates a lars_blogger_notif notification type (which was created 
    above).</p><pre class="programlisting">
    create function inline_0() returns integer as '
    declare
            impl_id integer;
            v_foo   integer;
    begin
        -- the notification type impl
        impl_id := acs_sc_impl__new (
                      ''NotificationType'',
                      ''lars_blogger_notif_type'',
                      ''lars-blogger''
        );

        v_foo := acs_sc_impl_alias__new (
                    ''NotificationType'',
                    ''lars_blogger_notif_type'',
                    ''GetURL'',
                    ''lars_blogger::notification::get_url'',
                    ''TCL''
        );

        v_foo := acs_sc_impl_alias__new (
                    ''NotificationType'',
                    ''lars_blogger_notif_type'',
                    ''ProcessReply'',
                    ''lars_blogger::notification::process_reply'',
                    ''TCL''
        );

        PERFORM acs_sc_binding__new (
                    ''NotificationType'',
                    ''lars_blogger_notif_type''
        );

        v_foo:= notification_type__new (
	        NULL,
                impl_id,
                ''lars_blogger_notif'',
                ''Blog Notification'',
                ''Notifications for Blog'',
		now(),
                NULL,
                NULL,
		NULL
        );

        -- enable the various intervals and delivery methods
        insert into notification_types_intervals
        (type_id, interval_id)
        select v_foo, interval_id
        from notification_intervals where name in (''instant'',''hourly'',''daily'');

        insert into notification_types_del_methods
        (type_id, delivery_method_id)
        select v_foo, delivery_method_id
        from notification_delivery_methods where short_name in (''email'');

        return (0);
    end;
    ' language 'plpgsql';

    select inline_0();
    drop function inline_0();
    </pre><p>The next step is to setup our notification creation. A new notification must 
    be added to the notification table for each blog entry added. We do this using the 
    notification::new procedure</p><pre class="programlisting">
        notification::new \
            -type_id [notification::type::get_type_id \
            -short_name lars_blogger_notif] \
            -object_id $blog(package_id) \
            -response_id $blog(entry_id) \
            -notif_subject $blog(title) \
            -notif_text $new_content
    </pre><p>This code is placed in the tcl procedure that creates blog entries, right after
    the entry gets created in the code. The <tt class="computeroutput">$blog(package_id)</tt> 
    is the OpenACS object_id of the Weblogger instance to which the entry has been posted to 
    and the <tt class="computeroutput">$new_content</tt> is the content of the entry.</p><p>The final step is to setup the notification subscription process. In this 
    example we want to let a user find out when a new entry has been posted to the blog. To 
    do this we put a link on the blog that allows them to subscribe to notifications of new 
    entries. The notifications/requests-new page is very handy in this situation.</p><p>Such a link can be created using the <tt class="computeroutput">notification::display::request_widget</tt> 
    proc:</p><pre class="programlisting">
    set notification_chunk [notification::display::request_widget \
        -type lars_blogger_notif \
        -object_id $package_id \
        -pretty_name [lars_blog_name] \
        -url [lars_blog_public_package_url] \
    ]
    </pre><p>which will return something like

    </p><pre class="programlisting">
    You may &lt;a href="/notifications/request-new?..."&gt;request notification&lt;/a&gt; for Weblogger.</pre><p>

    which can be readily put on the blog index page. The <tt class="computeroutput">pretty_name</tt> 
    parameter is what appears at the end of the text returned (i.e. "... request notification&lt;/a&gt; for pretty_name"), 
    The <tt class="computeroutput">url</tt> parameter should be set to the address we want the user 
    to be redirected to after they have finished the subscription process.</p><p>This should be all you need to implement a notification system. For more examples
    look at the forums package.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="id2479296"></a>Hierarchical data</h3></div></div><div></div></div><div class="authorblurb"><p>by <a href="http://rubick.com:8002" target="_top">Jade Rubick</a>
      with help from many people in the OpenACS community</p>
          OpenACS docs are written by the named authors, and may be edited
          by OpenACS documentation staff.
        </div><p>One of the nice things about using the OpenACS object system
    is that it has a built-in facility for tracking hierarchical data
    in an efficient way. The algorithm behind this is called
    <tt class="computeroutput">tree_sortkey.</tt></p><p>Any time your tables are subclasses of the acs_objects
    table, then you automatically get the ability to structure them
    hierarchically. The way you do this is currently via the
    <tt class="computeroutput">context_id</tt> column of
    acs_objects (Note that there is talk of adding in a
    <tt class="computeroutput">parent_id</tt> column instead, because
    the use of <tt class="computeroutput">context_id</tt> has been
    ambiguous in the past). So when you want to build your hierarchy,
    simply set the context_id values. Then, when you want to make
    hierarchical queries, you can do them as follows:</p><pre class="programlisting">
      db_multirow categories blog_categories "
      SELECT
      c.*,
      o.context_id,
      tree_level(o.tree_sortkey)
      FROM
      blog_categories c,
      acs_objects o
      WHERE
      c.category_id = o.object_id
      ORDER BY
      o.tree_sortkey"
    </pre><p>Note the use of the
    <tt class="computeroutput">tree_level()</tt> function, which
    gives you the level, starting from 1, 2, 3... </p><p>Here's an example, pulling all of the children for a given
  parent:</p><pre class="programlisting">
      SELECT 
      children.*,
      tree_level(children.tree_sortkey) -
        tree_level(parent.tree_sortkey) as level
      FROM 
      some_table parent, 
      some_table children
      WHERE 
      children.tree_sorktey between parent.tree_sortkey and tree_right(parent.tree_sortkey)
      and parent.tree_sortkey &lt;&gt; children.tree_sortkey
      and parent.key = :the_parent_key;
      </pre><p>The reason we substract the parent's tree_level from the
    child's tree_level is that the tree_levels are global, so if you
    want the parent's tree_level to start with 0, you'll want the
    subtraction in there. This is a reason you'll commonly see magic
    numbers in tree_sortkey SQL queries, like
    <tt class="computeroutput">tree_level(children.tree_sortkey) -
    4</tt>. That is basically an incorrect way to do it,
    and subtracting the parent's tree_level is the preferred method.</p><p>This example does not include the parent. To return the entire subtree including the parent, leave out the non-equals clause:</p><pre class="programlisting">
      SELECT
      subtree.*,
      tree_level(children.tree_sortkey) -
        tree_level(parent.tree_sortkey) as level
      FROM some_table parent, some_table subtree
      WHERE 
      subtree.tree_sorktey between parent.tree_sortkey and tree_right(parent.tree_sortkey)
      and parent.key = :the_parent_key;
    </pre><p>If you are using the Content Repository, you get a similar
      facility, but the <tt class="computeroutput">parent_id</tt>
      column is already there. Note you can do joins with
      <tt class="computeroutput">tree_sortkey</tt>:</p><pre class="programlisting">
      SELECT
      p.item_id,
      repeat(:indent_pattern, (tree_level(p.tree_sortkey) - 5)* :indent_factor) as indent,
      p.parent_id as folder_id,
      p.project_name
      FROM pm_projectsx p, cr_items i
      WHERE p.project_id = i.live_revision
      ORDER BY i.tree_sortkey
    </pre><p>This rather long thread explains <a href="http://openacs.org/forums/message-view?message_id=16799" target="_top">How
    tree_sortkeys work</a> and this paper <a href="http://www.yafla.com/papers/sqlhierarchies/sqlhierarchies2.htm" target="_top">describes
    the technique for tree_sortkeys</a>, although the <a href="http://openacs.org/forums/message-view?message_id=112943" target="_top">OpenACS
    implementation has a few differences in the
    implementation</a>, to make it work for many languages and the
    LIKE construct in Postgres.
    </p></div><p>Future Topics:</p><div class="itemizedlist"><ul type="disc"><li><p>How to enforce security so that users can't
      change other users records</p></li><li><p>How to use the content management tables so that
      ... what?</p></li><li><p>How to change the default stylesheets for Form
      Builder HTML forms.</p></li><li><p>How to make your package searchable with OpenFTS/Oracle</p></li><li><p>How to prepare pagelets for inclusion in other pages</p></li><li><p>How and when to put procedures in a tcl procedure library</p></li><li><p>More on ad_form - data validation, other stuff.
      (plan to draw from Jon Griffin's doc)</p></li><li><p>How and when to implement caching</p></li><li><p>partialquery in xql</p></li><li><p>How to use the html/text entry widget to get the
      "does this look right" confirm page </p></li><li><p>APM package dependencies</p></li></ul></div><p>See also the <a href="http://openacs.org/faq/one-faq?faq_id=43841" target="_top">OpenACS Programming FAQ</a></p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tutorial-debug.html">Prev</a> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right"> <a accesskey="n" href="dev-guide.html">Next</a></td></tr><tr><td width="40%" align="left">Debugging and Automated Testing </td><td width="20%" align="center"><a accesskey="u" href="tutorial.html">Up</a></td><td width="40%" align="right"> Chapter 8. Development Reference</td></tr></table><hr><address><a href="mailto:docs@openacs.org">docs@openacs.org</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/tutorial-advanced.html#comments">View comments on this page at openacs.org</a></center></body></html>
