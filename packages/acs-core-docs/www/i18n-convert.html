<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>How to Internationalize a Package</title><meta name="generator" content="DocBook XSL Stylesheets V1.64.1"><link rel="home" href="index.html" title="OpenACS Core Documentation"><link rel="up" href="i18n.html" title="Chapter 14. Internationalization"><link rel="previous" href="i18n-introduction.html" title="How Internationalization/Localization works in OpenACS"><link rel="next" href="i18n-design.html" title="Design Notes"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="/doc/images/alex.jpg" border="0" alt="Alex logo"></a><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="i18n-introduction.html">Prev</a> </td><th width="60%" align="center">Chapter 14. Internationalization</th><td width="20%" align="right"> <a accesskey="n" href="i18n-design.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="i18n-convert"></a>How to Internationalize a Package</h2></div></div><div></div></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>
      For multilingual websites we recommend using the UTF8
      charset. In order for AOLserver to use utf8 you need to set
      the config parameters OutputCharset and
      URLCharset to utf-8 in your AOLserver config file (use the etc/config.tcl
      template file).  This is the default for OpenACS 5.1 and later. For sites running on Oracle you need to make
      sure that AOLserver is running with the NLS_LANG environment
      variable set to .UTF8. You should set this variable in the
      nsd-oracle run script (use the
      acs-core-docs/www/files/nds-oracle.txt template file).
    </p></div><div class="orderedlist"><ol type="1"><li><p><b>Replace all text with temporary message tags. </b>From<tt class="computeroutput">/acs-admin/apm/</tt>, select a
        package and then click on
        <tt class="computeroutput">Internationalization</tt>, then
        <tt class="computeroutput">Convert ADP, Tcl, and SQL files to using the
        message catalog.</tt>.  This pass only changes the adp files; it does not affect catalog files or the catalog in the database.</p><div class="mediaobject" align="center"><img src="images/i18n-1.png" align="middle"></div><p>You will now be walked through all of the selected adp pages.  The UI shows you the intended changes and lets you edit or cancel them key by key.</p><div class="mediaobject" align="center"><img src="images/i18n-2.png" align="middle"></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>The automatic process can easily get confused by tags within message texts, so that it tries to create two or three message keys for one long string with a tag in the middle.  In these cases, uncheck those keys during the conversion and then edit the files directly.  For example, this code:</p><pre class="programlisting">  &lt;p class="form-help-text"&gt;&lt;b&gt;Invitations&lt;/b&gt; are sent,
    when this wizard is completed and casting begins.&lt;/p&gt;</pre><p>has a bold tag which confuses the converter into thinking there are two message keys for the text beginning "Invitations ..." where there should be one:</p><div class="mediaobject" align="center"><img src="images/i18n-3.png" align="middle"></div><p>Instead, we cancel those keys, edit the file manually, and put in a single temporory message tag:</p><pre class="programlisting">  &lt;p class="form-help-text"&gt; &lt;#Invitations_are_sent &lt;b&gt;Invitations&lt;/b&gt; are sent,
    when this wizard is completed and casting begins.#&gt;
  &lt;/p&gt;</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Complex if statements may produce convoluted message keys that are very hard to localize.  Rewrite these if statements.  For example:</p><pre class="programlisting">
Select which case &lt;if @simulation.casting_type@ eq "open"&gt;and
role&lt;/if&gt; to join, or create a new case for yourself.  If you do not
select a case &lt;if @simulation.casting_type@ eq "open"&gt;and role&lt;/if&gt;
to join, you will be automatically assigned to a case &lt;if
@simulation.casting_type@ eq "open"&gt;and role&lt;/if&gt; when the
simulation begins.</pre><p>... can be rewritten:</p><pre class="programlisting">&lt;if @simulation.casting_type@ eq "open"&gt;

Select which case and role to join, or create a new case for
yourself.  If you do not select a case and role to join, you will
be automatically assigned to a case and role when the simulation
begins.

&lt;/if&gt;
&lt;else&gt;

Select which case to join, or create a new case for
yourself.  If you do not select a case to join, you will
be automatically assigned to a case when the simulation
begins.

&lt;/else&gt;</pre></div></li><li><p><b>Replace the temporary message tags in ADP files. </b>From the same <tt class="computeroutput">Convert ADP ...</tt> page in <tt class="computeroutput">/acs-admin/apm</tt> as in the last step, repeat the process but deselect <tt class="computeroutput">Find human language text ...</tt> and select <tt class="computeroutput">Replace &lt;# ... #&gt; tags ...</tt> and click OK.  This step replaces all of the temporary tags with "short" message lookups, inserts the message keys into the database message catalog, and then writes that catalog out to an xml file.</p></li><li><p><b>Replace human-readable text in TCL files with temporary tags. </b>Examine all of the tcl files in the packages for human-readable text and replace it with temporary tags.  The temporary tags in TCL are slightly different from those in ADP.  If the first character in the temporary tag is an underscore (<tt class="computeroutput">_</tt>), then the message keys will be auto-generated from the original message text.  Here is an unmodified tcl file:</p><pre class="programlisting">ad_page_contract {
    List of messages for a case
} {
    case_id:integer
    role_id:integer
}

set workflow_id [simulation::case::get_element -case_id $case_id -element workflow_id]
set simulation_name [simulation::template::get_element -workflow_id $workflow_id -element pretty_name]
workflow::role::get -role_id $role_id -array role_array
simulation::case::get -case_id $case_id -array case_array

set title "Messages for $role_array(pretty_name) in $case_array(label)"
set context [list [list . "SimPlay"] [list [export_vars -base case-admin { case_id }] 
             "Administer $case_array(label)"] "Messages for $role_array(pretty_name)"]

set user_id [ad_conn user_id]</pre><p>... and here is the same file after temporary message tags have been manually added:</p><pre class="programlisting">ad_page_contract {
    List of messages for a case
} {
    case_id:integer
    role_id:integer
}

set workflow_id [simulation::case::get_element -case_id $case_id -element
workflow_id]
set simulation_name [simulation::template::get_element -workflow_id
$workflow_id -element pretty_name]
workflow::role::get -role_id $role_id -array role_array
simulation::case::get -case_id $case_id -array case_array

# Variables used by I18N messages (array variables not currently
supported)
set role_pretty_name $role_array(pretty_name)
set case_pretty_name $case_array(label)
set title &lt;#case_admin_page_title Messages for %role_pretty_name% in
%case_pretty_name%#&gt;
set context [list [list . &lt;#_ SimPlay#&gt;] [list [export_vars -base
case-admin { case_id }] &lt;#_ Administer %case_pretty_name%#&gt;] &lt;#_ Messages
for %role_pretty_name%#&gt;]</pre><p>Note that the message key <tt class="computeroutput">case_admin_page_title</tt> was manually selected, because an autogenerated key for this text, with its substitute variables, would have been very confusing
</p></li><li><p><b>Replace the temporary message tags in TCL files. </b>Repeat step 2 for tcl files.  Here is the example TCL file after conversion:</p><pre class="programlisting">ad_page_contract {
    List of messages for a case
} {
    case_id:integer
    role_id:integer
}

set workflow_id [simulation::case::get_element -case_id $case_id -element
workflow_id]
set simulation_name [simulation::template::get_element -workflow_id
$workflow_id -element pretty_name]
workflow::role::get -role_id $role_id -array role_array
simulation::case::get -case_id $case_id -array case_array

# Variables used by I18N messages (array variables not currently
supported)
set role_pretty_name $role_array(pretty_name)
set case_pretty_name $case_array(label)
set title [_ simulation.case_admin_page_title]
set context [list [list . [_ simulation.SimPlay]] [list [export_vars
-base case-admin { case_id }] [_ simulation.lt_Administer_case_prett]] [_
simulation.lt_Messages_for_role_pre]]

set user_id [ad_conn user_id]</pre></li><li><p><b>Internationalize SQL Code. </b>If there is any user-visible TCL code in the .sql or .xql files, internationalize that the same way as for the TCL files.</p></li><li><p><b>Internationalize Package Parameters. </b>
      See <a href="i18n-introduction.html#i18n-message-apm-params">Multilingual APM Parameters</a>
    </p></li><li><p><b>Internationalize Date and Time queries. </b></p><div class="orderedlist"><ol type="a"><li><p>Find datetime in .xql files.  Use command line tools to find suspect SQL code:</p><pre class="programlisting">grep -r "to_char.*H" *
grep -r "to_date.*H" *
</pre></li><li><p>In SQL statements, replace the format string with the ANSI standard format, <tt class="computeroutput">YYYY-MM-DD HH24:MI:SS</tt> and change the field name to *_ansi so that it cannot be confused with previous, improperly formatting fields.  For example,</p><pre class="programlisting">to_char(timestamp,'MM/DD/YYYY HH:MI:SS') as foo_date_pretty</pre><p>becomes</p><pre class="programlisting">to_char(timestamp,'YYYY-MM-DD HH24:MI:SS') as foo_date_ansi</pre></li><li><p>In TCL files where the date fields are used, convert the datetime from local server timezone, which is how it's stored in the database, to the user's timezone for display.  Do this with the localizing function <tt class="computeroutput"><a href="/api-doc/proc-view?proc=lc_time_system_to_conn" target="_top">lc_time_system_to_conn</a></tt>:</p><pre class="programlisting">
set foo_date_ansi [lc_time_system_to_conn $foo_date_ansi]</pre><p>When a datetime will be written to the database, first convert it from the user's local time to the server's timezone with <tt class="computeroutput"><a href="/api-doc/proc-view?proc=lc%5ftime%5fconn%5fto%5fsystem" target="_top">lc_time_conn_to_system</a></tt>.
</p></li><li><p>When a datetime field will be displayed, format it using the localizing function <tt class="computeroutput"><a href="/api-doc/proc-view?proc=lc_time_fmt" target="_top">lc_time_fmt</a></tt>. lc_time_fmt takes two parameters, datetime and format code.  Several format codes are usable for localization; they are placeholders that format dates with the appropriate codes for the user's locale.  These codes are: <tt class="computeroutput">%x, %X, %q, %Q, and %c.</tt></p><pre class="programlisting">set foo_date_pretty [lc_time_fmt $foo_date_ansi "%x %X"]</pre><p>
          Use the <tt class="computeroutput">_pretty</tt> version in your ADP page.
        </p><div class="itemizedlist"><ul type="disc"><li><p>
          %c: Long date and time (Mon November 18, 2002 12:00 AM)
        </p></li><li><p>
          %x: Short date (11/18/02)
        </p></li><li><p>
          %X: Time (12:00 AM)
        </p></li><li><p>
          %q: Long date without weekday (November 18, 2002)
        </p></li><li><p>
           %Q: Long date with weekday (Monday November 18, 2002)
        </p></li></ul></div><p>
      The "q" format strings are OpenACS additions; the rest follow unix standards (see <tt class="computeroutput">man
      strftime</tt>).
    </p></li></ol></div></li><li><p><b>Internationalize Numbers. </b>
            To internationalize numbers, use <tt class="computeroutput">lc_numeric $value</tt>, which formats the number using the appropriate decimal point and thousand separator for the locale.
          </p></li><li><p><b>Internationalizing Forms. </b>When coding forms, remember to use message keys for each piece of text that is user-visible, including form option labels and button labels.</p></li><li><p><a name="catalog-consistency-check"></a><b>Checking the Consistency of Catalog Files. </b>
        This section describes how to check that the set of keys used in
        message lookups in tcl, adp, and info files and the set of keys in
        the catalog file are identical.  The scripts below assume that
        message lookups in adp and info files are on the format
        \#package_key.message_key\#, and that message lookups in tcl files
        are always is done with one of the valid lookups described above. The script further assumes
        that you have perl installed and in your path.  Run the script like
        this:
      </p><tt class="computeroutput">
      acs-lang/bin/check-catalog.sh package_key
      </tt><p>
        where package_key is the key of the package that you want to
        test. If you don't provide the package_key argument then all
        packages with catalog files will be checked. 
        The script will run its checks primarily on en_US xml catalog files.
      </p></li></ol></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="i18n-introduction.html">Prev</a> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right"> <a accesskey="n" href="i18n-design.html">Next</a></td></tr><tr><td width="40%" align="left">How Internationalization/Localization works in OpenACS </td><td width="20%" align="center"><a accesskey="u" href="i18n.html">Up</a></td><td width="40%" align="right"> Design Notes</td></tr></table><hr><address><a href="mailto:docs@openacs.org">docs@openacs.org</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/i18n-convert.html#comments">View comments on this page at openacs.org</a></center></body></html>
