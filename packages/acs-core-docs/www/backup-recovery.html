<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Backup and Recovery</title><meta name="generator" content="DocBook XSL Stylesheets V1.62.4"><link rel="home" href="index.html" title="OpenACS Core Documentation"><link rel="up" href="maintenance.html" title="Chapter 6. Maintenance"><link rel="previous" href="database-management.html" title="Database Management"><link rel="next" href="install-redhat.html" title="Appendix A. Install Red Hat 8/9"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="/doc/images/alex.jpg" border="0" alt="Alex logo"></a><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="database-management.html">Prev</a> </td><th width="60%" align="center">Chapter 6. Maintenance</th><td width="20%" align="right"> <a accesskey="n" href="install-redhat.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="backup-recovery"></a>Backup and Recovery</h2></div></div><div></div></div><div class="authorblurb"><p>By <a href="mailto:dhogaza@pacifier.com" target="_top">Don Baccus</a> with additions
      by <a href="mailto:joel@aufrecht.org" target="_top">Joel Aufrecht</a></p>
          OpenACS docs are written by the named authors, and may be edited
          by OpenACS documentation staff.
        </div><p>We will cover some basic backup and recovery strategies.  These are intended to 
    be robust but simple enough to set up.  For a large scale production site you would 
    probably need to create your own backup strategies (in particular full dumps from 
    oracle, while easy to set up, are far from the best solution).
    </p><p>There are three basic things which need to be backed up, the database data, the server 
    source tree, and the acs-content-repository (which is in the server source tree).</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="install-next-backups"></a>Backup Strategy</h3></div></div><div></div></div><p>
      The purpose of backup is to enable recovery.  Backup and
      recovery are always risky; here are some steps that minimize the
      chance recovery is necessary:
    </p><div class="itemizedlist"><ul type="disc"><li><p>
      Store everything on a fault-tolerant disk array (RAID 1 or 5
      or better).
      </p></li><li><p>
      Use battery backup.
      </p></li><li><p>
      Use more reliable hardware, such as SCSI instead of IDE.
      </p></li></ul></div><p>These steps improve the chances of successful recovery:</p><div class="itemizedlist"><ul type="disc"><li><p>
      Store backups on a third disk on another controller
      </p></li><li><p>
      Store backups on a different computer on a different network
      in a different physical location.  (Compared to off-line
      backup such as tapes and CDRs, on-line backup is faster and
      more likely to succeed, but requires maintenance of another machine.)
      </p></li><li><p>
      Plan and configure for recovery from the beginning.
      </p></li><li><p>
      Test your recovery strategy from time to time.
      </p></li><li><p>
      Make it easy to maintain and test your recovery strategy, so
      that you are more likely to do it.
      </p></li></ul></div><p>
      OpenACS installations comprise files and database contents.
      If you follow the reference install and put all files,
      including configuration files, in
      <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/</tt>,
      and back up the database nightly to a file in
      <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup</tt>,
      then you can apply standard file-based backup strategies to
      <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span></tt>
    </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="snapshot-backup"></a>Manual backup and recovery</h3></div></div><div></div></div><p>This section describes how to make a one-time backup and
    restore of the files and database.  This is useful for rolling
    back to known-good versions of a service, such as at initial
    installation and just before an upgrade.  First, you back up the
    database to a file within the file tree.  Then, you back up the
    file tree.  All of the information needed to rebuild the site,
    including the AOLserver config files, is then in tree for regular
    file system backup.</p><div class="orderedlist"><ol type="1"><li><p><b>Back up the database to a file. </b></p><div class="itemizedlist"><ul type="disc"><li><p><a name="oracle-snapshot-backup"></a><b>Oracle. </b></p><div class="itemizedlist"><ul type="circle"><li><p> 
              Download the backup script. Save the file <a href="files/export-oracle.txt" target="_top">export-oracle.txt</a> as
              <tt class="filename">/tmp/export-oracle.txt</tt>
              </p></li><li><p>
              Login as root. The following commands will install the export script:
              </p><pre class="programlisting">[joeuser ~]$ <b class="userinput"><tt>su -</tt></b>
[root ~]# <b class="userinput"><tt>cp /tmp/export-oracle.txt /usr/sbin/export-oracle</tt></b>
[root ~]# <b class="userinput"><tt>chmod 700 /usr/sbin/export-oracle</tt></b></pre></li><li><p>
              Setup the export directory; this is the directory where backups will
              be stored. We recommend the directory
              <tt class="filename">/ora8/m02/oracle-exports</tt>.</p><pre class="programlisting">[root ~]# <b class="userinput"><tt>mkdir <span class="replaceable"><span class="replaceable">/ora8/m02/</span></span>oracle-exports</tt></b>
[root ~]# <b class="userinput"><tt>chown oracle:dba <span class="replaceable"><span class="replaceable">/ora8/m02/</span></span>oracle-exports</tt></b>
[root ~]# <b class="userinput"><tt>chmod 770 <span class="replaceable"><span class="replaceable">/ora8/m02/</span></span>oracle-exports</tt></b></pre></li><li><p> 
              Now edit
              <tt class="filename">/usr/sbin/export-oracle</tt> and
              change the <tt class="computeroutput">SERVICE_NAME</tt> and
              <tt class="computeroutput">DATABASE_PASSWORD</tt> fields to
              their correct values. If you want to use a directory other than
              <tt class="filename">/ora8/m02/oracle-exports</tt>, you
              also need to change the
              <tt class="computeroutput">exportdir</tt> setting.
              </p><p>
                Test the export procedure by running the command:
              </p><pre class="programlisting">[root ~]# <b class="userinput"><tt>/usr/sbin/export-oracle</tt></b>
mv: /ora8/m02/oracle-exports/oraexport-service_name.dmp.gz: No such file or directory

Export: Release 8.1.6.1.0 - Production on Sun Jun 11 18:07:45 2000

(c) Copyright 1999 Oracle Corporation.  All rights reserved.

Connected to: Oracle8i Enterprise Edition Release 8.1.6.1.0 - Production
With the Partitioning option
JServer Release 8.1.6.0.0 - Production
Export done in US7ASCII character set and US7ASCII NCHAR character set
  . exporting pre-schema procedural objects and actions
  . exporting foreign function library names for user SERVICE_NAME 
  . exporting object type definitions for user SERVICE_NAME 
  About to export SERVICE_NAME's objects ...
  . exporting database links
  . exporting sequence numbers
  . exporting cluster definitions
  . about to export SERVICE_NAME's tables via Conventional Path ...
  . exporting synonyms
  . exporting views
  . exporting stored procedures
  . exporting operators
  . exporting referential integrity constraints
  . exporting triggers
  . exporting indextypes
  . exporting bitmap, functional and extensible indexes
  . exporting posttables actions
  . exporting snapshots
  . exporting snapshot logs
  . exporting job queues
  . exporting refresh groups and children
  . exporting dimensions
  . exporting post-schema procedural objects and actions
  . exporting statistics
Export terminated successfully without warnings.</pre></li></ul></div></li><li><p><a name="postgres-snapshot-backup"></a><b>PostgreSQL. </b>Create a backup file and verify that it was created and has a reasonable size (several megabytes).</p><pre class="screen">[root root]# <b class="userinput"><tt>su - service0</tt></b>
[service0 service0]$ <b class="userinput"><tt>pg_dump -f /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup/before_upgrade_to_4.6.dmp <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 service0]$ <b class="userinput"><tt>ls -al /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup/before_upgrade_to_4.6.dmp </tt></b>
-rw-rw-r-x    1 service0  service0   4005995 Feb 21 18:28 /var/lib/aolserver/service0/database-backup/before_upgrade_to_4.6.dmp
[service0 service0]$ <b class="userinput"><tt>exit</tt></b>
[root root]#
<span class="action"><span class="action">su - service0
pg_dump -f /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup/before_upgrade_to_4.6.dmp <span class="replaceable"><span class="replaceable">openacs-dev</span></span>
ls -al /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup/before_upgrade_to_4.6.dmp
exit</span></span></pre></li></ul></div></li><li><a name="backup-file-system"></a><p><b>Back up the file system. </b>Back up all of the files in the service, including the
          database backup file but excluding the auto-generated
          <tt class="filename">supervise</tt> directory, which is
          unneccesary and has complicated permissions.  </p><p>In the tar command,</p><div class="itemizedlist"><ul type="disc"><li><p><tt class="computeroutput">c</tt> create a
            new tar archive</p></li><li><p><tt class="computeroutput">p</tt> preserves permissions.</p></li><li><p><tt class="computeroutput">s</tt> preserves file sort order</p></li><li><p><tt class="computeroutput">z</tt> compresses the output with gzip.</p></li><li><p>The <tt class="computeroutput">--exclude</tt> clauses skips some daemontools files that
            are owned by root and thus cannot be backed up by the
            service owner.  These files are autogenerated and we don't
            break anything by omitting them.</p></li><li><p>The <tt class="computeroutput">--file</tt> clause
            specifies the name of the output file to be generated; we
            manually add the correct extensions.</p></li><li><p>The last clause,
            <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/</tt>,
            specifies the starting point for backup.  Tar defaults to
            recursive backup.</p></li></ul></div><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 service0]$ <b class="userinput"><tt>tar -cpsz --exclude /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/daemontools/supervise \
   --file /tmp/<span class="replaceable"><span class="replaceable">service0</span></span>-backup.tar.gz /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/</tt></b>
tar: Removing leading `/' from member names
[service0 service0]$</pre></li><li><p><b>Suffer a catastrophic failure on your production system. </b>(We'll simulate this step)</p><pre class="screen">[root root]# <b class="userinput"><tt>svc -d /service/service0</tt></b>
[root root]# <b class="userinput"><tt>mv /var/lib/aolserver/service0/ /var/lib/aolserver/service0.lost</tt></b>
[root root]#<b class="userinput"><tt> rm /service/service0</tt></b>
rm: remove symbolic link `/service/service0'? y
[root root]# <b class="userinput"><tt>ps -auxw | grep service0</tt></b>
root      1496  0.0  0.0  1312  252 ?        S    16:58   0:00 supervise service0
[root root]#<b class="userinput"><tt> kill<span class="replaceable"><span class="replaceable"> 1496</span></span></tt></b>
[root root]# <b class="userinput"><tt>ps -auxw | grep service0</tt></b>
[root root]# <b class="userinput"><tt>su - postgres</tt></b>
[postgres pgsql]$ <b class="userinput"><tt>dropdb service0</tt></b>
DROP DATABASE
[postgres pgsql]$ <b class="userinput"><tt>dropuser service0</tt></b>
DROP USER
[postgres pgsql]$ <b class="userinput"><tt>exit</tt></b>
logout
[root root]#</pre></li><li><p><a name="recovery"></a><b>Recovery. </b></p><div class="orderedlist"><ol type="a"><li><p>Restore the operating system and required software.
            You can do this with standard backup processes or by
            keeping copies of the install material (OS CDs, OpenACS
            tarball and supporting software) and repeating the install
            guide.  Recreate the service user (<span class="replaceable"><span class="replaceable">service0</span></span>).</p></li><li><p>Restore the OpenACS files and database backup file.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 service0]$ <b class="userinput"><tt>cd /var/lib/aolserver</tt></b>
[service0 aolserver]$<b class="userinput"><tt> tar xzf /tmp/service0-backup.tar.gz</tt></b>
[service0 aolserver]$ <b class="userinput"><tt>chmod -R 775 <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 aolserver]$ <b class="userinput"><tt>chown -R <span class="replaceable"><span class="replaceable">service0.web</span></span> <span class="replaceable"><span class="replaceable">service0</span></span></tt></b></pre></li><li><p>Restore the database</p><div class="itemizedlist"><ul type="disc"><li><p><b>Oracle. </b></p><div class="orderedlist"><ol type="i"><li><p>Set up a clean Oracle database user and
                    tablespace with the same names as the ones exported from (<a href="openacs.html#install-openacs-prepare-oracle">more information</a>).</p></li><li><p>Invoke the import command</p><pre class="screen"><span class="action"><span class="action">imp <span class="replaceable"><span class="replaceable">service0</span></span>/<span class="replaceable"><span class="replaceable">service0</span></span> FILE=/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup/nighty_backup.dmp FULL=Y</span></span></pre></li></ol></div></li><li><p><a name="restore-postgres"></a><b>Postgres. </b>If the database user does not already exist, create it.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - postgres</tt></b>
[postgres ~]$ <b class="userinput"><tt>createuser <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
Shall the new user be allowed to create databases? (y/n) <b class="userinput"><tt>y</tt></b>
Shall the new user be allowed to create more new users? (y/n) <b class="userinput"><tt>y</tt></b>
CREATE USER
[postgres ~]$ <b class="userinput"><tt>exit</tt></b>
</pre><p>Because of a bug in Postgres backup-recovery, database objects are not guaranteed to be created in the right order.  In practice, running the OpenACS initialization script is always sufficient to create any out-of-order database objects.  Next, restore the database from the dump file.  The restoration will show some error messages at the beginning for objects that were pre-created from the OpenACS initialization script, which can be ignored.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 ~]$ <b class="userinput"><tt>createdb <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
CREATE DATABASE
[service0 ~]$<b class="userinput"><tt> psql -f /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/acs-kernel/sql/postgresql/postgresql.sql <span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
<span class="emphasis"><em>(many lines omitted)</em></span>
[service0 ~]$ <b class="userinput"><tt>psql <span class="replaceable"><span class="replaceable">service0</span></span> &lt; /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup/<span class="replaceable"><span class="replaceable">database-backup.dmp</span></span></tt></b>
<span class="emphasis"><em>(many lines omitted)</em></span>
[service0 ~]$ <b class="userinput"><tt>exit</tt></b>
[postgres ~]$ <b class="userinput"><tt>exit</tt></b>
logout</pre></li></ul></div></li><li><p>Activate the service</p><pre class="screen">[root root]# <b class="userinput"><tt>ln -s /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/daemontools /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[root root]# <b class="userinput"><tt>sleep 10</tt></b>
[root root]# <b class="userinput"><tt>svgroup web /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt></b></pre></li></ol></div></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="automated-backup"></a>Automated Backup (OPTIONAL)</h3></div></div><div></div></div><p>The recommended backup strategy for a production sit is to use an automated script which first backs up the database to a file in <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/database-backup</tt> and then backs up all of <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span></tt> to a single zip file, and then copies that zip file to another computer.</p><div class="orderedlist"><ol type="1"><li><p>Make sure that the manual backup process described above works.</p></li><li><p>Customize the default backup script.  Edit <tt class="filename">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/backup.sh</tt> with your specific parameters.</p></li><li><p>
        Make sure the file is executable:</p><pre class="programlisting">chmod +x backup.sh</pre></li><li><p>
        Set this file to run automatically by adding a line to root's crontab. (Typically, with <tt class="computeroutput">export EDITOR=emacs; crontab -e</tt>.)  This example runs the backup script at 1:30 am every day.</p><pre class="programlisting">30 1 * * * *        sh /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/backup.sh</pre></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="backups-with-cvs"></a>Using CVS for backup-recovery</h3></div></div><div></div></div><p>CVS-only backup is often appropriate for development sites.  If you are already using CVS and your data is not important, you probably don't
      need to do anything to back up your files.  Just make
      sure that your current work is checked into the system.
      You can then roll back based on date - note the
      current system time, down to the minute.  For maximum
      safety, you can apply a tag to your current
      files.  You will still need to back up your database.</p><p>  Note that, if you did the CVS options in this document, the <tt class="filename">/var/lib/aolserver/service0/etc</tt> directory is not included in cvs and you may want to add it.</p><pre class="screen">[root root]# <b class="userinput"><tt>su - service0</tt></b>
[service0 service0]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 service0]$ <b class="userinput"><tt>cvs commit -m "last-minute commits before upgrade to 4.6"</tt></b>
cvs commit: Examining .
cvs commit: Examining bin
<span class="emphasis"><em>(many lines omitted)</em></span>
[service0 service0]$ <b class="userinput"><tt>cvs tag before_upgrade_to_4_6</tt></b>
cvs server: Tagging bin
T bin/acs-4-0-publish.sh
T bin/ad-context-server.pl
(many lines omitted)
[service0 service0]$ <b class="userinput"><tt>exit</tt></b>
[root root]# 
<span class="action"><span class="action">su - service0
cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>
cvs commit -m "last-minute commits before upgrade to 4.6"
cvs tag before_upgrade_to_4_6
exit</span></span></pre><p>To restore files from a cvs tag such as the one used above:</p><pre class="screen">[root root]# <b class="userinput"><tt>su - service0</tt></b>
[service0 service0]$ <b class="userinput"><tt>cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[service0 service0]$ <b class="userinput"><tt>cvs up -r current</tt></b>
[service0 service0]$ <b class="userinput"><tt>exit</tt></b>
<span class="action"><span class="action">su - service0
cd /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>
cvs up -r current</span></span></pre></div><div class="cvstag">($Id$)</div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="database-management.html">Prev</a> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right"> <a accesskey="n" href="install-redhat.html">Next</a></td></tr><tr><td width="40%" align="left">Database Management </td><td width="20%" align="center"><a accesskey="u" href="maintenance.html">Up</a></td><td width="40%" align="right"> Appendix A. Install Red Hat 8/9</td></tr></table><hr><address><a href="mailto:docs@openacs.org">docs@openacs.org</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/backup-recovery.html#comments">View comments on this page at openacs.org</a></center></body></html>
