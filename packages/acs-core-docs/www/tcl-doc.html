<html xmlns:lxslt="http://xml.apache.org/xslt" xmlns:saxon="http://icl.com/saxon" xmlns:xalanredirect="org.apache.xalan.xslt.extensions.Redirect"><head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>18. Documenting Tcl Files: Page Contracts and Libraries</title><link rel="stylesheet" href="ad.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.24"><link rel="home" href="index.html" title="ACS Core"><link rel="up" href="kernel-doc.html" title="7. Kernel Documentation"><link rel="previous" href="db-api-detailed.html" title="17. Database Access API"><link rel="next" href="bootstrap-acs.html" title="19. Bootstrapping ACS"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><a href="http://www.openacs.org/"><img src="images/alex.jpg" border="0"></a><br><br><a class="topnav" href="/">Home</a><span class="topnav"> : </span><a class="topnav" href="index">Documentation</a><span class="topnav"> : </span><a class="topnav" href="acs-dev.html">Part III. For ACS Developers</a><span class="topnav"> : </span><a class="topnav" href="kernel-doc.html">7. Kernel Documentation</a><span class="topnav"> : </span><strong class="topnav">18. Documenting Tcl Files: Page Contracts and Libraries&nbsp;</strong><hr size="1" noshade><div id="tcl-doc" class="sect1"><div class="titlepage"><h2 class="title" style="clear: all"><a name="tcl-doc"></a><span class="label">18.</span> <span class="title">Documenting Tcl Files: Page Contracts and Libraries</span></h2></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt>18.1. <a href="tcl-doc.html#tcl-doc-bigpicture">The Big Picture</a></dt><dt>18.2. <a href="tcl-doc.html#tcl-doc-ad-page-contract">ad_page_contract</a></dt><dt>18.3. <a href="tcl-doc.html#tcl-doc-ad-library">ad_library</a></dt></dl></div><p><p>
by <a href="mailto:jsalz@mit.edu" target="_top">Jon Salz</a> on 3 July 2000 
</p></p><div class="itemizedlist"><ul><li><a name="N21054"></a><p>Tcl procedures: /packages/acs-kernel/tcl-documentation-procs.tcl</p></li></ul></div><div id="tcl-doc-bigpicture" class="sect2"><div class="titlepage"><h3 class="title"><a name="tcl-doc-bigpicture"></a><span class="label">18.1.</span> <span class="title">The Big Picture</span></h3></div><p>In versions of the ACS prior to 3.4, <a href="/doc/standards" target="_top">the standard
place</a> to document Tcl files (both Tcl pages and Tcl library files) was in
a comment at the top of the file:</p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>
#
# <i>path from server home</i>/<i>filename</i>
#
# <i>Brief description of the file's purpose</i>
#
# <i>author's email address</i>, <i>file creation date</i>
#
# <a href="http://www.loria.fr/~molli/cvs/doc/cvs_12.html#SEC93" target="_top">$Id$</a>
#
</pre></td></tr></table></blockquote><p>
In addition, the inputs expected by a Tcl page (i.e., form variables) would
be enumerated in a call to <tt>ad_page_variables</tt>, in effect,
documenting the page's argument list. 
</p><p>The problem with these practices is that the documentation is only
accessible by reading the source file itself. For this reason, ACS 3.4
introduces a new API for documenting Tcl files and, on top of that, a
web-based user interface for browsing the documentation:</p><div class="itemizedlist"><ul><li><a name="N21098"></a><p><strong><tt><a href="tcl-doc.html#tcl-doc-ad-page-contract">ad_page_contract</a></tt></strong>: Every Tcl page
has a <strong>contract</strong> that explicitly defines what inputs the page
expects (with more precision than <tt>ad_page_variables</tt>) and
incorporates metadata about the page (what used to live in the top-of-page
comment). Like <tt>ad_page_variables</tt>, <tt>ad_page_contract</tt>
also sets the specified variables in the context of the Tcl page.</p></li><li><a name="N21122"></a><p><strong><tt><a href="tcl-doc.html#tcl-doc-ad-library">ad_library</a></tt></strong>: To be
called at the top of every library file (i.e., all files in the
<tt>/tcl/</tt> directory under the server root and
<tt>*-procs.tcl</tt> files under <tt>/packages/</tt>).</p></li></ul></div><p>
This has the following benefits: 
</p><div class="itemizedlist"><ul><li><a name="N21146"></a><p>Facilitates automatic generation of human-readable documentation.</p></li><li><a name="N21149"></a><p>Promotes security, by introducing a standard and automated way to check
inputs to scripts for correctness.</p></li><li><a name="N21152"></a><p>Allows graphical designers to determine easily how to customize
sites' UIs, e.g., what properties are available in templates.</p></li><li><a name="N21155"></a><p>Allows the request processor to be intelligent: a script can specify in
its contract which type of abstract document it
returns, and the request processor can transform it automatically into
something useful to a particular user agent. (Don't worry about this for
now - it's not complete for ACS 3.4.)</p></li></ul></div></div><div id="tcl-doc-ad-page-contract" class="sect2"><div class="titlepage"><h3 class="title"><a name="tcl-doc-ad-page-contract"></a><span class="label">18.2.</span> <span class="title">ad_page_contract</span></h3></div><p>
Currently <tt>ad_page_contract</tt> serves mostly as a replacement for
<tt>ad_page_variables</tt>. Eventually, it will be integrated closely
with the documents API so that each script's contract will document
precisely the set of properties available to graphical designers in
templates. (Document API integration is subject to change, so we don't
decsribe it here yet; for now, you can just consider
<tt>ad_page_contract</tt> a newer, better, documented
<tt>ad_page_variables</tt>.) 
</p><p>Let's look at an example usage of <tt>ad_page_contract</tt>:</p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>

# /packages/acs-kernel/api-doc/www/package-view.tcl
ad_page_contract {
    version_id:integer
    public_p:optional
    kind
    { format "html" }
} {
    Shows APIs for a particular package.

    @param version_id the ID of the version whose API to view.
    @param public_p view only public APIs?
    @param kind view the type of API to view. One of &lt;code&gt;procs_files&lt;/code&gt;,
        &lt;code&gt;procs&lt;/code&gt;, &lt;code&gt;content&lt;/code&gt;, &lt;code&gt;types&lt;/code&gt;, or
        &lt;code&gt;gd&lt;/code&gt;.
    @param format the format for the documentation. One of &lt;code&gt;html&lt;/code&gt; or &lt;code&gt;xml&lt;/code&gt;.

    @author Jon Salz (jsalz@mit.edu)
    @creation-date 3 Jul 2000
    @cvs-id $Id$
}

</pre></td></tr></table></blockquote><p>
Note that: 
</p><div class="itemizedlist"><ul><li><a name="N21193"></a><p><strong>By convention, <tt>ad_page_contract</tt> should be preceded
by a comment line containing the file's path</strong>. The comment is on
line 1, and the contract starts on line 2.
</p></li><li><a name="N21202"></a><p><strong><tt>ad_page_contract</tt></strong>'s first argument is
the list of expected arguments from the HTTP query (<tt>version_id</tt>,
<tt>public_p</tt>, <tt>kind</tt>, and <tt>format</tt>). Like
<tt>ad_page_variables</tt>, <tt>ad_page_contract</tt> sets the
corresponding Tcl variables when the page is executed.
</p></li><li><a name="N21233"></a><p><strong>Arguments can have defaults</strong>, specified using the same
syntax as in the Tcl <tt>proc</tt> (a two-element list where the first
element is the parameter name and the second argument is the default value).

</p></li><li><a name="N21242"></a><p><strong>Arguments can have flags</strong>, specified by following the
name of the query argument with a colon and one or more of the following
strings (separated by commas): </p><div class="itemizedlist"><ul><li><a name="N21248"></a><p><strong><tt>optional</tt></strong>: the query argument doesn't
need to be provided; if it's not, the variable for that argument simply
won't be set. For instance, if I call the script above without a
<tt>public_p</tt> in the query, then in the page body <tt>[info exists
public_p]</tt> will return 0.
</p></li><li><a name="N21263"></a><p><strong><tt>integer</tt></strong>: the argument must be an integer
(<tt>ad_page_contract</tt> will fail and display and error if not). This
flag, like the next, is intended to prevent clients from fudging query
arguments to trick scripts into executing arbitrary SQL. 

</p></li><li><a name="N21274"></a><p><strong><tt>sql_identifier</tt></strong>: the argument must be a SQL
identifier (i.e., <tt>[string is wordchar $the_query_var]</tt> must
return true). 

</p></li><li><a name="N21285"></a><p><strong><tt>trim</tt></strong>: the argument will be [string
trim]'ed. 

</p></li><li><a name="N21292"></a><p><strong><tt>multiple</tt></strong>: the argument may be specified
arbitrarily many times in the query string, and the variable will be set to a
list of all those values (or an empty list if it's unspecified). This is
analogous to the <tt>-multiple-list</tt> flag to
<tt>ad_page_variables</tt>, and is useful for handling form input
generated by <tt>&lt;SELECT MULTIPLE&gt;</tt> tags and checkboxes. </p><p>For instance, if <tt>dest_user_id:multiple</tt> is specified in the
contract, and the query string is</p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>

?dest_user_id=913&amp;dest_user_id=891&amp;dest_user_id=9

</pre></td></tr></table></blockquote><p>
then <tt>$dest_user_id</tt> is set to <tt>[list 913 891 9]</tt>.


</p></li><li><a name="N21330"></a><p><strong><tt>array</tt></strong>: the argument may be specified
arbitrarily many times in the query string, with parameter names with
suffixes like <tt>_1</tt>, <tt>_2</tt>, <tt>_3</tt>, etc. The
variable is set to a list of all those values (or an empty list if none are
specified). </p><p>For instance, if <tt>dest_user_id:array</tt> is specified in the
contract, and the query string is</p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>

?dest_user_id_0=913&amp;dest_user_id_1=891&amp;dest_user_id_2=9

</pre></td></tr></table></blockquote><p>
then <tt>$dest_user_id</tt> is set to <tt>[list 913 891 9]</tt>.</p></li></ul></div></li><li><a name="N21368"></a><p><strong>You can provide structured, HTML-formatted documentation for your
contract</strong>. Note that format is derived heavily from Javadoc: a
general description of the script's functionality, followed optionally by
a series of named attributes tagged by at symbols (<tt>@</tt>). You are
encouraged to provide: 
</p><div class="itemizedlist"><ul><li><a name="N21378"></a><p>A description of the functionality of the page. If the description
contains more than one sentence, the first sentence should be a brief
summary. 

</p></li><li><a name="N21381"></a><p>A <strong><tt>@param</tt></strong> tag for each allowable query
argument. The format is </p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>

@param <i>parameter-name</i> <i>description...</i>

</pre></td></tr></table></blockquote></li><li><a name="N21398"></a><p>An <strong><tt>@author</tt></strong> tag for each author. Specify the
author's name, followed his or her email address in parentheses.</p></li><li><a name="N21406"></a><p>A <strong><tt>@creation-date</tt></strong> tag indicating when the
script was first created.</p></li><li><a name="N21414"></a><p>A <strong><tt>@cvs-id</tt></strong> tag containing the page's CVS
identification string. Just use <tt>$Id: tcl-documentation.html,v 1.2
2000/09/19 07:22:35 ron Exp $</tt> when creating the file, and CVS will
substitute an appropriate string when you check the file in.</p></li></ul></div><p>
 These <tt>@</tt> tags are optional, but highly recommended!</p></li></ul></div></div><div id="tcl-doc-ad-library" class="sect2"><div class="titlepage"><h3 class="title"><a name="tcl-doc-ad-library"></a><span class="label">18.3.</span> <span class="title">ad_library</span></h3></div><p>
<tt>ad_library</tt> provides a replacement for the informal documentation
(described above) found at the beginning of every Tcl page. Instead of: 
</p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>

# /packages/acs-kernel/00-proc-procs.tcl
#
# Routines for defining procedures and libraries of procedures (-procs.tcl files).
#
# jsalz@mit.edu, 7 Jun 2000
#
# $Id$

</pre></td></tr></table></blockquote><p>
you'll now write: 
</p><blockquote><table border="0" cellpadding="5" cellspacing="0"><tr><td class="codeblock"><pre>

# /packages/acs-kernel/00-proc-procs.tcl
ad_library {

    Routines for defining procedures and libraries of procedures (&lt;code&gt;-procs.tcl&lt;/code&gt;
    files).

    @creation-date 7 Jun 2000
    @author Jon Salz (jsalz@mit.edu)
    @cvs-id $Id$

}

</pre></td></tr></table></blockquote><p>
Note that format is derived heavily from Javadoc: a general description of
the script's functionality, followed optionally by a series of named
attributes tagged by at symbols (<tt>@</tt>). HTML formatting is allowed.
You are encouraged to provide: 
</p><div class="itemizedlist"><ul><li><a name="N21458"></a><p>An <strong><tt>@author</tt></strong> tag for each author. Specify the
author's name, followed his or her email address in parentheses.</p></li><li><a name="N21466"></a><p>A <strong><tt>@creation-date</tt></strong> tag indicating when the
script was first created.</p></li><li><a name="N21474"></a><p>A <strong><tt>@cvs-id</tt></strong> tag containing the page's CVS
identification string. Just use <tt>$Id: tcl-documentation.html,v 1.2
2000/09/19 07:22:35 ron Exp $</tt> when creating the file, and CVS will
substitute an appropriate string when you check the file in.</p></li></ul></div><p><div align="right" class="cvstag">($Id$)</div></p></div></div><div class="navfooter"><hr size="1" noshade><table width="100%"><tr><td width="40%" align="left"><a class="bottomnav" href="db-api-detailed.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a href="mailto:acs-docs@arsdigita.com"><address class="nav">acs-docs@arsdigita.com</address></a></td><td width="40%" align="right">&nbsp;<a class="bottomnav" href="bootstrap-acs.html">Next</a></td></tr></table></div></body></html>
