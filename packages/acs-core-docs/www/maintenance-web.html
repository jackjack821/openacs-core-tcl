<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type"><title>Hosting Web Sites</title><meta name="generator" content="DocBook XSL Stylesheets V1.50.0"><link rel="home" href="index.html" title="OpenACS Documentation"><link rel="up" href="maintenance.html" title="Chapter 7. Maintenance"><link rel="previous" href="maintenance.html" title="Chapter 7. Maintenance"><link rel="next" href="database-management.html" title="Database Management"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="images/alex.jpg" border="0"></a><center>4.6.x DRAFT IN PROGRESS</center><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="maintenance.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter 7. Maintenance</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="database-management.html">Next</a></td></tr></table><hr></div><div class="sect1"><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="maintenance-web"></a>Hosting Web Sites</h2></div></div><div class="authorblurb"><p>
    by <a href="mailto:joel@aufrecht.org" target="_top">Joel Aufrecht</a><br>
          OpenACS docs are written by the named authors, but may be edited
          by OpenACS documentation staff.
        </p></div><p>This section collection of maintenance
    tasks and alternate configurations for AOLserver.  This section has not yet been updated for 4.6.2</p><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="install-openacs-inittab"></a>AOLserver keepalive with inittab</h3></div></div><p>This is an alternative method for keeping the AOLserver
		process running.  The recommended method is to <a href="openacs.html#install-openacs-keepalive">run AOLserver
		supervised</a>.</p><p>
		This step should be completed as root. This can break every service
		on your machine, so proceed with caution.
	  </p><div class="itemizedlist"><ul type="disc"><li><p>
			There are 2 general steps to getting this working. 
		  </p><div class="orderedlist"><ol type="1"><li><p> 
				Install a script called
				<tt>restart-aolserver</tt>. This
				script doesn't actually restart AOLserver - it just kills
				it.  
			  </p></li><li><p>
				Ask the OS to restart our service whenever it's not
				running. We do this by adding a line to
				<tt>/etc/inittab</tt>.
			  </p></li></ol></div><p>
			Calling <tt>restart-aolserver</tt>
			kills our service. The OS notices that our service is not
			running, so it automatically restarts it. Thus, calling
			<tt>restart-aolserver</tt> effectively
			restarts our service.  
		  </p></li><li><p> 
			Copy this <a href="files/restart-aolserver.txt" target="_top">file</a> into
			<tt>/tmp/restart-aolserver.txt</tt>.
		  </p></li><li><p> 
			This script needs to be SUID-root, which means
			that the script will run as root. This is necessary to ensure
			that the AOLserver processes are killed regardless of who owns
			them. However the script should be executable by the
			<tt>web</tt> group to ensure that the
			users updating the web page can use the script, but that
			general system users cannot run the script. You also need to
			have Perl installed and also a symbolic link to it in
			<tt>/usr/local/bin</tt>. 
		  </p><pre class="programlisting">
joeuser:~$ su - 
Password: ***********
root:~# cp /tmp/restart-aolserver.txt /usr/local/bin/restart-aolserver
root:~# chown root.web /usr/local/bin/restart-aolserver
root:~# chmod 4750 /usr/local/bin/restart-aolserver
root:~# ln -s /usr/bin/perl /usr/local/bin/perl
root:~# exit</pre></li><li><p> 
			Test the <tt>restart-aolserver</tt>
			script. We'll first kill all running servers to clean the
			slate. Then, we'll start one server and use
			<tt>restart-aolserver</tt> to kill
			it. If it works, then there should be no more servers
			running. You should see the following lines. </p><pre class="programlisting">
joeuser:~$ killall nsd
nsd: no process killed
joeuser:~$ /usr/local/aolserver/bin/nsd-postgres -t ~/web/<span class="emphasis"><em>birdnotes</em></span>/nsd.tcl
joeuser:~$ restart-aolserver <span class="emphasis"><em>birdnotes</em></span>
Killing 23727 
joeuser:~$ killall nsd
nsd: no process killed</pre><p>
            The number 23727 indicates the process id(s) (PIDs) of the
            processes being killed. It is important that <span class="strong"><em>no processes are killed</em></span> by the second
            call to <tt>killall</tt>. If there are
            processes being killed, it means that the script is not
            working.</p></li><li><p> 
          Assuming that the <tt>restart-aolserver</tt>
          script worked, login as root and open
          <tt>/etc/inittab</tt> for
          editing. </p><pre class="programlisting">
joeuser:~$ su -
Password: ************
root:~# emacs -nw /etc/inittab</pre></li><li><p> 
            Copy this line into the bottom of the file as a template,
            making sure that the first field
            <tt>nss1</tt> is unique.
          </p><pre class="programlisting">
nss1:345:respawn:/usr/local/aolserver/bin/nsd-postgres -i -u nobody -g web -t /home/<span class="emphasis"><em>joeuser</em></span>/web/<span class="emphasis"><em>birdnotes</em></span>/nsd.tcl</pre></li><li><p>
            <span class="strong"><em>Important:</em></span> Make sure there is a
            newline at the end of the file. If there is not a newline at
            the end of the file, the system may suffer catastrophic
            failures.  
          </p></li><li><p>
            Still as root, enter the following command to re-initialize
            <tt>/etc/inittab</tt>. </p><pre class="programlisting">
root:~# killall nsd    
nsd: no process killed
root:~# /sbin/init q</pre></li><li><p> 
            See if it worked by running the
            <tt>restart-aolserver</tt> script
            again. </p><pre class="programlisting">
root:~# restart-aolserver <span class="emphasis"><em>birdnotes</em></span>
Killing 23750</pre></li></ul></div><p>
        If processes were killed, congratulations, your server is now
        automated for startup and shutdown. 
      </p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="install-openacs-port80"></a>Running AOLserver on Port 80</h3></div></div><p>If you want your webserver to be <tt>http://yourserver.com</tt>, it must run on port 80, the default HTTP port.  You set this in the <tt>config.tcl</tt> file.  You will need to start the service as
      <tt>root</tt>. If you follow the instructions
      above for <a href="openacs.html#install-openacs-keepalive">automating
      startup</a>, this will be taken care of, but if you ever start the
      server from the command line, be sure to <tt>su
      -</tt> first.
    </p><p>
      Port 80 is a <span class="emphasis"><em>privileged</em></span> port. Only certain users
      can claim it. When you start <tt>nsd</tt> as
      root, it obtains the port, and then changes to run as whatever user
      you specify in the server configuration file. This ensures a high
      level of security, as the server, once started, is not running as
      <tt>root</tt>. This mean that if someone was
      able to exploit your web server to execute a command on your server,
      they would not be able to gain <tt>root</tt>
      access.</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="install-next-add-server"></a>How to add a second server on a different port</h3></div></div><p>Starting another server is simply a matter of configuring another
    aolserver instance, creating another database and pointing this
    aolserver instance at a fresh copy of the OpenACS-4 code. We'll call
    our new server <span class="emphasis"><em>birdnotes-dev</em></span></p><div class="orderedlist"><ol type="1"><li><p>
          You can either copy your current OpenACS installation:
        </p><pre class="programlisting">
joeuser:~$ cp -r web/birdnotes web/birdnotes-dev</pre><p>
          Or Download the <a href="http://www.openacs.org/software" target="_top">OpenACS
          4 software</a> into <tt>/tmp</tt> again.
        </p><pre class="programlisting">
joeuser:~$ cd web
joeuser:~/web$ tar xzvf /tmp/openacs-4-5-release.tgz
joeuser:~/web$ mv openacs-4 birdnotes-dev</pre></li><li><p>
          Download another copy of <a href="files/openacs4.tcl.txt" target="_top"><tt>openacs4.tcl.txt</tt></a>
          into <tt>/tmp</tt>.  </p><pre class="programlisting">
joeuser:~/web$ cp /tmp/openacs4.tcl.txt ./<span class="emphasis"><em>birdnotes-dev</em></span>/nsd.tcl
joeuser:~/web$ chmod 600 <span class="emphasis"><em>birdnotes-dev</em></span>/nsd.tcl
joeuser:~/web$ emacs <span class="emphasis"><em>birdnotes-dev</em></span>/nsd.tcl</pre><p>Just like in <a href="openacs.html#install-openacs-configure-aol" title="Configure an AOLserver Service for OpenACS">the section called &#8220;Configure an AOLserver Service for OpenACS&#8221;</a>,
        you'll need to set the server parameters appropriately. Be sure to
        choose a different port than your original server and to set
        <tt>server</tt> to
        <span class="emphasis"><em>birdnotes-dev</em></span>.</p></li><li><p>

          Create a new database instance called
          <span class="emphasis"><em>birdnotes-dev</em></span>. Follow the instructions in
          <a href="openacs.html#install-openacs-prepare-oracle">Prepare Oracle for OpenACS</a> or <a href="openacs.html#install-openacs-prepare-postgres">Prepare PostgreSQL for OpenACS</a>.

        </p></li><li><p>
          Start your new server!
        </p><pre class="programlisting">
joeuser:~/web$ cd
joeuser:~/web$ /usr/local/aolserver/bin/nsd-postgres -t /home/joeuser/web/<span class="emphasis"><em>birdnotes-dev</em></span>/nsd.tcl</pre><p>
          Visit the site with a web browser (using the port that you set
          above). You should see the OpenACS installer. Once you install
          the OpenACS datamodel, you'll also need to add your new aolserver
          instance to <tt>/etc/inittab</tt> (or
          daemontools) so it restarts automatically.</p></li></ol></div></div><p><div class="cvstag">($Id$)</div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="maintenance.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="database-management.html">Next</a></td></tr><tr><td width="40%" align="left">Chapter 7. Maintenance&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="maintenance.html">Up</a></td><td width="40%" align="right">&nbsp;Database Management</td></tr></table><hr><address>rmello at fslc.usu.edu</address><address><a href="mailto:vinod@kurup.com">vinod@kurup.com</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/openacs-4/maintenance-web.html#comments">View comments on this page at openacs.org</a></center></body></html>
