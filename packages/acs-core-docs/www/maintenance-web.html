<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Running OpenACS in Production Environments</title><meta name="generator" content="DocBook XSL Stylesheets V1.64.1"><link rel="home" href="index.html" title="OpenACS Core Documentation"><link rel="up" href="maintenance.html" title="Chapter 6. Maintenance"><link rel="previous" href="maintenance.html" title="Chapter 6. Maintenance"><link rel="next" href="database-management.html" title="Database Management"><link rel="stylesheet" href="openacs.css" type="text/css"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><a href="http://openacs.org"><img src="/doc/images/alex.jpg" border="0" alt="Alex logo"></a><table width="100%" summary="Navigation header" border="0"><tr><td width="20%" align="left"><a accesskey="p" href="maintenance.html">Prev</a> </td><th width="60%" align="center">Chapter 6. Maintenance</th><td width="20%" align="right"> <a accesskey="n" href="database-management.html">Next</a></td></tr></table><hr></div><div class="sect1" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="maintenance-web"></a>Running OpenACS in Production Environments</h2></div></div><div></div></div><div class="authorblurb"><p>By <a href="mailto:joel@aufrecht.org" target="_top">Joel Aufrecht</a></p>
          OpenACS docs are written by the named authors, and may be edited
          by OpenACS documentation staff.
        </div><p>Maintenance tasks, optional software, and alternate configurations for AOLserver.</p><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="install-openacs-keepalive"></a>Starting and Stopping an OpenACS instance.</h3></div></div><div></div></div><p>The simplest way to start and stop and OpenACS site is to run the startup shell script provided, <tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/daemontools/run</tt>.  This runs as a regular task, and logs to the logfile.  To stop the site, kill the script.</p><p>A more stable way to run OpenACS is with a "keepalive" mechanism of some sort, so that whenever the server halts or is stopped for a reset, it restarts automatically.  This is recommended for development and production servers.</p><p>The Reference Platform uses Daemontools to control AOLserver.  A simpler method, using <tt class="computeroutput">init</tt>, is <a href="maintenance-web.html#install-openacs-inittab" title="AOLserver keepalive with inittab">here</a>.</p><div class="orderedlist"><ol type="1"><li><p>Daemontools must already be installed.  If not, <a href="install-daemontools.html" title="Install Daemontools (OPTIONAL)">install it</a>.</p></li><li><p>Each service controlled by daemontools must have a
        directory in <tt class="computeroutput">/service</tt>.  That
        directory must have a file called
        <tt class="computeroutput">run</tt>.  Daemontools then
        creates additional files and directories to track status and
        log.  A daemontools directory is included in the OpenACS
        tarball at
        <tt class="computeroutput">/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/daemontools</tt>.  To use it, first ill any existing AOLserver instances.  As root, link the <tt class="computeroutput">daemontools</tt> directory into the <tt class="computeroutput">/service</tt> directory.  Daemontools' <tt class="computeroutput">svscan</tt> process checks this directory every five seconds, and will quickly execute <tt class="computeroutput">run</tt>.</p><pre class="screen">[service0 etc]$ <b class="userinput"><tt>killall nsd</tt></b>
nsd: no process killed
[service0 etc]$ <b class="userinput"><tt>exit</tt></b>

[root root]# <b class="userinput"><tt>ln -s /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/daemontools/ /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt></b></pre><p>Verify that AOLserver is running.</p><pre class="screen">[root root]#<b class="userinput"><tt> ps -auxw | grep nsd</tt></b>
<span class="replaceable"><span class="replaceable">service0</span></span>   5562 14.2  6.2 22436 15952 ?       S    11:55   0:04 /usr/local/aolserver/bin/nsd -it /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/config.tcl -u serve
root      5582  0.0  0.2  3276  628 pts/0    S    11:55   0:00 grep nsd
[root root]#</pre></li><li><p>The user <span class="replaceable"><span class="replaceable">service0</span></span> can now control the service <span class="replaceable"><span class="replaceable">service0</span></span> with these commands:</p><div class="itemizedlist"><ul type="disc"><li><p>

            <tt class="computeroutput">svc -d /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt> -
            Bring the server down

          </p></li><li><p>

            <tt class="computeroutput">svc -u /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt> -
            Start the server up and leave it in keepalive mode.

          </p></li><li><p>

            <tt class="computeroutput">svc -o /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt> -
            Start the server up once. Do not restart it if it stops.

          </p></li><li><p>

            <tt class="computeroutput">svc -t /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt> -
            Stop and immediately restart the server.

          </p></li><li><p>
        
            <tt class="computeroutput">svc -k /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt> -
            Sends the server a KILL signal. This is like KILL -9. AOLserver
            exits immediately. If svc -t fails to fully kill AOLserver, use
            this option.  This does not take the server out of keepalive mode, so it should still bounce back up immediately.

          </p></li></ul></div></li><li><p>Install a script to automate the stopping and starting
          of AOLserver services via daemontools.  You can then restart a service via <tt class="computeroutput">restart-aolserver <span class="replaceable"><span class="replaceable">service0</span></span></tt></p><pre class="screen">[root root]# <b class="userinput"><tt>cp /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/packages/acs-core-docs/www/files/restart-aolserver-daemontools.txt /usr/local/bin/restart-aolserver</tt></b>
[root root]# <b class="userinput"><tt>chmod 755 /usr/local/bin/restart-aolserver</tt></b>
[root root]#</pre></li><li><p>
        At this point, these commands will work only for the
        <tt class="computeroutput">root</tt> user.  Grant permission for the <tt class="computeroutput">web</tt> group to use <tt class="computeroutput">svc</tt> commands on the <span class="emphasis"><em><span class="replaceable"><span class="replaceable">service0</span></span></em></span> server.</p><pre class="screen">[root root]# <b class="userinput"><tt>svgroup web /service/<span class="replaceable"><span class="replaceable">service0</span></span></tt></b>
[root root]#</pre></li><li><p>Verify that the controls work.  You may want to <tt class="computeroutput">tail -f /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/log/<span class="replaceable"><span class="replaceable">service0</span></span>-error.log</tt> in another window, so you can see what happens when you type these commands.
      </p><p>

        Most of this information comes from Tom Jackson's <a href="http://zmbh.com/daemontools-aolserver/aolserver+daemontools.html" target="_top">AOLserver+Daemontools
          Mini-HOWTO</a>.
</p></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="install-openacs-inittab"></a>AOLserver keepalive with inittab</h3></div></div><div></div></div><p>This is an alternative method for keeping the AOLserver
		process running.  The recommended method is to <a href="maintenance-web.html#install-openacs-keepalive" title="Starting and Stopping an OpenACS instance.">run AOLserver
		supervised</a>.</p><p>
		This step should be completed as root. This can break every service
		on your machine, so proceed with caution.
	  </p><div class="itemizedlist"><ul type="disc"><li><p>
			There are 2 general steps to getting this working. 
		  </p><div class="orderedlist"><ol type="1"><li><p> 
				Install a script called
				<tt class="computeroutput">restart-aolserver</tt>. This
				script doesn't actually restart AOLserver - it just kills
				it.  
			  </p></li><li><p>
				Ask the OS to restart our service whenever it's not
				running. We do this by adding a line to
				<tt class="computeroutput">/etc/inittab</tt>.
			  </p></li></ol></div><p>
			Calling <tt class="computeroutput">restart-aolserver</tt>
			kills our service. The OS notices that our service is not
			running, so it automatically restarts it. Thus, calling
			<tt class="computeroutput">restart-aolserver</tt> effectively
			restarts our service.  
		  </p></li><li><p> 
			Copy this <a href="files/restart-aolserver.txt" target="_top">file</a> into
			<tt class="computeroutput">/tmp/restart-aolserver.txt</tt>.
		  </p></li><li><p> 
			This script needs to be SUID-root, which means
			that the script will run as root. This is necessary to ensure
			that the AOLserver processes are killed regardless of who owns
			them. However the script should be executable by the
			<tt class="computeroutput">web</tt> group to ensure that the
			users updating the web page can use the script, but that
			general system users cannot run the script. You also need to
			have Perl installed and also a symbolic link to it in
			<tt class="computeroutput">/usr/local/bin</tt>. 
		  </p><pre class="programlisting">
[joeuser ~]$ su - 
Password: ***********
[root ~]# cp /tmp/restart-aolserver.txt /usr/local/bin/restart-aolserver
[root ~]# chown root.web /usr/local/bin/restart-aolserver
[root ~]# chmod 4750 /usr/local/bin/restart-aolserver
[root ~]# ln -s /usr/bin/perl /usr/local/bin/perl
[root ~]# exit</pre></li><li><p> 
			Test the <tt class="computeroutput">restart-aolserver</tt>
			script. We'll first kill all running servers to clean the
			slate. Then, we'll start one server and use
			<tt class="computeroutput">restart-aolserver</tt> to kill
			it. If it works, then there should be no more servers
			running. You should see the following lines. </p><pre class="programlisting">
[joeuser ~]$ killall nsd
nsd: no process killed
[joeuser ~]$ /usr/local/aolserver/bin/nsd-postgres -t ~/var/lib/aolserver/<span class="emphasis"><em>birdnotes</em></span>/nsd.tcl
[joeuser ~]$ restart-aolserver <span class="emphasis"><em>birdnotes</em></span>
Killing 23727 
[joeuser ~]$ killall nsd
nsd: no process killed</pre><p>
            The number 23727 indicates the process id(s) (PIDs) of the
            processes being killed. It is important that <span class="strong">no processes are killed</span> by the second
            call to <tt class="computeroutput">killall</tt>. If there are
            processes being killed, it means that the script is not
            working.</p></li><li><p> 
          Assuming that the <tt class="computeroutput">restart-aolserver</tt>
          script worked, login as root and open
          <tt class="computeroutput">/etc/inittab</tt> for
          editing. </p><pre class="programlisting">
[joeuser ~]$ su -
Password: ************
[root ~]# emacs -nw /etc/inittab</pre></li><li><p> 
            Copy this line into the bottom of the file as a template,
            making sure that the first field
            <tt class="computeroutput">nss1</tt> is unique.
          </p><pre class="programlisting">
nss1:345:respawn:/usr/local/aolserver/bin/nsd-postgres -i -u nobody -g web -t /home/<span class="emphasis"><em>joeuser</em></span>/var/lib/aolserver/<span class="emphasis"><em>birdnotes</em></span>/nsd.tcl</pre></li><li><p>
            <span class="strong">Important:</span> Make sure there is a
            newline at the end of the file. If there is not a newline at
            the end of the file, the system may suffer catastrophic
            failures.  
          </p></li><li><p>
            Still as root, enter the following command to re-initialize
            <tt class="computeroutput">/etc/inittab</tt>. </p><pre class="programlisting">
[root ~]# killall nsd    
nsd: no process killed
[root ~]# /sbin/init q</pre></li><li><p> 
            See if it worked by running the
            <tt class="computeroutput">restart-aolserver</tt> script
            again. </p><pre class="programlisting">
[root ~]# restart-aolserver <span class="emphasis"><em>birdnotes</em></span>
Killing 23750</pre></li></ul></div><p>
        If processes were killed, congratulations, your server is now
        automated for startup and shutdown. 
      </p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="install-openacs-port80"></a>Running AOLserver on Port 80</h3></div></div><div></div></div><p>If you want your webserver to be <tt class="computeroutput">http://yourserver.com</tt>, it must run on port 80, the default HTTP port.  You set this in the <tt class="computeroutput">config.tcl</tt> file.  You will need to start the service as
      <tt class="computeroutput">root</tt>. If you follow the instructions
      above for <a href="maintenance-web.html#install-openacs-keepalive" title="Starting and Stopping an OpenACS instance.">automating
      startup</a>, this will be taken care of, but if you ever start the
      server from the command line, be sure to <tt class="computeroutput">su
      -</tt> first.
    </p><p>
      Port 80 is a <span class="emphasis"><em>privileged</em></span> port. Only certain users
      can claim it. When you start <tt class="computeroutput">nsd</tt> as
      root, it obtains the port, and then changes to run as whatever user
      you specify in the server configuration file. This ensures a high
      level of security, as the server, once started, is not running as
      <tt class="computeroutput">root</tt>. This mean that if someone was
      able to exploit your web server to execute a command on your server,
      they would not be able to gain <tt class="computeroutput">root</tt>
      access.</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="install-next-add-server"></a>Running multiple services on one machine</h3></div></div><div></div></div><p><b>Services on different ports. </b>To run a different service on another port but the same
        ip, simply repeat <a href="openacs.html">Install OpenACS 5.0.1d1</a> replacing
        <span class="replaceable"><span class="replaceable">service0</span></span>, and change the
</p><pre class="programlisting">set httpport              8000
set httpsport             8443 </pre><p>
 to different values.</p><p><b>Services on different host names. </b>For example, suppose you want to support
<tt class="computeroutput">http://foo.com</tt> and
    <tt class="computeroutput">http://bar.com</tt> on the same
    machine.  The easiest way is to assign each one a different ip
    address.  Then you can install two services as above, but with
        different values for
</p><pre class="programlisting">set hostname               [ns_info hostname]
set address                127.0.0.1 </pre><p>
</p><p>If you want to install two services with different host
    names sharing the same ip, you'll need nsvhr to redirect requests
    based on the contents of the tcp headers.  See <a href="http://borkware.com/rants/aolserver-vhosting/" target="_top">AOLserver
    Virtual Hosting with TCP</a> by <a href="mailto:markd@borkware.com" target="_top">markd</a>.
</p></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="install-ssl"></a>Installing SSL Support</h3></div></div><div></div></div><p>nsopenssl is an open-sounce module for AOLserver which
        adds support for the ssl encryption layer.  To use it, you
        must <a href="install-nsopenssl.html" title="Install nsopenssl">install</a> the software, create or purchase certificates,
        and configure your OpenACS instance to use it.</p><div class="orderedlist"><ol type="1"><li><p>Uncomment this line from <tt class="computeroutput">config.tcl</tt>.</p><pre class="programlisting">#ns_param   nsopenssl       ${bindir}/nsopenssl.so
</pre></li><li><p><a name="ssl-certificates"></a>Prepare a certificate directory for the service.</p><pre class="screen">[service0 etc]$ <b class="userinput"><tt>mkdir /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/certs</tt></b>
[service0 etc]$ <b class="userinput"><tt>chmod 700 /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/certs</tt></b>
[service0 etc]$ 
<span class="action"><span class="action">mkdir /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/certs
chmod 700 /var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/certs</span></span></pre></li><li><p>It takes two files to support an SSL connection.  The certificate is the public half of the key pair - the server sends the certificate to browser requesting ssl.  The key is the private half of the key pair.  In addition, the certificate must be signed by Certificate Authority or browsers will protest.  Each web browser ships with a built-in list of acceptable Certificate Authorities (CAs) and their keys.  Only a site certificate signed by a known and approved CA will work smoothly.  Any other certificate will cause browsers to produce some messages or block the site.  Unfortunately, getting a site certificate signed by a CA costs money.  In this section, we'll generate an unsigned certificate which will work in most browsers, albeit with pop-up messages.</p><p>Use an OpenSSL perl script to generate a certificate and key.</p><pre class="screen">[service0 service0]$ <b class="userinput"><tt>cd /var/lib/aolserver/service0/etc/certs</tt></b>
[service0 certs]$ <b class="userinput"><tt>perl /usr/share/ssl/misc/CA -newcert</tt></b>
Using configuration from /usr/share/ssl/openssl.cnf
Generating a 1024 bit RSA private key
...++++++
.......++++++
writing new private key to 'newreq.pem'
Enter PEM pass phrase:</pre><p>Enter a pass phrase for the CA certificate.  Then, answer the rest of the questions.  At the end you should see this:</p><pre class="screen">Certificate (and private key) is in newreq.pem
[service0 certs]$</pre><p><tt class="computeroutput">newreq.pem</tt> contains our certificate and private key.  The key is protected by a passphrase, which means that we'll have to enter the pass phrase each time the server starts.  This is impractical and unnecessary, so we create an unprotected version of the key.  <span class="emphasis"><em>Security implication</em></span>: if anyone gets access to the file keyfile.pem, they effectively own the key as much as you do.  Mitigation: don't use this key/cert combo for anything besides providing ssl for the web site.</p><pre class="screen">[root misc]# <b class="userinput"><tt>openssl rsa -in newreq.pem -out keyfile.pem</tt></b>
read RSA key
Enter PEM pass phrase:
writing RSA key
[service0 certs]$ </pre><p>To create the certificate file, we take the combined file, copy it, and strip out the key.</p><pre class="screen">[service0 certs]$ <b class="userinput"><tt>cp newreq.pem certfile.pem</tt></b>
[root misc]# <b class="userinput"><tt>emacs certfile.pem</tt></b></pre><p>Strip out the section that looks like</p><pre class="programlisting">-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: DES-EDE3-CBC,F3EDE7CA1B404997
S/Sd2MYA0JVmQuIt5bYowXR1KYKDka1d3DUgtoVTiFepIRUrMkZlCli08mWVjE6T
<span class="emphasis"><em>(11 lines omitted)</em></span>
1MU24SHLgdTfDJprEdxZOnxajnbxL420xNVc5RRXlJA8Xxhx/HBKTw==
-----END RSA PRIVATE KEY-----</pre></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="analog-setup"></a>Set up Log Analysis Reports - OPTIONAL</h3></div></div><div></div></div><p>Analog is a program with processes webserver access logs,
      performs DNS lookup, and outputs HTML reports.  Analog should
      <a href="analog-install.html" title="Install Analog web file analyzer">already be
      installed.</a>  A modified configuration file is included in
      the OpenACS tarball.</p><div class="orderedlist"><ol type="1"><li><pre class="screen">[root src]# <b class="userinput"><tt>su - service0</tt></b>
[service0 service0]$ <b class="userinput"><tt>cd /var/lib/aolserver/service0</tt></b>
[service0 service0]$ <b class="userinput"><tt>cp /var/lib/aolserver/service0/packages/acs-core-docs/www/files/analog.cfg.txt etc/analog.cfg</tt></b>
[service0 service0]$ <b class="userinput"><tt>mkdir www/log</tt></b>
[service0 service0]$ <b class="userinput"><tt>cp -r /usr/share/analog-5.31/images www/log/</tt></b>
[service0 service0]$ <span class="action"><span class="action">
su - service0
cd /var/lib/aolserver/service0
cp /var/lib/aolserver/service0/packages/acs-core-docs/www/files/analog.cfg.txt etc/analog.cfg
mkdir www/log
cp -r /usr/share/analog-5.31/images www/log/</span></span></pre><p>Edit
<tt class="computeroutput">/var/lib/aolserver/service0/etc/analog.cfg</tt> and change the variable in <tt class="computeroutput">HOSTNAME "[my
organisation]"</tt> to reflect your website title.  If you
don't want the traffic log to be publicly visible, change
<tt class="computeroutput">OUTFILE /var/lib/aolserver/service0/www/log/traffic.html</tt> to use a private
directory.</p></li><li><p>Run it.</p><pre class="screen">[service0 service0]$ <b class="userinput"><tt>/usr/share/analog-5.31/analog -G -g/var/lib/aolserver/service0/etc/analog.cfg</tt></b>
/usr/share/analog-5.31/analog: analog version 5.31/Unix
/usr/share/analog-5.31/analog: Warning F: Failed to open DNS input file
  /home/service0/dnscache: ignoring it
  (For help on all errors and warnings, see docs/errors.html)
/usr/share/analog-5.31/analog: Warning R: Turning off empty Search Word Report
[service0 service0]$</pre><p>Verify that it works by browing to <tt class="computeroutput">http://yourserver.test:8000/log/traffic.html</tt></p></li><li><p>Automate this by creating a file in
          <tt class="computeroutput">/etc/cron.daily</tt>.</p><pre class="screen">[service0 service0]$ <b class="userinput"><tt>exit</tt></b>
logout

[root root]# <b class="userinput"><tt>emacs /etc/cron.daily/analog</tt></b></pre><p>Put this into the file:</p><pre class="programlisting">#!/bin/sh

/usr/share/analog-5.31/analog -G -g/var/lib/aolserver/<span class="replaceable"><span class="replaceable">service0</span></span>/etc/analog.cfg</pre><pre class="screen">[root root]# <b class="userinput"><tt>chmod 755 /etc/cron.daily/analog</tt></b></pre><p>Test it by running the script.</p><pre class="screen">[root root]# <b class="userinput"><tt>sh /etc/cron.daily/analog</tt></b></pre><p>Browse to <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver.test</span></span>/log/traffic.html</tt></p></li></ol></div></div><div class="sect2" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="uptime"></a>External uptime validation</h3></div></div><div></div></div><p>The <a href="http://uptime.openacs.org/uptime/" target="_top">OpenACS uptime site</a> can monitor your site and send you an email whenever your site fails to respond.  If you test the url <tt class="computeroutput">http://<span class="replaceable"><span class="replaceable">yourserver.test</span></span>/SYSTEM/dbtest.tcl</tt>, you should get back the string <tt class="computeroutput">success</tt>.</p><div class="cvstag">($Id$)</div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="maintenance.html">Prev</a> </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right"> <a accesskey="n" href="database-management.html">Next</a></td></tr><tr><td width="40%" align="left">Chapter 6. Maintenance </td><td width="20%" align="center"><a accesskey="u" href="maintenance.html">Up</a></td><td width="40%" align="right"> Database Management</td></tr></table><hr><address><a href="mailto:docs@openacs.org">docs@openacs.org</a></address></div><a name="comments"></a><center><a href="http://openacs.org/doc/maintenance-web.html#comments">View comments on this page at openacs.org</a></center></body></html>
