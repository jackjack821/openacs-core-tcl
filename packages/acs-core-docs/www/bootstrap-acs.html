<html xmlns:lxslt="http://xml.apache.org/xslt" xmlns:saxon="http://icl.com/saxon" xmlns:xalanredirect="org.apache.xalan.xslt.extensions.Redirect"><head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>19. Bootstrapping ACS</title><link rel="stylesheet" href="ad.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.24"><link rel="home" href="index.html" title="ACS Core"><link rel="up" href="kernel-doc.html" title="7. Kernel Documentation"><link rel="previous" href="tcl-doc.html" title="18. Documenting Tcl Files: Page Contracts and Libraries"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><a href="http://www.openacs.org/"><img src="images/alex.jpg" border="0"></a><br><br><a class="topnav" href="/">Home</a><span class="topnav"> : </span><a class="topnav" href="index">Documentation</a><span class="topnav"> : </span><a class="topnav" href="acs-dev.html">Part III. For ACS Developers</a><span class="topnav"> : </span><a class="topnav" href="kernel-doc.html">7. Kernel Documentation</a><span class="topnav"> : </span><strong class="topnav">19. Bootstrapping ACS&nbsp;</strong><hr size="1" noshade><div id="bootstrap-acs" class="sect1"><div class="titlepage"><h2 class="title" style="clear: all"><a name="bootstrap-acs"></a><span class="label">19.</span> <span class="title">Bootstrapping ACS</span></h2></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt>19.1. <a href="bootstrap-acs.html#bootstrap-acs-bigpicture">The Big Picture</a></dt><dt>19.2. <a href="bootstrap-acs.html#bootstrap-acs-startup-process">The Startup Process</a></dt></dl></div><p><p>
by <a href="mailto:jsalz@mit.edu" target="_top">Jon Salz</a> 
</p></p><div class="itemizedlist"><ul><li><a name="N21503"></a><p>Tcl code: /tcl/0-acs-init.tcl and /packages/acs-kernel/bootstrap.tcl</p></li></ul></div><p>This document describes the startup (bootstrapping) process for an AOLserver
running ACS. 
</p><div id="bootstrap-acs-bigpicture" class="sect2"><div class="titlepage"><h3 class="title"><a name="bootstrap-acs-bigpicture"></a><span class="label">19.1.</span> <span class="title">The Big Picture</span></h3></div><p>
Before ACS 3.3, the ACS startup process was extremely simple: after AOLserver
performed its internal initialization (reading the configuration file,
loading shared libraries and module code, etc.) it scanned through the Tcl
library directory (generally <tt>/web/</tt><i><tt>yourservername</tt></i><tt>/tcl</tt>),
sourcing each file in sequence. 
</p><p>While this overall structure for initialization is still intact, package
management has thrown a wrench into the works - there are a few extra things
to do during initialization, most notably:</p><div class="itemizedlist"><ul><li><a name="N21528"></a><p>Examine the ACS file tree for files that should not be present in ACS
(i.e., that were once part of the ACS distribution but have since been
removed).</p></li><li><a name="N21531"></a><p>Scan the <tt>/packages</tt> directory for new packages.</p></li><li><a name="N21538"></a><p>Initialize enabled packages by sourcing their <tt>*-procs.tcl</tt>
and <tt>*-init.tcl</tt> files.</p></li></ul></div><p>
This document examines in detail each of the steps involved in AOLserver/ACS
startup. 
</p></div><div id="bootstrap-acs-startup-process" class="sect2"><div class="titlepage"><h3 class="title"><a name="bootstrap-acs-startup-process"></a><span class="label">19.2.</span> <span class="title">The Startup Process</span></h3></div><p>
As soon as the <tt>nsd</tt> daemon is executed by the <tt>init</tt>
process (or otherwise), AOLserver reads its configuration file and
<tt>chroot</tt>s itself if necessary. It then loads shared libraries
indicated in the <tt>.ini</tt> file (e.g., the Oracle driver and
<tt>nssock</tt>), and sources Tcl module files (generally in
<tt>/home/aol30/modules/tcl</tt>). This step is, and has always been, the
same for all AOLservers, regardless of whether they are running ACS. 
</p><p>Next AOLserver sources, in lexicographical order, each file in the
<tt>/tcl</tt> directory. The first such file is
<tt>0-acs-init.tcl</tt>, which doesn't do much directly except to
determine the ACS path root (e.g., <tt>/web/</tt><i><tt>yourservername</tt></i>)
by trimming the final component from the path to the Tcl library directory
(<tt>/web/</tt><i><tt>yourservername</tt></i><tt>/tcl</tt>). But
<tt>0-acs-init.tcl</tt>'s has an important function, namely sourcing
<tt>/packages/acs-core/bootstrap.tcl</tt>, which does the following:</p><div class="orderedlist"><ol type="1"><li><a name="N21621"></a><p><strong>Initialize some NSVs used by the core</strong>. These NSVs are
documented in <tt>/packages/acs-core/apm-procs.tcl</tt> - no need to
worry about them unless you're an ACS core hacker. 

</p></li><li><a name="N21630"></a><p><strong>Verify the deletion of obsolete ACS files</strong>. The
<tt>/tcl</tt> directory has evolved quite a bit over the months and
years, and a few files have come and gone. The
<tt>/www/doc/removed-files.txt</tt> file contains a list of files which
<i>must be deleted</i> from the AOLserver installation, at the risk of
causing weird conflicts, e.g., having several security filters registered.
<tt>bootstrap.tcl</tt> scans through this list, logging error messages to
the log if any of these files exist. 

</p></li><li><a name="N21650"></a><p><strong>Source <tt>*-procs.tcl</tt> files in the ACS core</strong>.
We source each file matching the <tt>*-procs.tcl</tt> glob in the
<tt>/packages/acs-kernel</tt> directory, in lexicographical order. These
procedure are needed to perform any of the following steps. 

</p></li><li><a name="N21667"></a><p><strong>Ensure that the database is available</strong> by grabbing and
releasing a handle. If we can't obtain a handle, we terminate
initialization (since ACS couldn't possibly start up the server without
access to the database). 

</p></li><li><a name="N21672"></a><p><strong>Register any new packages in the <tt>/packages</tt>
directory</strong>. In each directory inside <tt>/packages</tt>, we look
for a <tt>.info</tt> file; if we find a package that hasn't yet been
registered with the package manager (i.e., it's been copied there
manually), we insert information about it into the database. (The first time
ACS starts up, <i>no</i> packages will have been registered in the database
yet, so this step will registers every single package in the
<tt>/packages</tt> directory.) Note that packages discovered here are
initially disabled; they must be manually enabled in the package manager
before they can be used. 

</p></li><li><a name="N21696"></a><p><strong>Ensure that the <tt>acs-kernel</tt> package is
enabled</strong>. If the ACS core isn't initialized, the server
couldn't possibly be operational, so if there's no enabled version of
the ACS core we simply mark the latest installed one as enabled. 

</p></li><li><a name="N21705"></a><p><strong>Load <tt>*-procs.tcl</tt> files for enabled
packages</strong>, activating their APIs. 

</p></li><li><a name="N21714"></a><p><strong>Load <tt>*-init.tcl</tt> files for enabled packages</strong>,
giving packages a chance to register filters and procedures, initialize data
structures, etc. 

</p></li><li><a name="N21723"></a><p><strong>Verify that the core has been properly initialized</strong> by
checking for the existence of an NSV created by the request processor
initialization code. If it's not present, the server won't be
operational, so we log an error.</p></li></ol></div><p>
At this point, <tt>bootstrap.tcl</tt> is done executing. AOLserver
proceeds to source the remaining files in the <tt>/tcl</tt> directory
(i.e., unpackaged libraries) and begins listening for connections. 
</p><p><div align="right" class="cvstag">($Id$)</div></p></div></div><div class="navfooter"><hr size="1" noshade><table width="100%"><tr><td width="40%" align="left"><a class="bottomnav" href="tcl-doc.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a href="mailto:acs-docs@arsdigita.com"><address class="nav">acs-docs@arsdigita.com</address></a></td><td width="40%" align="right">&nbsp;</td></tr></table></div></body></html>
