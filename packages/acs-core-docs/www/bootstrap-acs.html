<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Bootstrapping OpenACS</title>
<meta name="generator" content="DocBook XSL Stylesheets V1.45">
<link rel="home" href="index.html" title="OpenACS Documentation">
<link rel="up" href="kernel-doc.html" title="Chapter 7. Kernel Documentation">
<link rel="previous" href="tcl-doc.html" title="Documenting Tcl Files: Page Contracts and Libraries">
<link rel="stylesheet" href="openacs.css" type="text/css">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<a href="http://openacs.org"><img src="images/alex.jpg" border="0"></a><table width="100%" summary="Navigation header" border="0"><tr>
<td width="20%" align="left">
<a accesskey="p" href="tcl-doc.html">Prev</a> </td>
<th width="60%" align="center">Chapter 7. Kernel Documentation</th>
<td width="20%" align="right"> </td>
</tr></table>
<hr>
</div>
<div class="sect1">
<div class="titlepage"><div><h2 class="title" style="clear: both">
<a name="bootstrap-acs"></a>Bootstrapping OpenACS</h2></div></div>
<div class="authorblurb"><p>
by <a href="mailto:jsalz@mit.edu" target="_top">Jon Salz</a> 
</p></div>
<div class="itemizedlist"><ul><li><p>Tcl code: /tcl/0-acs-init.tcl and /packages/acs-kernel/bootstrap.tcl</p></li></ul></div>
<p>This document describes the startup (bootstrapping) process for an AOLserver
running OpenACS. 
</p>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="bootstrap-acs-bigpicture"></a>The Big Picture</h3></div></div>
<p>
Before OpenACS 3.3, the OpenACS startup process was extremely simple: after AOLserver
performed its internal initialization (reading the configuration file,
loading shared libraries and module code, etc.) it scanned through the Tcl
library directory (generally <tt>/web/</tt><span class="emphasis"><i><tt>yourservername</tt></i></span><tt>/tcl</tt>),
sourcing each file in sequence. 
</p>
<p>While this overall structure for initialization is still intact, package
management has thrown a wrench into the works - there are a few extra things
to do during initialization, most notably:</p>
<div class="itemizedlist"><ul>
<li><p>Examine the OpenACS file tree for files that should not be present in OpenACS
(i.e., that were once part of the OpenACS distribution but have since been
removed).</p></li>
<li><p>Scan the <tt>/packages</tt> directory for new packages.</p></li>
<li><p>Initialize enabled packages by sourcing their <tt>*-procs.tcl</tt>
and <tt>*-init.tcl</tt> files.</p></li>
</ul></div>
<p>
This document examines in detail each of the steps involved in AOLserver/OpenACS
startup. 
</p>
</div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="bootstrap-acs-startup-process"></a>The Startup Process</h3></div></div>
<p>
As soon as the <tt>nsd</tt> daemon is executed by the <tt>init</tt>
process (or otherwise), AOLserver reads its configuration file and
<tt>chroot</tt>s itself if necessary. It then loads shared libraries
indicated in the <tt>.ini</tt> file (e.g., the Oracle driver and
<tt>nssock</tt>), and sources Tcl module files (generally in
<tt>/home/aol30/modules/tcl</tt>). This step is, and has always been, the
same for all AOLservers, regardless of whether they are running OpenACS. 
</p>
<p>Next AOLserver sources, in lexicographical order, each file in the
<tt>/tcl</tt> directory. The first such file is
<tt>0-acs-init.tcl</tt>, which doesn't do much directly except to
determine the OpenACS path root (e.g., <tt>/web/</tt><span class="emphasis"><i><tt>yourservername</tt></i></span>)
by trimming the final component from the path to the Tcl library directory
(<tt>/web/</tt><span class="emphasis"><i><tt>yourservername</tt></i></span><tt>/tcl</tt>). But
<tt>0-acs-init.tcl</tt>'s has an important function, namely sourcing
<tt>/packages/acs-core/bootstrap.tcl</tt>, which does the following:</p>
<div class="orderedlist"><ol type="1">
<li><p>
<span class="strong"><i>Initialize some NSVs used by the core</i></span>. These NSVs are
documented in <tt>/packages/acs-core/apm-procs.tcl</tt> - no need to
worry about them unless you're an OpenACS core hacker. 

</p></li>
<li><p>
<span class="strong"><i>Verify the deletion of obsolete OpenACS files</i></span>. The
<tt>/tcl</tt> directory has evolved quite a bit over the months and
years, and a few files have come and gone. The
<tt>/www/doc/removed-files.txt</tt> file contains a list of files which
<span class="emphasis"><i>must be deleted</i></span> from the AOLserver installation, at the risk of
causing weird conflicts, e.g., having several security filters registered.
<tt>bootstrap.tcl</tt> scans through this list, logging error messages to
the log if any of these files exist. 

</p></li>
<li><p>
<span class="strong"><i>Source <tt>*-procs.tcl</tt> files in the OpenACS core</i></span>.
We source each file matching the <tt>*-procs.tcl</tt> glob in the
<tt>/packages/acs-kernel</tt> directory, in lexicographical order. These
procedure are needed to perform any of the following steps. 

</p></li>
<li><p>
<span class="strong"><i>Ensure that the database is available</i></span> by grabbing and
releasing a handle. If we can't obtain a handle, we terminate
initialization (since OpenACS couldn't possibly start up the server without
access to the database). 

</p></li>
<li><p>
<span class="strong"><i>Register any new packages in the <tt>/packages</tt>
directory</i></span>. In each directory inside <tt>/packages</tt>, we look
for a <tt>.info</tt> file; if we find a package that hasn't yet been
registered with the package manager (i.e., it's been copied there
manually), we insert information about it into the database. (The first time
OpenACS starts up, <span class="emphasis"><i>no</i></span> packages will have been registered in the database
yet, so this step will registers every single package in the
<tt>/packages</tt> directory.) Note that packages discovered here are
initially disabled; they must be manually enabled in the package manager
before they can be used. 

</p></li>
<li><p>
<span class="strong"><i>Ensure that the <tt>acs-kernel</tt> package is
enabled</i></span>. If the OpenACS core isn't initialized, the server
couldn't possibly be operational, so if there's no enabled version of
the OpenACS core we simply mark the latest installed one as enabled. 

</p></li>
<li><p>
<span class="strong"><i>Load <tt>*-procs.tcl</tt> files for enabled
packages</i></span>, activating their APIs. 

</p></li>
<li><p>
<span class="strong"><i>Load <tt>*-init.tcl</tt> files for enabled packages</i></span>,
giving packages a chance to register filters and procedures, initialize data
structures, etc. 

</p></li>
<li><p>
<span class="strong"><i>Verify that the core has been properly initialized</i></span> by
checking for the existence of an NSV created by the request processor
initialization code. If it's not present, the server won't be
operational, so we log an error.</p></li>
</ol></div>
<p>
At this point, <tt>bootstrap.tcl</tt> is done executing. AOLserver
proceeds to source the remaining files in the <tt>/tcl</tt> directory
(i.e., unpackaged libraries) and begins listening for connections. 
</p>
<p><div class="cvstag">($Id$)</div></p>
</div>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="tcl-doc.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right"> </td>
</tr>
<tr>
<td width="40%" align="left">Documenting Tcl Files: Page Contracts and Libraries </td>
<td width="20%" align="center"><a accesskey="u" href="kernel-doc.html">Up</a></td>
<td width="40%" align="right"> </td>
</tr>
</table>
<hr>
<address>
			rmello at fslc.usu.edu
		</address>
<address><a href="mailto:vinod@kurup.com">
			vinod@kurup.com
		  </a></address>
</div>
</body>
</html>
