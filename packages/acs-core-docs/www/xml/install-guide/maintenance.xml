<?xml version='1.0' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
               "http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd" [
<!ENTITY % myvars SYSTEM "../variables.ent">
%myvars;
]>
<chapter id="maintenance-web">
  <title>Production Environments</title>

    <authorblurb>
      <para>By <ulink url="mailto:joel@aufrecht.org">Joel Aufrecht</ulink></para>
    </authorblurb>
    
    <para>Maintenance tasks, optional software, and alternate configurations for AOLserver.</para>
    
    <sect1 id="install-openacs-keepalive" xreflabel="Keep AOLserver alive">
	<title>Starting and Stopping an OpenACS instance.</title> 

    <para>The simplest way to start and stop and OpenACS site is to run the startup shell script provided, <computeroutput>/var/lib/aolserver/<replaceable>service0</replaceable>/etc/daemontools/run</computeroutput>.  This runs as a regular task, and logs to the logfile.  To stop the site, kill the script.</para>
    <para>A more stable way to run OpenACS is with a "keepalive" mechanism of some sort, so that whenever the server halts or is stopped for a reset, it restarts automatically.  This is recommended for development and production servers.</para>
      <para>The Reference Platform uses Daemontools to control AOLserver.  A simpler method, using <computeroutput>init</computeroutput>, is <link linkend="install-openacs-inittab">here</link>.</para>
      <orderedlist>
        <listitem>
          <para>Daemontools must already be installed.  If not, <link linkend="install-daemontools">install it</link>.</para>
        </listitem>
          <listitem>
            <para>Each service controlled by daemontools must have a
            directory in <computeroutput>/service</computeroutput>.  That
            directory must have a file called
            <computeroutput>run</computeroutput>.  It works like this:</para>
            <itemizedlist>
              <listitem><para>The <computeroutput>init</computeroutput> program starts every
              time the computer is booted. </para></listitem>
              <listitem><para>A line in <computeroutput>init</computeroutput>'s configuration
              file, <computeroutput>/etc/inittab</computeroutput>, tells init to
              run, and to restart if necessary,
              <computeroutput>svscanboot</computeroutput>.</para></listitem>
              <listitem><para><computeroutput>svscanboot</computeroutput> checks
              the directory <computeroutput>/service</computeroutput>
              every few seconds.</para>
              </listitem>
              <listitem><para>If it sees a subdirectory there, it
              looks for a file in the subdirectory called
              <computeroutput>run</computeroutput>.  If it finds a run file, it creates a <computeroutput>supervise</computeroutput> process</para>
              </listitem>
              <listitem>
                <para><computeroutput>supervise </computeroutput> executes the run script.  Whenever the run script stops, <computeroutput>supervise</computeroutput> executes it again.  It also creates additional control files in the same directory. </para>
              </listitem>
            </itemizedlist>
            <para>Hence, the AOLserver
	  instance for your development server is started by the file
	  <computeroutput>/service/service0/run</computeroutput>.
	  But we use a symlink to make it easier to add and remove
	  stuff from the <computeroutput>/service</computeroutput>, so
	  the actual location is
          <computeroutput>/var/lib/aolserver/<replaceable>service0</replaceable>etc/daemontools/run</computeroutput>.</para>

          <para>Daemontools creates additional files and directories to track status and
        log.  A daemontools directory is included in the OpenACS tarball at
        <computeroutput>/var/lib/aolserver/<replaceable>service0</replaceable>/etc/daemontools</computeroutput>.  To use it, first ill any existing AOLserver instances.  As root, link the <computeroutput>daemontools</computeroutput> directory into the <computeroutput>/service</computeroutput> directory.  Daemontools' <computeroutput>svscan</computeroutput> process checks this directory every five seconds, and will quickly execute <computeroutput>run</computeroutput>.</para>
            
            <screen>[service0 etc]$ <userinput>killall nsd</userinput>
nsd: no process killed
[service0 etc]$ <userinput>exit</userinput>

[root root]# <userinput>ln -s /var/lib/aolserver/<replaceable>service0</replaceable>/etc/daemontools/ /service/<replaceable>service0</replaceable></userinput></screen>
            <para>Verify that AOLserver is running.</para>
            <screen>[root root]#<userinput> ps -auxw | grep nsd</userinput>
<replaceable>service0</replaceable>   5562 14.2  6.2 22436 15952 ?       S    11:55   0:04 /usr/local/aolserver/bin/nsd -it /var/lib/aolserver/<replaceable>service0</replaceable>/etc/config.tcl -u serve
root      5582  0.0  0.2  3276  628 pts/0    S    11:55   0:00 grep nsd
[root root]#</screen>
          </listitem>
          <listitem>
            <para>The user <replaceable>service0</replaceable> can now control the service <replaceable>service0</replaceable> with these commands:</para>
            <itemizedlist>
              <listitem><para>

            <computeroutput>svc -d /service/<replaceable>service0</replaceable></computeroutput> -
            Bring the server down

          </para></listitem>
              
              <listitem><para>

            <computeroutput>svc -u /service/<replaceable>service0</replaceable></computeroutput> -
            Start the server up and leave it in keepalive mode.

          </para></listitem>
              
              <listitem><para>

            <computeroutput>svc -o /service/<replaceable>service0</replaceable></computeroutput> -
            Start the server up once. Do not restart it if it stops.

          </para></listitem>

        <listitem><para>

            <computeroutput>svc -t /service/<replaceable>service0</replaceable></computeroutput> -
            Stop and immediately restart the server.

          </para></listitem>

        <listitem><para>
        
            <computeroutput>svc -k /service/<replaceable>service0</replaceable></computeroutput> -
            Sends the server a KILL signal. This is like KILL -9. AOLserver
            exits immediately. If svc -t fails to fully kill AOLserver, use
            this option.  This does not take the server out of keepalive mode, so it should still bounce back up immediately.

          </para></listitem>
        </itemizedlist>
      </listitem>

        <listitem>
          <para>Install a script to automate the stopping and starting
          of AOLserver services via daemontools.  You can then restart a service via <computeroutput>restart-aolserver <replaceable>service0</replaceable></computeroutput></para>
          <screen>[root root]# <userinput>cp /var/lib/aolserver/<replaceable>service0</replaceable>/packages/acs-core-docs/www/files/restart-aolserver-daemontools.txt /usr/local/bin/restart-aolserver</userinput>
[root root]# <userinput>chmod 755 /usr/local/bin/restart-aolserver</userinput>
[root root]#</screen>
        </listitem>
      <listitem>
        <para>
        At this point, these commands will work only for the
        <computeroutput>root</computeroutput> user.  Grant permission for the <computeroutput>web</computeroutput> group to use <computeroutput>svc</computeroutput> commands on the <emphasis><replaceable>service0</replaceable></emphasis> server.</para>
            <screen>[root root]# <userinput>svgroup web /service/<replaceable>service0</replaceable></userinput>
[root root]#</screen>
          </listitem>
          <listitem>
            <para>Verify that the controls work.  You may want to <computeroutput>tail -f /var/lib/aolserver/<replaceable>service0</replaceable>/log/<replaceable>service0</replaceable>-error.log</computeroutput> in another window, so you can see what happens when you type these commands.
      </para>
            <para>

        Most of this information comes from Tom Jackson's <ulink
          url="http://zmbh.com/daemontools-aolserver/aolserver+daemontools.html">AOLserver+Daemontools
          Mini-HOWTO</ulink>.
</para>
        </listitem>
      </orderedlist>

      <table frame='all'><title>How it Works</title>
	<tgroup cols='6' align='top' colsep='1' rowsep='1'>
	  <thead>
	    <row>
	      <entry>Program</entry>
	      <entry>Invoked by this program ...</entry>
	      <entry>... using this file</entry>
	      <entry>Where to find errors</entry>
	      <entry>Log goes to</entry>
	      <entry>Use these commands to control it</entry>
	    </row>
	  </thead>
	  <tbody>
	    <row>
	      <entry>svscanboot
      </entry>
	      <entry>init</entry>
	      <entry>/etc/inittab</entry>
	      <entry>ps -auxw | grep readproctitle</entry>
	      <entry>n/a</entry>
	      <entry></entry>
	    </row>
	    <row>
	      <entry>aolserver</entry>
	      <entry><computeroutput></computeroutput>supervise
(a child of svscanboot)</entry>
	      <entry>/service/<replaceable>service0</replaceable>/run</entry>
	      <entry>/var/lib/aolserver/<replaceable>service0</replaceable>/log/error.log</entry>
	      <entry>/var/lib/aolserver/<replaceable>service0</replaceable>/log/service0.log</entry>
            <entry>svc -k /service/<replaceable>service0</replaceable></entry>
	    </row>
	    <row>
	      <entry>postgresql</entry>
	      <entry>Redhat init scripts during boot</entry>
	      <entry>/etc/init.d/postgresql</entry>
	      <entry>/usr/local/pgsql/data/server.log</entry>
	      <entry></entry>
	      <entry>service postgresql start (Red Hat), /etc/init.d/postgresql start (Debian)</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

    </sect1>
    <sect1 id="install-openacs-inittab" xreflabel="Editing inittab">
      <title>AOLserver keepalive with inittab</title>
      
      <para>This is an alternative method for keeping the AOLserver
		process running.  The recommended method is to <link
		linkend="install-openacs-keepalive">run AOLserver
		supervised</link>.</para>
      
      <para>
		This step should be completed as root. This can break every service
		on your machine, so proceed with caution.
	  </para>
      
      <itemizedlist>
        <listitem><para>
			There are 2 general steps to getting this working. 
		  </para>
          <orderedlist>
            <listitem><para> 
				Install a script called
				<computeroutput>restart-aolserver</computeroutput>. This
				script doesn't actually restart AOLserver - it just kills
				it.  
			  </para></listitem>
            
            <listitem><para>
				Ask the OS to restart our service whenever it's not
				running. We do this by adding a line to
				<computeroutput>/etc/inittab</computeroutput>.
			  </para></listitem>
          </orderedlist>
          
          <para>
			Calling <computeroutput>restart-aolserver</computeroutput>
			kills our service. The OS notices that our service is not
			running, so it automatically restarts it. Thus, calling
			<computeroutput>restart-aolserver</computeroutput> effectively
			restarts our service.  
		  </para></listitem>
        
		<listitem><para> 
			Copy this <ulink
			  url="files/restart-aolserver.txt">file</ulink> into
			<computeroutput>/tmp/restart-aolserver.txt</computeroutput>.
		  </para></listitem>

		<listitem><para> 
			This script needs to be SUID-root, which means
			that the script will run as root. This is necessary to ensure
			that the AOLserver processes are killed regardless of who owns
			them. However the script should be executable by the
			<computeroutput>web</computeroutput> group to ensure that the
			users updating the web page can use the script, but that
			general system users cannot run the script. You also need to
			have Perl installed and also a symbolic link to it in
			<computeroutput>/usr/local/bin</computeroutput>. 
		  </para>
		<programlisting>
[joeuser ~]$ su - 
Password: ***********
[root ~]# cp /tmp/restart-aolserver.txt /usr/local/bin/restart-aolserver
[root ~]# chown root.web /usr/local/bin/restart-aolserver
[root ~]# chmod 4750 /usr/local/bin/restart-aolserver
[root ~]# ln -s /usr/bin/perl /usr/local/bin/perl
[root ~]# exit</programlisting>
      </listitem>

      <listitem><para> 
			Test the <computeroutput>restart-aolserver</computeroutput>
			script. We'll first kill all running servers to clean the
			slate. Then, we'll start one server and use
			<computeroutput>restart-aolserver</computeroutput> to kill
			it. If it works, then there should be no more servers
			running. You should see the following lines. </para>

		<programlisting>
[joeuser ~]$ killall nsd
nsd: no process killed
[joeuser ~]$ /usr/local/aolserver/bin/nsd-postgres -t ~/var/lib/aolserver/<emphasis>birdnotes</emphasis>/nsd.tcl
[joeuser ~]$ restart-aolserver <emphasis>birdnotes</emphasis>
Killing 23727 
[joeuser ~]$ killall nsd
nsd: no process killed</programlisting>

        <para>
            The number 23727 indicates the process id(s) (PIDs) of the
            processes being killed. It is important that <emphasis
            role="strong">no processes are killed</emphasis> by the second
            call to <computeroutput>killall</computeroutput>. If there are
            processes being killed, it means that the script is not
            working.</para></listitem>

      <listitem><para> 
          Assuming that the <computeroutput>restart-aolserver</computeroutput>
          script worked, login as root and open
          <computeroutput>/etc/inittab</computeroutput> for
          editing. </para>
        <programlisting>
[joeuser ~]$ su -
Password: ************
[root ~]# emacs -nw /etc/inittab</programlisting>
      </listitem>

      <listitem><para> 
            Copy this line into the bottom of the file as a template,
            making sure that the first field
            <computeroutput>nss1</computeroutput> is unique.
          </para>
          <programlisting>
nss1:345:respawn:/usr/local/aolserver/bin/nsd-postgres -i -u nobody -g web -t /home/<emphasis>joeuser</emphasis>/var/lib/aolserver/<emphasis>birdnotes</emphasis>/nsd.tcl</programlisting>
        </listitem>

        <listitem><para>
            <emphasis role="strong">Important:</emphasis> Make sure there is a
            newline at the end of the file. If there is not a newline at
            the end of the file, the system may suffer catastrophic
            failures.  
          </para></listitem>

        <listitem><para>
            Still as root, enter the following command to re-initialize
            <computeroutput>/etc/inittab</computeroutput>. </para>

          <programlisting>
[root ~]# killall nsd    
nsd: no process killed
[root ~]# /sbin/init q</programlisting>        
        </listitem>

        <listitem><para> 
            See if it worked by running the
            <computeroutput>restart-aolserver</computeroutput> script
            again. </para>

          <programlisting>
[root ~]# restart-aolserver <emphasis>birdnotes</emphasis>
Killing 23750</programlisting>
        </listitem>
      </itemizedlist>

      <para>
        If processes were killed, congratulations, your server is now
        automated for startup and shutdown. 
      </para>
    </sect1>
  
  <sect1 id="install-next-add-server">
    <title>Running multiple services on one machine</title>
      <formalpara>
        <title>Services on different ports</title>
        <para>To run a different service on another port but the same
        ip, simply repeat <xref linkend="openacs"/> replacing
        <replaceable>service0</replaceable>, and change the
<programlisting>set httpport              8000
set httpsport             8443 </programlisting>
 to different values.</para>
      </formalpara>
      <formalpara>
        <title>Services on different host names</title>
        <para>For example, suppose you want to support
<computeroutput>http://foo.com</computeroutput> and
    <computeroutput>http://bar.com</computeroutput> on the same
    machine.  The easiest way is to assign each one a different ip
    address.  Then you can install two services as above, but with
        different values for
<programlisting>set hostname               [ns_info hostname]
set address                127.0.0.1 </programlisting>
</para>
    </formalpara>

    <para>If you want to install two services with different host
    names sharing the same ip, you'll need nsvhr to redirect requests
    based on the contents of the tcp headers.  See <ulink
    url="http://borkware.com/rants/aolserver-vhosting/">AOLserver
    Virtual Hosting with TCP</ulink> by <ulink url="mailto:markd@borkware.com">markd</ulink>.
</para>

  </sect1>

  <sect1 id="high-avail">
    <title>High Availability/High Performance Configurations</title>
    <figure>
      <title>Multiple-server configuration</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/hpha.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>

  </sect1>

    <sect1 id="maintenance-deploy">
  <title>Staged Deployment for Production Networks</title>
    <authorblurb>
      <para>By <ulink url="mailto:joel@aufrecht.org">Joel Aufrecht</ulink></para>
    </authorblurb>
  <para>This section describes minimal-risk methods for deploying changes on a production network.  The important characteristics of a safe change deployment include:</para>
  <itemizedlist>
    <listitem>
      <para>Control: You know for sure that the change you are making is the change that you intend to make and is the change that you tested.</para>
    </listitem>
    <listitem>
      <para>Rollback: If anything goes wrong, you can return to the previous working configuration safely and quickly.</para>
    </listitem>
  </itemizedlist>
  <para>The approach taken in this section is to always create a new service with the desired changes, running in parallel with the existing site.  This guarantees control, at least at the final step of the process: you know what changes you are about to make because you can see them directly.  It does not, by itself, guarantee the entire control chain.  You need additional measures to make sure that the change you are making is exactly and completely the change you intended to make and tested previously, and nothing more.  Those additional measures typically take the form of source control tags and system version numbers.  The parallel-server approach also guarantees rollback because the original working service is not touched; it is merely set aside.</para>
  <para>This approach can has limitations.  If the database or file system regularly receiving new data, you must interrupt this function or risk losing data in the shuffle.  It also requires extra steps if the database will be affected.</para>
  <sect2>
    <title>Simple Deployment: Database is not changed</title>
    <figure>
      <title>Simple Deployment - Step 1</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/simple-deploy-1.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>
     <figure>
      <title>Simple Deployment - Step 1</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/simple-deploy-2.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>
     <figure>
      <title>Simple Deployment - Step 1</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/simple-deploy-3.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>
  </sect2>
  <sect2>
    <title>Complex Deployment: Database is changed</title>
    <figure>
      <title>Complex Deployment - Step 1</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/complex-deploy-1.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>
     <figure>
      <title>Complex Deployment - Step 1</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/complex-deploy-2.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>
     <figure>
      <title>Complex Deployment - Step 1</title>
      <mediaobject>
        <imageobject>
          <imagedata fileref="images/complex-deploy-3.png" format="png" align="center"/>
        </imageobject>
      </mediaobject>
    </figure>
  </sect2>
</sect1>
    <sect1 id="install-ssl">
      <title>Installing SSL Support</title>
        <para>nsopenssl is an open-sounce module for AOLserver which
        adds support for the ssl encryption layer.  To use it, you
        must <link linkend="install-nsopenssl">install</link> the software, create or purchase certificates,
        and configure your OpenACS instance to use it.</para>
        <orderedlist>
          <listitem>
            <para>Uncomment this line from <computeroutput>config.tcl</computeroutput>.</para>
            <programlisting>#ns_param   nsopenssl       ${bindir}/nsopenssl.so
</programlisting>
          </listitem>
          <listitem id="ssl-certificates" xreflabel="Generate ssl certificates">
            <para>Prepare a certificate directory for the service.</para>
            <screen>[service0 etc]$ <userinput>mkdir /var/lib/aolserver/<replaceable>service0</replaceable>/etc/certs</userinput>
[service0 etc]$ <userinput>chmod 700 /var/lib/aolserver/<replaceable>service0</replaceable>/etc/certs</userinput>
[service0 etc]$ 
<action>mkdir /var/lib/aolserver/<replaceable>service0</replaceable>/etc/certs
chmod 700 /var/lib/aolserver/<replaceable>service0</replaceable>/etc/certs</action></screen>            
          </listitem>
          <listitem>
            <para>It takes two files to support an SSL connection.  The certificate is the public half of the key pair - the server sends the certificate to browser requesting ssl.  The key is the private half of the key pair.  In addition, the certificate must be signed by Certificate Authority or browsers will protest.  Each web browser ships with a built-in list of acceptable Certificate Authorities (CAs) and their keys.  Only a site certificate signed by a known and approved CA will work smoothly.  Any other certificate will cause browsers to produce some messages or block the site.  Unfortunately, getting a site certificate signed by a CA costs money.  In this section, we'll generate an unsigned certificate which will work in most browsers, albeit with pop-up messages.</para>
            <para>Use an OpenSSL perl script to generate a certificate and key.</para>
            <screen>[service0 service0]$ <userinput>cd /var/lib/aolserver/service0/etc/certs</userinput>
[service0 certs]$ <userinput>perl /usr/share/ssl/misc/CA -newcert</userinput>
Using configuration from /usr/share/ssl/openssl.cnf
Generating a 1024 bit RSA private key
...++++++
.......++++++
writing new private key to 'newreq.pem'
Enter PEM pass phrase:</screen>
            <para>Enter a pass phrase for the CA certificate.  Then, answer the rest of the questions.  At the end you should see this:</para>
        <screen>Certificate (and private key) is in newreq.pem
[service0 certs]$</screen>
        <para><computeroutput>newreq.pem</computeroutput> contains our certificate and private key.  The key is protected by a passphrase, which means that we'll have to enter the pass phrase each time the server starts.  This is impractical and unnecessary, so we create an unprotected version of the key.  <emphasis>Security implication</emphasis>: if anyone gets access to the file keyfile.pem, they effectively own the key as much as you do.  Mitigation: don't use this key/cert combo for anything besides providing ssl for the web site.</para>
            <screen>[root misc]# <userinput>openssl rsa -in newreq.pem -out keyfile.pem</userinput>
read RSA key
Enter PEM pass phrase:
writing RSA key
[service0 certs]$ </screen>
        <para>To create the certificate file, we take the combined file, copy it, and strip out the key.</para>
        <screen>[service0 certs]$ <userinput>cp newreq.pem certfile.pem</userinput>
[root misc]# <userinput>emacs certfile.pem</userinput></screen>
        <para>Strip out the section that looks like</para>
        <programlisting>-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: DES-EDE3-CBC,F3EDE7CA1B404997
S/Sd2MYA0JVmQuIt5bYowXR1KYKDka1d3DUgtoVTiFepIRUrMkZlCli08mWVjE6T
<emphasis>(11 lines omitted)</emphasis>
1MU24SHLgdTfDJprEdxZOnxajnbxL420xNVc5RRXlJA8Xxhx/HBKTw==
-----END RSA PRIVATE KEY-----</programlisting>
        </listitem>
      </orderedlist>
    </sect1>

    <sect1 id="analog-setup">
    <title>Set up Log Analysis Reports - OPTIONAL</title>
    
    <para>Analog is a program with processes webserver access logs,
      performs DNS lookup, and outputs HTML reports.  Analog should
      <link linkend="analog-install">already be
      installed.</link>  A modified configuration file is included in
      the OpenACS tarball.</para>
    <orderedlist>
      <listitem>
        <screen>[root src]# <userinput>su - service0</userinput>
[service0 service0]$ <userinput>cd /var/lib/aolserver/service0</userinput>
[service0 service0]$ <userinput>cp /var/lib/aolserver/service0/packages/acs-core-docs/www/files/analog.cfg.txt etc/analog.cfg</userinput>
[service0 service0]$ <userinput>mkdir www/log</userinput>
[service0 service0]$ <userinput>cp -r /usr/share/analog-5.31/images www/log/</userinput>
[service0 service0]$ <action>
su - service0
cd /var/lib/aolserver/service0
cp /var/lib/aolserver/service0/packages/acs-core-docs/www/files/analog.cfg.txt etc/analog.cfg
mkdir www/log
cp -r /usr/share/analog-5.31/images www/log/</action></screen>
        <para>Edit
<computeroutput>/var/lib/aolserver/service0/etc/analog.cfg</computeroutput> and change the variable in <computeroutput>HOSTNAME "[my
organisation]"</computeroutput> to reflect your website title.  If you
don't want the traffic log to be publicly visible, change
<computeroutput>OUTFILE /var/lib/aolserver/service0/www/log/traffic.html</computeroutput> to use a private
directory.</para>
      </listitem>
      <listitem>
        <para>Run it.</para>
        <screen>[service0 service0]$ <userinput>/usr/share/analog-5.31/analog -G -g/var/lib/aolserver/service0/etc/analog.cfg</userinput>
/usr/share/analog-5.31/analog: analog version 5.31/Unix
/usr/share/analog-5.31/analog: Warning F: Failed to open DNS input file
  /home/service0/dnscache: ignoring it
  (For help on all errors and warnings, see docs/errors.html)
/usr/share/analog-5.31/analog: Warning R: Turning off empty Search Word Report
[service0 service0]$</screen>
        <para>Verify that it works by browing to <computeroutput>http://yourserver.test:8000/log/traffic.html</computeroutput></para>
      </listitem>
      <listitem>
        <para>Automate this by creating a file in
          <computeroutput>/etc/cron.daily</computeroutput>.</para>
          <screen>[service0 service0]$ <userinput>exit</userinput>
logout

[root root]# <userinput>emacs /etc/cron.daily/analog</userinput></screen>
        <para>Put this into the file:</para>
        <programlisting>#!/bin/sh

/usr/share/analog-5.31/analog -G -g/var/lib/aolserver/<replaceable>service0</replaceable>/etc/analog.cfg</programlisting>
        <screen>[root root]# <userinput>chmod 755 /etc/cron.daily/analog</userinput></screen>
        <para>Test it by running the script.</para>
        <screen>[root root]# <userinput>sh /etc/cron.daily/analog</userinput></screen>
        <para>Browse to <computeroutput>http://<replaceable>yourserver.test</replaceable>/log/traffic.html</computeroutput></para>
      </listitem>
    </orderedlist>
  </sect1>
  <sect1 id="uptime">
    <title>External uptime validation</title>
    <para>The <ulink url="http://uptime.openacs.org/uptime/">OpenACS uptime site</ulink> can monitor your site and send you an email whenever your site fails to respond.  If you test the url <computeroutput>http://<replaceable>yourserver.test</replaceable>/SYSTEM/dbtest.tcl</computeroutput>, you should get back the string <computeroutput>success</computeroutput>.</para>
  </sect1>
<sect1 id="maint-performance">
  <title>Diagnosing Performance Problems</title>
  <itemizedlist>
    <listitem>
      <para>Did performance problems happen overnight, or did they sneak up on
    you? Any clue what caused the performance problems (e.g. loading 20K
    users into .LRN)</para>
    </listitem>
    <listitem>
      <para>Is the file system out of space?  Is the machine swapping to disk constantly?</para>
    </listitem>
    <listitem>
      <para>Isolating and solving database problems.</para>
    <itemizedlist>
      <listitem>
          <para>Without daily internal maintenance, most databases slowly degrade in performance.  For PostGreSQL, see <xref linkend="install-next-nightly-vacuum"/>.  For Oracle, use <computeroutput>exec dbms_stats.gather_schema_stats('SCHEMA_NAME')</computeroutput> (<ulink url="http://www.piskorski.com/docs/oracle.html">Andrew Piskorski's Oracle notes</ulink>).</para>
      </listitem>
      <listitem>
        <para>You can track the exact amount of time each database query on a page takes:</para>
          <orderedlist>
            <listitem>
              <para>Go to <ulink url="/acs-admin/install">Main Site : Site-Wide Administration : Install Software</ulink></para>
              </listitem>
              <listitem>
                <para>Click on "Install New Application" in "Install from OpenACS Repository"</para>
            </listitem>
            <listitem>
              <para>Choose "ACS Developer Support"></para>
            </listitem>
            <listitem>
              <para>After install is complete, restart the server.</para>
            </listitem>
            <listitem>
              <para>Browse to Developer Support, which is automatically mounted at <computeroutput><ulink url="/ds">/ds</ulink></computeroutput>.
              </para>
            </listitem>
            <listitem>
              <para>Turn on Database statistics</para>
            </listitem>
            <listitem>
              <para>Browse directly to a slow page and click "Request Information" at the bottom of the page.</para>
            </listitem>
            <listitem>
              <para>This should return a list of database queries on the page, including the exact query (so it can be cut-paste into psql or oracle) and the time each query took.</para>
              <figure>
                <title>Query Analysis example</title>
              <mediaobject>
                <imageobject>
                  <imagedata fileref="images/query-duration.png" format="PNG"/>
                </imageobject>
              </mediaobject>
              </figure>
            </listitem>
          </orderedlist>
        </listitem>
        <listitem>
          <para>Identify a runaway Oracle query: first, use <userinput>ps aux</userinput> or <userinput>top</userinput> to get the UNIX process ID of a runaway Oracle process.</para>
        <para>Log in to SQL*Plus as the admin:</para>
        <screen>[<replaceable>service0</replaceable> ~]$ svrmgrl

Oracle Server Manager Release 3.1.7.0.0 - Production

Copyright (c) 1997, 1999, Oracle Corporation.  All Rights Reserved.

Oracle8i Enterprise Edition Release 8.1.7.3.0 - Production
With the Partitioning option
JServer Release 8.1.7.3.0 - Production

SVRMGR> <userinput>connect internal</userinput>	        
Password:</screen>
        <para>See all of the running queries, and match the UNIX PID:</para>
        <programlisting>select p.spid  -- The UNIX PID
       ,s.sid  ,s.serial#
       ,p.username  as os_user
       ,s.username  ,s.status
       ,p.terminal  ,p.program
  from v$session s  ,v$process p
 where p.addr = s.paddr
 order by s.username ,p.spid ,s.sid ,s.serial# ;</programlisting>
        <para>See the SQL behind the oracle processes:</para>
        <programlisting>select s.username
       ,s.sid  ,s.serial#
       ,sql.sql_text
  from v$session s, v$sqltext sql
 where sql.address    = s.sql_address
   and sql.hash_value = s.sql_hash_value
 --and upper(s.username) like 'USERNAME%'
 order by s.username ,s.sid ,s.serial# ,sql.piece ;</programlisting>
        <para>To kill a troubled process:</para>
        <programlisting>alter system kill session 'SID,SERIAL#';  --substitute values for SID and SERIAL#</programlisting>
        <para>(See <ulink url="http://www.piskorski.com/docs/oracle.html">Andrew Piskorski's Oracle notes</ulink>)</para>
        </listitem>
      </itemizedlist>
    </listitem>
  </itemizedlist>
</sect1>

    <para><phrase role="cvstag">($Id$)</phrase></para>
</chapter>
