<sect1 id="upgrade-detail">
    <title>Support for upgrades.</title>
  <authorblurb>
    by <ulink url="mailto:joel@aufrecht.org">Joel Aufrecht</ulink>
  </authorblurb>
  <para>Starting with Version 4.5, all OpenACS core packages support
    automatic upgrade.  That means that, if you have OpenACS 4.5
    or better, you should always be able to upgrade all of your core
    packages automatically.  If you haven't changed anything, no
    manual intervention should be required.  If you are running
    OpenACS prior to 4.5, upgrading will require manual effort.</para>
</sect1>

<sect1 id="upgrade-4.5">
  <title>Upgrading from OpenACS 4.5</title>
    <sect2><title>Checklist</title>
    <para>The required platform for OpenACS &version; is the same as
    4.5, with the excepion of OpenFTS.  You now need OpenFTS 0.3.2, not 0.2.
    OpenACS &version; supports PostGreSQL 7.2.3 and 7.3.2.</para>
    <itemizedlist mark="circle">
      <listitem><para>A computer with OpenACS 4.5.</para>
      </listitem>
      <listitem><para><ulink url="http://openacs.org/projects/openacs/download/">OpenACS &version; tarball</ulink></para>
      </listitem>
      <listitem><para>Required for Full Text Search on PostGreSQL: <ulink url="http://openfts.sourceforge.net">OpenFTS 0.3.2</ulink></para>
      </listitem>
    </itemizedlist>
  </sect2>
  <sect2>
    <title>Overview</title>
    <para>OpenACS consists of files and a database schema.  The files
    in the OpenACS &version; tarball include database upgrade scripts.  To start the
    upgrade, replace your existing files with the new files and
    then restart the server.  Then, browse to the APM, which will
    detect the new packages and offer to run the appropriate database upgrade
    scripts.  After restarting the server again, the upgrade is
    complete.</para>
    <figure>
      <title>Assumptions in this section</title>
      <informaltable>
        <tgroup cols="2">
          <tbody>
            <row>
              <entry>name of OpenACS user</entry>
              <entry><replaceable>nsadmin</replaceable></entry>
            </row>
            <row>
              <entry>OpenACS server name</entry>
              <entry><replaceable>openacs-dev</replaceable></entry>
            </row>
            <row>
              <entry>Root of OpenACS file tree</entry>
              <entry><replaceable>/web/openacs-dev</replaceable></entry>
            </row>
            <row>
              <entry>Database backup directory</entry>
              <entry><replaceable>/backup/openacs/</replaceable></entry>
            </row>
          </tbody>
        </tgroup>
      </informaltable>
    </figure>
  </sect2>
  <sect2><title><indexterm>
        <primary>upgrade</primary>
        <secondary>OpenACS 4.5 to 4.6</secondary>
        <secondary>Linux/Unix</secondary>
</indexterm>Upgrading on Linux/Unix</title>
    <orderedlist>
      <listitem>
        <formalpara>
          <title>Make a Backup</title>
          <para>Back up the database and file system.</para>
        </formalpara>
        <itemizedlist>
          <listitem>
            <formalpara>
              <title>PostGreSQL</title>
              <para>Create a backup file and verify that it was created and has a reasonable size (several megabytes).</para>
            </formalpara>
            <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$ <userinput>pg_dump -f /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp <replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost aolserver]$ <userinput>ls -al /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp </userinput>
-rw-rw-r--    1 nsadmin  nsadmin   4005995 Feb 21 18:28 /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp
[nsadmin@localhost aolserver]$ <userinput>exit</userinput>
[root@localhost root]#
<action>su - nsadmin
pg_dump -f /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp <replaceable>openacs-dev</replaceable>
ls -al /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp
exit</action></screen>
          </listitem>
          <listitem>
            <formalpara>
              <title>Oracle - INCOMPLETE</title>
              <para></para>
            </formalpara>
          </listitem>
          <listitem>
            <formalpara>
              <title>File tree with CVS</title>
              <para>If you are already using CVS, you probably don't
              need to do anything to back up your data.  Just make
              sure that your current work is checked into the system.
              You can then roll back based on date - just note the
              current system time, down to the minute.  For maximum
              safety, you can apply a tag to your current
              files.</para>
            </formalpara>
            <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$ <userinput>cd /web/<replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost openacs-dev]$ <userinput>cvs commit -m "last-minute commits before upgrade to &version;"</userinput>
cvs commit: Examining .
cvs commit: Examining bin
(many lines omitted)
[nsadmin@localhost openacs-dev]$ <userinput>cvs tag before_upgrade_to_4_6</userinput>
cvs server: Tagging bin
T bin/acs-4-0-publish.sh
T bin/ad-context-server.pl
(many lines omitted)
[nsadmin@localhost openacs-dev]$ <userinput>exit</userinput>
[root@localhost root]# 
<action>su - nsadmin
cd /web/<replaceable>openacs-dev</replaceable>
cvs commit -m "last-minute commits before upgrade to &version;"
cvs tag before_upgrade_to_4_6
exit</action></screen>
          </listitem>
          <listitem>
            <formalpara>
              <title>File tree without CVS</title>
              <para>If you don't use cvs, you may want to back up the working directory.  The simplest way is just to copy it.</para>
            </formalpara>
            <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$ <userinput>cp -r /web/<replaceable>openacs-dev</replaceable> /web/<replaceable>openacs-dev</replaceable>-before-upgrade-to-4.6</userinput>
[nsadmin@localhost aolserver]$ <userinput>exit</userinput>
[root@localhost root]# 
<action>su - nsadmin
cp -r /web/<replaceable>openacs-dev</replaceable> /web/<replaceable>openacs-dev</replaceable>-before-upgrade-to-4.6
exit</action></screen>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <formalpara>
          <title>OPTIONAL: Upgrade OpenFTS</title>
        <para>OpenACS Full Text Search requires several pieces: the OpenFTS code, some database functions, and the OpenFTS Engine.  If you have OpenFTS 0.2, you'll need to upgrade to to OpenFTS 0.3.2.  This is backwards-compatible -
        completing this step will not break a working OpenFTS Engine from 4.5.
</para>
        </formalpara>
        <orderedlist>
          <listitem>
            <para>Uninstall the old OpenFTS Engine</para>
            <orderedlist>
              <listitem><para><emphasis role='bold'>Browse to <computeroutput>http://<replaceable>yourserver</replaceable>/openfts</computeroutput>.</emphasis>
</para>
              </listitem>
              <listitem><para><emphasis role='bold'>Click <computeroutput><guilabel>Administration</guilabel></computeroutput>.</emphasis></para>
              </listitem>
              <listitem><para><emphasis role='bold'>Click <computeroutput><guibutton>Drop OpenFTS Engine</guibutton></computeroutput></emphasis></para>
              </listitem>
            </orderedlist>
          </listitem>
          <listitem>
            <para>Build and install the new OpenFTS driver and supporting tcl procedures.  (This section of shell code is not fully documented; please exercise care.)</para>
            <screen>cd /usr/local/src/
tar xzf /tmp/Search-OpenFTS-tcl-0.3.2.tar.gz
chown -R root.root Search-OpenFTS-tcl-0.3.2/
cd Search-OpenFTS-tcl-0.3.2/
./configure --with-aolserver-src=/usr/local/src/aolserver/aolserver --with-tcl=/usr/lib/
cd aolserver/
make
</screen>
            <para>
Back up the old fts driver as a precaution and install the newly
compiled one</para>
<screen>mv /usr/local/aolserver/bin/nsfts.so /usr/local/aolserver/bin/nsfts-0.2.so 
cp nsfts.so /usr/local/aolserver/bin
</screen>
            <para>Build and install the postgres code</para>
<screen>cd /usr/local/src/Search-OpenFTS-tcl-0.3.2/
cp -r pgsql_contrib_openfts /usr/local/src/postgresql-7.2.3/contrib /usr/local/src/postgresql-7.2.3/contrib/pgsql_contrib_openfts
make
su - postgres
cd tsearch/
make
make install
exit</screen>
            <para>In order for the OpenACS &version; OpenFTS Engine to use the OpenFTS 0.3.2 driver, we need some commands added to the database.</para>
            <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost dev]$ <userinput>psql <replaceable>openacs-dev</replaceable> -f /usr/local/pgsql/share/contrib/openfts.sql</userinput>
CREATE
CREATE
[nsadmin@localhost dev]$ <userinput>psql <replaceable>openacs-dev</replaceable> -f /usr/local/src/postgresql-7.2.3/contrib/tsearch/tsearch.sql</userinput>
BEGIN
CREATE
(~30 more lines)
[nsadmin@localhost dev]$ <userinput>exit</userinput>
[root@localhost root]# 
<action>su - nsadmin
psql <replaceable>openacs-dev</replaceable> -f /usr/local/pgsql/share/contrib/openfts.sql
psql <replaceable>openacs-dev</replaceable> -f /usr/local/src/postgresql-7.2.3/contrib/tsearch/tsearch.sql
exit</action></screen>
          </listitem>
        </orderedlist>
      </listitem>
      <listitem>
        <formalpara>
          <title>Stop the server</title>
        </formalpara>
        <screen>[root@localhost root]# <userinput>svc -d /service/<replaceable>openacs-dev</replaceable></userinput></screen>
      </listitem>
      <listitem>
        <formalpara>
          <title>Upgrade the file tree</title>
          <para>If you are using CVS, you will unpack the OpenACS 4.6 tarball into a working directory and then import that directory into cvs.  If you have changed files in the core packages, cvs will attempt to merge your changes.  You may have to manually merge some conflicts.  When that's finished, you can update your normal development checkout directory and the new files will appear.  If you aren't using CVS, you can unpack the tarball on top of your existing tree, but any customizations you've made to the kernel or core packages will be erased.</para>
        </formalpara>
        <itemizedlist>
          <listitem>
            <formalpara>
              <title>Upgrading files without CVS</title>
              <para>Unpack the tarball into a new directory and copy its contents on top of your working directory.</para>
            </formalpara>
            <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$ <userinput>cd /web</userinput>
[nsadmin@localhost web]$ <userinput>tar xzf /tmp/openacs-4-6.tgz</userinput>
[nsadmin@localhost web]$ <userinput>cp -r openacs-4-6/* openacs-4</userinput>
[nsadmin@localhost openacs-upgrade]$ <userinput>exit</userinput>
[root@localhost root]#
<action>su - nsadmin
cd /web
tar xzf /tmp/openacs-4-6.tgz
cp -r openacs-4-6/* openacs-4
exit</action></screen>
          </listitem>
          <listitem>
            <formalpara>
              <title>Upgrading files with CVS</title>
            </formalpara>
            <orderedlist>
              
              <listitem>
                <para>Unpack the new files into a working directory.</para>
                <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$ <userinput>cd /tmp</userinput>
[nsadmin@localhost tmp]$ <userinput>tar xzv openacs-4-6.tgz</userinput>
[nsadmin@localhost tmp]$ <userinput>cd openacs-4.6</userinput>
</screen>
                <para>Import the new files into your cvs repository; where they match existing files, they will become the new version of the file.</para>
                <screen>[nsadmin@localhost openacs-4.6]$ <userinput> cvs import -m "upgrade to OpenACS 4.6" openacs 
OpenACS openacs-4-6</userinput></screen>
                <para>Create a new directory as temporary working space to reconcile conflicts between the new files and your current work.  The example uses the cvs keyword yesterday, making the assumption that you haven't checked in new code to your local tree in the last day.</para>
<screen>[nsadmin@localhost openacs-4.6]$ <userinput> cd /web</userinput>
[nsadmin@localhost tmp]$ <userinput>mkdir openacs-upgrade</userinput>
[nsadmin@localhost tmp]$ <userinput>cvs checkout -d openacs-upgrade -jOpenACS:yesterday -jOpenACS openacs &lt; cvs.txt 2&lt;&amp;1</userinput>
(CVS feedback here)
<action>su - nsadmin
cd /tmp
tar xzv openacs-4-6.tgz
cd openacs-4.6
cvs import -m "upgrade to OpenACS 4.6" openacs OpenACS openacs-4-6
cd /tmp
mkdir openacs-upgrade
cvs checkout -d openacs-upgrade -jOpenACS:yesterday -jOpenACS openacs &lt; cvs.txt 2&lt;&amp;1
</action></screen>
              </listitem>
              <listitem>
                <para>The file /tmp/openacs-upgrade/cvs.txt contains the results of the upgrade.  If you changed files that are part of the OpenACS tarball and those changes conflict with the 4.5-4.6 upgrade, you'll have to manually reconcile them.  Use the emacs command <computeroutput>M-x sort-lines</computeroutput> and then, for each line that starts with a C, open that file and manually resolve the conflict by deleting the excess lines.  When you're finished, or if there aren't any conflicts, save and exit.</para>
              </listitem>
              <listitem>
                <para>Once you've fixed any conflicts, commit the new code
        to your local tree.  </para>
            <screen>[nsadmin@localhost tmp]$ <userinput>cd openacs-upgrade</userinput>
[nsadmin@localhost openacs-upgrade]$ <userinput>cvs commit -m "Upgraded to 4.6"</userinput>
<action>cd openacs-upgrade
cvs commit -m "Upgraded to 4.6"</action></screen>
              </listitem>
              <listitem>
                <para>Update your working tree with the new
                files.  The CVS flags ensure that new directories are created and pruned directories destroyed.</para>
                <screen>
[nsadmin@localhost openacs-upgrade]$ <userinput>cd /web/<replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost openacs-dev]$ <userinput>cvs up -Pd</userinput>
(CVS feedback)
[nsadmin@localhost openacs-dev]$ <userinput>exit</userinput>
[root@localhost root]#
<action>cd /web/<replaceable>openacs-dev</replaceable>
cvs up -Pd
exit</action></screen>
              </listitem>
            </orderedlist>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <formalpara>
          <title>Start the server</title>
        </formalpara>
        <screen>[root@localhost root]# <userinput>svc -u /service/<replaceable>openacs-dev</replaceable></userinput></screen>
      </listitem>
      <listitem>
        <formalpara>
          <title>Use APM to upgrade the database</title>
          <para></para>
        </formalpara>
        <orderedlist>
          <listitem>
          <para>Browse to the package manager, <computeroutput>http://<replaceable>yourserver</replaceable>/acs-admin/apm</computeroutput>.</para>
          </listitem>
          <listitem>
          <para>Click <computeroutput><guilabel>Install packages.</guilabel></computeroutput></para>
          </listitem>
          <listitem>
          <para>Select the packages you want to install.  This should be everything that says <computeroutput>upgrade</computeroutput>, plus any new packages you want.</para>
          </listitem>
          <listitem>
            <para>On the next screen, click <computeroutput><guibutton>Install Packages</guibutton></computeroutput></para>
          </listitem>
          <listitem>
            <para>When prompted, restart the server:</para>
            <screen>[root@localhost root]# <userinput>restart-aolserver <replaceable>openacs-dev</replaceable></userinput></screen>
          </listitem>
          <listitem>
            <para>Wait a minute, then browse to the package manager, <computeroutput>http://<replaceable>yourserver</replaceable>/acs-admin/apm</computeroutput>.</para>
          </listitem>
          <listitem>
            <para>Check that the kernel upgrade worked by clicking <computeroutput><guilabel>All</guilabel></computeroutput> and making sure that <computeroutput>acs-kernel</computeroutput> version is 4.6.1.</para>
          </listitem>
        </orderedlist>
      </listitem>
      <listitem>
        <formalpara>
          <title>OPTIONAL: Install the new OpenFTS Engine.</title>
          <para>If you want to upgrade the OpenFTS Engine, do these steps.  (You
          must have already upgraded the OpenFTS driver to
          0.3.2.</para>
        </formalpara>
        <orderedlist>
          <listitem>
            <para>Browse to <computeroutput>http://<replaceable>yourserver</replaceable>/admin/site-map</computeroutput></para>
          </listitem>
          <listitem>
            <para>On the <computeroutput>openfts</computeroutput> line, click on <computeroutput><guilabel>set parameters</guilabel></computeroutput>.</para>
          </listitem>
          <listitem>
            <para>Change the value of <computeroutput>openfts_tcl_src_path</computeroutput> from <computeroutput>/usr/local/src/Search-OpenFTS-tcl-0.2/</computeroutput> to <computeroutput>/usr/local/src/Search-OpenFTS-tcl-0.3.2/</computeroutput></para>
          </listitem>
          <listitem>
            <para>Click <computeroutput><guibutton>Set Parameters</guibutton></computeroutput></para>
          </listitem>
          <listitem>
            <screen>[root@localhost root]# restart-aolserver <replaceable>openacs-dev</replaceable></screen>
          </listitem>
          <listitem>
            <para>Browse to <computeroutput>http://<replaceable>yourserver</replaceable>/openfts</computeroutput></para>
          </listitem>
          <listitem><para><emphasis role='bold'>Click <computeroutput><guilabel>Administration</guilabel></computeroutput>.</emphasis></para>
          </listitem>
          <listitem><para><emphasis role='bold'>Click <computeroutput><guibutton>Initialize OpenFTS Engine</guibutton></computeroutput></emphasis></para>
          </listitem>
        </orderedlist>
      </listitem>
      <listitem>
        <formalpara>
          <title>Rollback</title>
        <para>If anything goes wrong, roll back the database and try
        again.</para>
        </formalpara>
        <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$ <userinput>svc -d /service/<replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost aolserver]$ <userinput>dropdb <replaceable>openacs-dev</replaceable></userinput>
DROP DATABASE
[nsadmin@localhost aolserver]$ <userinput>createdb <replaceable>openacs-dev</replaceable></userinput>
CREATE DATABASE
[nsadmin@localhost aolserver]$ <userinput>psql -f /web/<replaceable>openacs-dev</replaceable>/packages/acs-kernel/sql/postgresql/postgresql.sql <replaceable>openacs-dev</replaceable></userinput></screen>
<para>PostGreSQL's dump command does not guarantee to back up all of the
procedures and things in the right order for them to be reassembled.
In practice, OpenACS users have found that rebuilding some of the
common procedures before running the restore usually addresses this.  You will see a number of "already exists" errors when you run the database restore; these can be ignored.  This <a href="http://openacs.org/forums/message-view?message_id=70759">forum thread</a> has more information.</para>
<screen>[nsadmin@localhost aolserver]$ <userinput>psql <replaceable>openacs-dev</replaceable> &lt; /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp</userinput>
[nsadmin@localhost aolserver]$ <userinput>svc -u /service/<replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost aolserver]$ <userinput>exit</userinput></screen>
          <para>At this point, you can try go back to the APM and try
to upgrade the database again.  Alternately, if you want to roll back
all the way and stop the upgrade, you need to roll back the file
system as well.</para>
        <screen>[root@localhost root]# <userinput>su - nsadmin</userinput>
[nsadmin@localhost aolserver]$<userinput> mv /web/<replaceable>openacs-dev</replaceable> /web/openacs-failed-upgrade</userinput>
[nsadmin@localhost aolserver]$<userinput> mv /web/<replaceable>openacs-dev</replaceable>-before-upgrade-to-4.6 /web/<replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost aolserver]$ <userinput>svc -u /web/<replaceable>openacs-dev</replaceable></userinput>
[nsadmin@localhost aolserver]$ <userinput>exit</userinput>
[root@localhost root]#</screen>
<screen>All commands for this section:
<action>su - nsadmin
svc -d /service/<replaceable>openacs-dev</replaceable>
dropdb <replaceable>openacs-dev</replaceable>
createdb <replaceable>openacs-dev</replaceable>
psql -f /web/<replaceable>openacs-dev</replaceable>/packages/acs-kernel/sql/postgresql/postgresql.sql <replaceable>openacs-dev</replaceable>
psql <replaceable>openacs-dev</replaceable> &lt; /backup/openacs/openacs_dev_before_upgrade_to_4.6.dmp

svc -u /service/<replaceable>openacs-dev</replaceable>
cd /web/<replaceable>openacs-dev</replaceable>
cvs up -r current
exit</action></screen>
      </listitem>
    </orderedlist>
  </sect2>
  <para><phrase role="cvstag">($Id$)</phrase></para>

</sect1>
<!--
   Local Variables:
   sgml-parent-document: ("../index.xml" "book" "sect1")
   End:
-->
