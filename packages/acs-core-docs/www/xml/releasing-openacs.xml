<?xml version='1.0' ?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.1.2//EN"
               "http://www.oasis-open.org/docbook/xml/4.1.2/docbookx.dtd" [

<!ENTITY % myvars SYSTEM "variables.ent">
%myvars;
]>

<appendix id="releasing-openacs">
  <title>How to package and release OpenACS</title>
    <orderedlist>
      <listitem>
        <para>Update documentation version numbers:</para>
        <orderedlist>
          <listitem>
            <para>Update /packages/acs-core-docs/www/xml/variables.ent with the new version number.
            </para>
          </listitem>
          <listitem>
            <para>Add new section in /packages/acs-core-docs/www/xml/for-everyone/release-notes.xml
</para>
          </listitem>
          <listitem>
            <para>Regenerate all HTML docs</para>
          </listitem>
          <listitem>
            <para>Update /readme.txt with the new version number</para>
          </listitem>
          <listitem>
            <para>Rebuild the Changelog.  Using cvs2cl:</para>
            <screen>perl /var/tmp/cvs2cl/cvs2cl.pl -F oacs-5-0 --delta openacs-5-0-0-final:oacs-5-0</screen>
          </listitem>
          <listitem>
            <para>
              Commit changes
            </para>
          </listitem>
        </orderedlist>
      </listitem>
      <listitem>
        <para>Check out the whole cvs tree.  The files must be checked
          out through a cvs account with write access and should be a
          checkout from the release branch.  In this example, we are assuming
          this is being done as a local user on openacs.org (which make the 
          checkout and tagging operations much faster).</para>
        <screen><action>cd /var/tmp
cvs -d /cvsroot checkout -r <replaceable>oacs-5-0</replaceable> openacs-core</action></screen>
        <para>Repeat with the dotlrn cvs tree.</para>
        <screen><action>cd /var/tmp
mkdir dotlrn-packages
cd dotlrn-packages
cvs -d /dotlrn-cvsroot checkout -r <replaceable>dotlrn-2-0</replaceable> dotlrn-all
</action></screen>
      </listitem>
      <listitem>
        <para>Tag the tree.</para>
        <screen><action>cd /var/tmp/openacs-4
cvs tag -F <replaceable>openacs-5-0-0a1</replaceable>
</action></screen>
        <para>Note that we use the <action>-F</action> flag which will force the tag to the new version (just in 
          case someone has created the tag already on another version).  Excercise care when doing this since 
          you don't want to inadvertently move a prior release tag.  Also if the tagging goes horribly wrong 
          for some reason you can delete the tag via "<command>cvs tag -d &lt;symbolic_tag&gt;</command>".</para>
          <para>If this is a final version, then in addition to the openacs-x-y-z-final tag, apply the compat tag.  Note that the compat tag includes to major-minor only, while the full tag includes to major-minor-dot.</para>
        <screen><action>cvs tag -F <replaceable>openacs-5-0-compat</replaceable></action></screen>

        <para>Tag dotLRN.  Since the dotLRN packages aren't all in one
          module, we iterate through all of the modules.  Log in first
          (cvs login) so that you don't have to log in for each
          module.</para>

        <screen><action>cd /var/tmp/dotlrn-packages
for dir in *; do ( cd $dir &amp;&amp; cvs tag -F <replaceable>dotlrn-2-0-0a1</replaceable> ); done
</action></screen>
      </listitem>
      <listitem>
        <para>Make the tarball</para>
        <itemizedlist>
          <listitem>
            <formalpara>
              <title>openacs-core</title>
              <para></para>
            </formalpara>
            <orderedlist>
              <listitem>
                <para>Go to a new working space and export the tagged files.</para>
            <screen><action>mkdir /var/tmp/tarball
cd /var/tmp/tarball
cvs -d /cvsroot export -r <replaceable>openacs-5-0-0a1</replaceable> acs-core
</action></screen>
              </listitem>
              <listitem>
                <para>Generate the tarball.</para>
            <screen><action>cd /var/tmp/tarball
mv openacs-4 openacs-<replaceable>5.0.0a1</replaceable>
tar cz -f <replaceable>openacs-5.0.0a1.tar.gz</replaceable> openacs-<replaceable>5.0.0a1</replaceable>
</action></screen>
              </listitem>
            </orderedlist>
          </listitem>
          <listitem>
            <formalpara>
              <title>dotlrn</title>
              <para></para>
            </formalpara>
            <orderedlist>
              <listitem>
                <para>Go to a new working space and export the tagged
                files. (was getting errors here trying to use -d, so
                gave up and just moved things from openacs-4 to
                openacs at the end)</para>
            <screen><action>mkdir /var/tmp/dotlrn-tarball
cd /var/tmp/dotlrn-tarball
cvs -d /cvsroot export -r <replaceable>openacs-5-0-0a1</replaceable> acs-core
cd /var/tmp/dotlrn-tarball/openacs-4/packages
cvs -d /cvsroot export -r <replaceable>openacs-5-0-0a1</replaceable> dotlrn-prereq
cvs -d /dotlrn-cvsroot export -r <replaceable>dotlrn-2-0-0a1</replaceable> dotlrn-core
</action></screen>
              </listitem>
              <listitem>
                <para>Copy the dotlrn install.xml file, which controls
                which packages are installed on setup, to the root
                location:</para>
                <screen><action>cp /var/tmp/dotlrn-tarball/openacs-4/packages/dotlrn/install.xml \
   /var/tmp/dotlrn-tarball/openacs-4
</action></screen>
              </listitem>


              <listitem>
                <para>Generate the tarball</para>
            <screen><action>cd /var/tmp/dotlrn-tarball
mv openacs-4 dotlrn-<replaceable>2.0.0a1</replaceable>
tar cz -f <replaceable>dotlrn-2.0.0a1.tar.gz</replaceable> dotlrn-<replaceable>2.0.0a1</replaceable>
</action></screen>
              </listitem>
            </orderedlist>
          </listitem>
        </itemizedlist>
      </listitem>
      <listitem>
        <para>Test the new tarball</para>
      </listitem>
      <listitem>
        <para>Update openacs.org frontpage, bug-tracker versions, project page, etc.</para>
      </listitem>
      <listitem>
        <para>Clean up after yourself.</para>
        <screen><action>cd /var/tmp
rm -rf tarball dotlrn-tarball dotlrn-packages openacs-<replaceable>5.0.0a1</replaceable></action></screen>
      </listitem>
    </orderedlist>
    <para>
      Here is a shell script that automates this whole process...
    </para>

    <programlisting><xi:include href="../../../../etc/install/build-release.sh" xi:parse="text" xmlns:xi="http://www.w3.org/2001/XInclude"><xi:fallback>release script missing</xi:fallback></xi:include></programlisting>

    <para><phrase role="cvstag">($Id$)</phrase></para>
  </appendix>
