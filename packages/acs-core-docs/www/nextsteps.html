<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta content="text/html; charset=ISO-8859-1" http-equiv="Content-Type">
<title>Next Steps</title>
<meta name="generator" content="DocBook XSL Stylesheets V1.45">
<link rel="home" href="index.html" title="OpenACS Documentation">
<link rel="up" href="unix-install.html" title="Chapter 2. Installing on Unix/Linux">
<link rel="previous" href="openacs.html" title="Install OpenACS 4">
<link rel="next" href="credits.html" title="Credits">
<link rel="stylesheet" href="openacs.css" type="text/css">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="navheader">
<a href="http://openacs.org"><img src="images/alex.jpg" border="0"></a><table width="100%" summary="Navigation header" border="0"><tr>
<td width="20%" align="left">
<a accesskey="p" href="openacs.html">Prev</a> </td>
<th width="60%" align="center">Chapter 2. Installing on Unix/Linux</th>
<td width="20%" align="right"> <a accesskey="n" href="credits.html">Next</a>
</td>
</tr></table>
<hr>
</div>
<div class="sect1">
<div class="titlepage"><div><h2 class="title" style="clear: both">
<a name="nextsteps"></a>Next Steps</h2></div></div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="install-next-backups"></a>Backup Strategy</h3></div></div>
<p>Here are some tips from Don Baccus regarding backup strategy:</p>
<p>
	  The need for making backups should be self-explanatory. There are
	  several strategies you can use. My own strategy for minimizing the
	  odds that I'll lose all my data is quite simple:
	</p>
<div class="itemizedlist"><ul>
<li><p>
		  The database is stored on a mirrored (RAID 1) disk.
		</p></li>
<li><p>
		  The machine has battery backup.
		</p></li>
<li><p>
		  Backups are made nightly onto a third disk on another controller
		</p></li>
<li><p>
		  FTP is used to copy the resulting backup to two separate remote
		  servers in two locations
		</p></li>
</ul></div>
<p>
	  Rather than making remote copies, you might choose to dump to tape or
	  writeable CD media. Whatever strategy you use, it is important to
	  routinely check dumps to make sure they can be reloaded. The strategy
	  outlined above means that in the case of catastrophic failure, I'll
	  lose at most one day's data.

	  By mirroring disks and using a battery backup, preferably one that
	  can trigger an automatic and controlled shutdown of the system when
	  the battery runs low, you greatly lower the odds of ever having to
	  use your nightly backup. Despite this, it is important to take
	  backups seriously if the data stored at your site is valuable to you
	  or your users.
	</p>
</div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="install-export-oracle"></a>Set Up Nightly Oracle Exports</h3></div></div>
<p>
	  While you're working with Oracle, you should configure it to do
	  automatic exports. An export is a separate backup copy of the
	  database.  This copy includes all of the database's state at the
	  time that the export was initiated. If your database is corrupted,
	  you can restore from one of these backups. You should do this step as
	  <tt>root</tt>.
	</p>
<div class="itemizedlist"><ul>
<li><p> 
		  Download the backup script. Save the file <a href="files/export-oracle.txt" target="_top">export-oracle.txt</a> as
		  <tt>/tmp/export-oracle.txt</tt>
		</p></li>
<li>
<p>
		  Login as root. The following commands will install the export script:
		</p>
<pre class="programlisting">
nsadmin:~$ su -
Password: ***********
root:~# cp /tmp/export-oracle.txt /usr/sbin/export-oracle
root:~# chmod 700 /usr/sbin/export-oracle</pre>
</li>
<li>
<p>
        Setup the export directory; this is the directory where backups will
        be stored. We recommend the directory
        <tt>/ora8/m02/oracle-exports</tt>. </p>
<pre class="programlisting">
root:~# mkdir /ora8/m02/oracle-exports
root:~# chown oracle.dba /ora8/m02/oracle-exports
root:~# chmod 770 /ora8/m02/oracle-exports</pre>
</li>
<li>
<p> 
		  Now edit
		  <tt>/usr/sbin/export-oracle</tt> and
		  change the <tt>SERVICE_NAME</tt> and
		  <tt>DATABASE_PASSWORD</tt> fields to
		  their correct values. If you want to use a directory other than
		  <tt>/ora8/m02/oracle-exports</tt>, you
		  also need to change the
		  <tt>exportdir</tt> setting.
		</p>
<p>
		  Test the export procedure by running the command:
		</p>
<pre class="programlisting">
root:~# /usr/sbin/export-oracle
mv: /ora8/m02/oracle-exports/oraexport-service_name.dmp.gz: No such file or directory

Export: Release 8.1.6.1.0 - Production on Sun Jun 11 18:07:45 2000

(c) Copyright 1999 Oracle Corporation.  All rights reserved.


Connected to: Oracle8i Enterprise Edition Release 8.1.6.1.0 - Production
With the Partitioning option
JServer Release 8.1.6.0.0 - Production
Export done in US7ASCII character set and US7ASCII NCHAR character set
. exporting pre-schema procedural objects and actions
. exporting foreign function library names for user SERVICE_NAME 
. exporting object type definitions for user SERVICE_NAME 
About to export SERVICE_NAME's objects ...
. exporting database links
. exporting sequence numbers
. exporting cluster definitions
. about to export SERVICE_NAME's tables via Conventional Path ...
. exporting synonyms
. exporting views
. exporting stored procedures
. exporting operators
. exporting referential integrity constraints
. exporting triggers
. exporting indextypes
. exporting bitmap, functional and extensible indexes
. exporting posttables actions
. exporting snapshots
. exporting snapshot logs
. exporting job queues
. exporting refresh groups and children
. exporting dimensions
. exporting post-schema procedural objects and actions
. exporting statistics
Export terminated successfully without warnings.</pre>
<p>If you don't have any warnings, proceed to automate the
		  backups.</p>
</li>
<li>
<p>
		  Automating backups is accomplished using the UNIX
		  <tt>crontab</tt> facility.</p>
<p>
		  While still <tt>root</tt>, run the
		  following command. You can replace the
		  <tt>EDITOR=&quot;emacs -nw&quot;</tt>
		  portion with whatever editor your prefer, such as
		  <tt>EDITOR=vi</tt>.
		</p>
<pre class="programlisting">
root:~# export EDITOR=&quot;emacs -nw&quot;
root:~# crontab -e</pre>
<p>Now add the following line on a line by itself </p>
<pre class="programlisting">
0 23 * * * /usr/sbin/export-oracle</pre>
<p>
		  Save the file, exit the editor. Verify that the addition
		  succeeded by checking the output of the following command.</p>
<pre class="programlisting">
root:~# crontab -l | grep export-oracle
0 23 * * * /usr/sbin/export-oracle
root:~# exit
; Logout</pre>
<p>If you see the line, go ahead and log out.</p>
</li>
</ul></div>
</div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="install-export-postgres"></a>Set up nightly Postgres exports</h3></div></div>
<p>
	  Dowload <a href="files/acs-pgbackup-init.txt" target="_top">this script</a>
	  to <tt>/tmp</tt>. At the top of the script
	  are several variables that you'll need to customize:
	</p>
<div class="itemizedlist"><ul>
<li><p>
		  <tt>bak</tt> - location where you want
		  local backups to be saved
		</p></li>
<li><p>
		  <tt>servername</tt> - name of your server
		  (and database instance)
		</p></li>
<li><p>
		  <tt>ftp_user</tt> - username on your ftp
		  account 
		</p></li>
<li><p>
		  <tt>ftp_password</tt> - password on your
		  ftp account
		</p></li>
<li><p>
		  <tt>ftp_dir</tt> - path on the remote
		  server where your backups will be uploaded
		</p></li>
<li><p>
		  <tt>ftp_server</tt> - your ftp server
		</p></li>
</ul></div>
<p>

	  Next, we'll save this file to our server's
	  <tt>tcl</tt> directory so that it will be
	  loaded on startup. It will automatically be run every night at
	  midnight. Note that this script only backs up the database - not the
	  OpenACS scripts and file content.
	</p>
<pre class="programlisting">
nsadmin:~$ cp /tmp/acs-pgbackup-init.txt /web/birdnotes/tcl/acs-pgbackup-init.tcl
nsadmin:~$ restart-aolserver birdnotes</pre>
<p>
	  That's it! The script will email you with each successful backup (or
	  if it fails, it will send you an email with the reason)
	</p>
</div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="install-next-nightly-vacuum"></a>Vacuum Postgres nightly</h3></div></div>
<p>
	  The &quot;vacuum&quot; command must be run periodically to reclaim space. The
	  &quot;vacuum analyze&quot; form additionally collects statistics on the
	  disbursion of columns in the database, which the optimizer uses when
	  it calculates just how to execute queries. The availability of this
	  data can make a tremendous difference in the execution speed of
	  queries. This command can also be run from cron, but it probably makes
	  more sense to run this command as part of your nightly backup
	  procedure - if &quot;vacuum&quot; is going to screw up the database, you'd
	  prefer it to happen immediately after (not before!) you've made a
	  backup! The &quot;vacuum&quot; command is very reliable, but conservatism is
	  the key to good system management. So, if you're using the export
	  procedure described above, you don't need to do this extra step.
	</p>
<p>Edit your crontab:</p>
<pre class="programlisting">
nsadmin:~$ crontab -e</pre>
<p>We'll set vacuum up to run nightly at 1 AM. Add the following
	line:</p>
<pre class="programlisting">
0 1 * * * /usr/local/pgsql/bin/vacuumdb birdnotes</pre>
</div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="install-next-add-server"></a>How to add a second server on a different port</h3></div></div>
<p>Starting another server is simply a matter of configuring another
	aolserver instance, creating another database and pointing this
	aolserver instance at a fresh copy of the OpenACS-4 code. We'll call
	our new server <span class="emphasis"><i>birdnotes-dev</i></span>
</p>
<div class="orderedlist"><ol type="1">
<li>
<p>
		  Download another copy of <a href="files/openacs4.tcl.txt" target="_top"><tt>openacs4.tcl.txt</tt></a>
		  into <tt>/tmp</tt>.  </p>
<pre class="programlisting">
nsadmin:~$ cp /tmp/openacs4.tcl.txt ./<span class="emphasis"><i>birdnotes-dev</i></span>.tcl
nsadmin:~$ chmod 660 <span class="emphasis"><i>birdnotes-dev</i></span>.tcl
nsadmin:~$ emacs <span class="emphasis"><i>birdnotes-dev</i></span>.tcl</pre>
<p>Just like in <a href="openacs.html#install-openacs-configure-aol" title="Configuring AOLserver">the section called &#8220;Configuring AOLserver&#8221;</a>,
		you'll need to set the server parameters appropriately. Be sure to
		choose a different port than your original server and to set
		<tt>server</tt> to
		<span class="emphasis"><i>birdnotes-dev</i></span>.</p>
</li>
<li><p>

		  Create a new database instance called
		  <span class="emphasis"><i>birdnotes-dev</i></span>. Follow the instructions in
		  <a href="openacs.html#install-openacs-prepare-oracle">Prepare Oracle for OpenACS</a> or <a href="openacs.html#install-openacs-prepare-postgres">Prepare PostgreSQL for OpenACS</a>.

		</p></li>
<li>
<p>

		  You can either copy your current OpenACS installation:
		</p>
<pre class="programlisting">
nsadmin:~$ cd /web
nsadmin:~$ cp -r birdnotes birdnotes-dev</pre>
<p>
		  Or Download the <a href="http://www.openacs.org/software" target="_top">OpenACS
		  4 software</a> into <tt>/tmp</tt> again.
		</p>
<pre class="programlisting">
nsadmin:~$ cd /web
nsadmin:/web$ tar xzvf /tmp/alpha2.tgz
nsadmin:/web$ mv openacs-4 birdnotes-dev</pre>
</li>
<li>
<p>
		  Start your new server!
		</p>
<pre class="programlisting">
nsadmin:/web$ cd
nsadmin:~$ /usr/local/aolserver/bin/nsd-postgres -t /usr/local/aolserver/<span class="emphasis"><i>birdnotes-dev</i></span>.tcl</pre>
<p>
		  Visit the site with a web browser (using the port that you set
		  above). You should see the OpenACS installer. Once you install
		  the OpenACS datamodel, you'll also need to add your new aolserver
		  instance to <tt>/etc/inittab</tt> (or
		  daemontools) so it restarts automatically.</p>
</li>
</ol></div>
</div>
<div class="sect2">
<div class="titlepage"><div><h3 class="title">
<a name="install-next-openfts"></a>Set up site-wide search</h3></div></div>
<p>
	  OpenACS uses the <a href="http://openfts.sourceforge.net/" target="_top">OpenFTS</a> package to
	  implement site-wide-search. You'll need to have the Tcl development
	  libraries and headers installed. (Debian users:
	  <tt>apt-get install tcl8.3-dev</tt>)
	</p>
<div class="orderedlist"><ol type="1">
<li>
<p>
		  As <tt>root</tt>, download the
		  Search-OpenFTS driver.
		</p>
<pre class="programlisting">
nsadmin:~$ su -
Password: **********
root:~# cd /tmp
root:/tmp# wget http://prdownloads.sourceforge.net/openfts/Search-OpenFTS-tcl-0.2.tar.gz
root:~# cd /usr/local/src
root:/usr/local/src# tar xzf /tmp/Search-OpenFTS-tcl-0.2.tar.gz
root:/usr/local/src# chown -R nsadmin.web Search-OpenFTS-tcl-0.2
root:/usr/local/src# exit</pre>
</li>
<li>
<p>
		  Configure it. Note that you may need to set
		  <tt>--with-tcl=</tt>(your Tcl library
		  location). For Debian, add this to the end of the
		  <tt>./configure</tt> command:
		  <tt>--with-tcl=/usr/lib/tcl8.3</tt>
		</p>
<pre class="programlisting">
nsadmin:~$ cd /usr/local/src/Search-OpenFTS-tcl-0.2
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2$ ./configure --with-aolserver-src=/usr/local/src/aolserver/aolserver</pre>
</li>
<li>
<p>
		  In order to compile on Debian, I had to edit my
		  <tt>Makefile.global</tt>. Add
		  <tt>-I/usr/include/tcl8.3</tt> to the
		  line where INC is defined, so it looks like this:
		</p>
<pre class="programlisting">
INC          = ../include -I/usr/include/tcl8.3</pre>
<p>Then compile it:</p>
<pre class="programlisting">
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2$ make
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2$ cd aolserver
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2/aolserver$ make</pre>
</li>
<li>
<p>
		  Install it. You need to do this step as root since some of the
		  libraries will be installed alongside your TCL libraries and some
		  alongside your PostgreSQL libraries.
		</p>
<pre class="programlisting">
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2/aolserver$ su -
Password: ***********
root:~# cd /usr/local/src/Search-OpenFTS-tcl-0.2
root:/usr/local/src/Search-OpenFTS-tcl-0.2# make install
root:/usr/local/src/Search-OpenFTS-tcl-0.2# exit
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2/aolserver$ cp nsfts.so /usr/local/aolserver/bin/</pre>
</li>
<li>
<p>
		  Add the following line to your aolserver config file (in our
		  example:
		  <tt>/usr/local/aolserver/birdnotes.tcl</tt>)
		  in the &quot;ns_section ns/server/${server}/modules&quot; section:
		</p>
<pre class="programlisting">
        ns_param   nsfts           ${bindir}/nsfts.so</pre>
</li>
<li>
<p>
		  Load the openFTS code into your database:
		</p>
<pre class="programlisting">
nsadmin:/usr/local/src/Search-OpenFTS-tcl-0.2/aolserver$ cd
nsadmin:~$ psql -f /web/<span class="emphasis"><i>birdnotes</i></span>/packages/openfts-driver/sql/postgresql/load.sql <span class="emphasis"><i>birdnotes</i></span>
nsadmin:~$ restart-aolserver <span class="emphasis"><i>birdnotes</i></span></pre>
</li>
<li><p>
		  Open a browser and go to your server
		  (http://yourserver:port). Click on the &quot;Package Manager&quot; link in
		  the &quot;Quick Links&quot; section on the right side of the page.
		</p></li>
<li><p>
		  Click on the &quot;Install packages&quot; link and follow the instructions
		  to install the Note package and the OpenFTS Driver 4.2 package.
		</p></li>
<li><p>
		  Restart your server.

		  <pre class="programlisting">
nsadmin:~$ restart-aolserver <span class="emphasis"><i>birdnotes</i></span></pre>
		</p></li>
<li><p> 
		  Give the server a few minutes to restart and then go back to your
		  server's front page and click on &quot;Site Map&quot; from the &quot;Quick
		  Links&quot; 
		</p></li>
<li><p> 		  
		  Create a &quot;new sub folder&quot; under &quot;Main Site&quot;. Call the url
		  &quot;openfts&quot;.  
		</p></li>
<li><p> Click &quot;mount&quot; to mount the OpenFTS driver at the url
		  &quot;openfts&quot; (despite what the system says about these packages not
		  being meant to be mounted)
		</p></li>
<li><p>
		  Create another folder under &quot;Main Site&quot; at the url
		  &quot;search&quot;. Create a &quot;new application&quot;. Call the application
		  &quot;Search&quot; and choose the &quot;Search&quot; package from the drop-down list.
		  </p></li>
<li><p>
		  Create a third folder under &quot;Main Site&quot; at the url
		  &quot;notes&quot;. Create a &quot;new application&quot;. Call the application &quot;Notes&quot;
		  and choose the &quot;Note&quot; package from the drop-down list.
		  </p></li>
<li><p>
		  Restart the server.
		</p></li>
<li><p> 
		  Return to your home page. Near the bottom of the page, Click on
		  the &quot;OpenFTS Driver&quot; link. Then click on
		  &quot;Administration&quot;. Finally, click on &quot;Initialize OpenFTS
		  Engine&quot;. Accept the defaults and continue.
		</p></li>
<li><p> 
		  Click on the &quot;Main Site&quot; link to get back to the home page. Now,
		  click on the &quot;ACS Service Contract&quot; link near the bottom of the
		  home page.  
		</p></li>
<li><p>
		  Click on the link to &quot;install&quot; the FtsEngineDriver. Also, click
		  the link to install the Note content provider.
		</p></li>
<li><p>
		  Restart the server. You can try inserting some notes and then
		  going to the search page to search for stuff. Note that the
		  content may not get indexed immediately, so give it a few
		  minutes.
		</p></li>
</ol></div>
</div>
<p><div class="cvstag">($Id$)</div></p>
</div>
<div class="navfooter">
<hr>
<table width="100%" summary="Navigation footer">
<tr>
<td width="40%" align="left">
<a accesskey="p" href="openacs.html">Prev</a> </td>
<td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td>
<td width="40%" align="right"> <a accesskey="n" href="credits.html">Next</a>
</td>
</tr>
<tr>
<td width="40%" align="left">Install OpenACS 4 </td>
<td width="20%" align="center"><a accesskey="u" href="unix-install.html">Up</a></td>
<td width="40%" align="right"> Credits</td>
</tr>
</table>
<hr>
<address><a href="mailto:rmello@cc.usu.edu">
			rmello@cc.usu.edu
		  </a></address>
<address><a href="mailto:vinod@kurup.com">
			vinod@kurup.com
		  </a></address>
</div>
</body>
</html>
